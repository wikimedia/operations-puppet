#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### puppet:///files/apache/sites/integration.mediawiki.org
#####################################################################
# vim: filetype=apache

NameVirtualHost *:443
<VirtualHost *:80>
	ServerName integration.mediawiki.org
	ServerAdmin noc@wikimedia.org

	DocumentRoot /srv/org/mediawiki/integration

	ErrorLog /var/log/apache2/error.log

	# Possible values include: debug, info, notice, warn, error, crit,
	# alert, emerg.
	LogLevel warn

	CustomLog /var/log/apache2/access.log combined

	<Directory />
		Order Deny,Allow
		AllowOverride All
	</Directory>

	<Directory /srv/org/mediawiki/integration>
		Options FollowSymLinks
		AllowOverride All
		Order allow,deny
		allow from all
	</Directory>

	<Directory /srv/org/mediawiki/integration/*Mobile/nightly/>
		Options +Indexes
		IndexOptions FancyIndexing
		IndexOptions SuppressIcon
		IndexOptions SuppressRules
		IndexOptions SuppressDescription
		IndexOptions SuppressHTMLPreamble
		IndexOptions HTMLTable
		IndexOptions VersionSort
		IndexOptions NameWidth=*

		ServerSignature Off

		IndexStyleSheet "../../nightly.css"
		HeaderName "HEADER.html"
		ReadmeName "README.html"
		IndexIgnore "*.html" ".."
	</Directory>

	# Publish MediaWiki clones to the outside world for testswarm
	<Directory /var/lib/testswarm/mediawiki-git/clone>
		AllowOverride All
		order allow,deny
		allow from all

		<IfModule mod_php5.c>
			AddType application/x-httpd-php .php
			php_value include_path .

			DirectoryIndex index.html index.php
		</IfModule>

	</Directory>

	Alias /clone/mw/master /var/lib/testswarm/mediawiki-git/clone

	<Directory /usr/share/testswarm/site>
		AllowOverride All
		order allow,deny
		allow from all
		Options +FollowSymLinks

		AddType application/x-httpd-php .php
		php_value include_path .

		DirectoryIndex index.html index.php
	</Directory>

	Alias /testswarm "/usr/share/testswarm/site/"

	# Force Jenkins request through HTTPS
	RewriteEngine on
	RewriteCond %{HTTPS} off
	RewriteCond %{REQUEST_URI}  ^/ci
	RewriteRule ^/ci/ https://%{HTTP_HOST}%{REQUEST_URI}

</VirtualHost>
<VirtualHost *:443>
	ServerName integration.mediawiki.org
	ServerAdmin noc@wikimedia.org

	DocumentRoot /srv/org/mediawiki/integration

	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/star.mediawiki.org.pem
	SSLCertificateKeyFile /etc/ssl/private/star.mediawiki.org.key
	SSLCACertificateFile /etc/ssl/certs/RapidSSL_CA.pem

	ErrorLog /var/log/apache2/error.log

	# Possible values include: debug, info, notice, warn, error, crit,
	# alert, emerg.
	LogLevel warn

	CustomLog /var/log/apache2/access.log combined

	<Directory />
		Order Deny,Allow
		AllowOverride All
	</Directory>

	<Directory /srv/org/mediawiki/integration>
		Options FollowSymLinks
		AllowOverride All
		Order allow,deny
		allow from all
	</Directory>

	<Directory /srv/org/mediawiki/integration/*Mobile/nightly/>
		Options +Indexes
		IndexOptions FancyIndexing
		IndexOptions SuppressIcon
		IndexOptions SuppressRules
		IndexOptions SuppressDescription
		IndexOptions SuppressHTMLPreamble
		IndexOptions HTMLTable
		IndexOptions VersionSort
		IndexOptions NameWidth=*

		ServerSignature Off

		HeaderName "HEADER.html"
		ReadmeName "README.html"
		IndexIgnore "*.html" ".."
	</Directory>

	# Publish MediaWiki clones to the outside world for testswarm
	<Directory /var/lib/testswarm/mediawiki-git/clone>
		AllowOverride All
		order allow,deny
		allow from all

		<IfModule mod_php5.c>
			AddType application/x-httpd-php .php
			php_value include_path .

			DirectoryIndex index.html index.php
		</IfModule>

	</Directory>

	Alias /clone/mw/master /var/lib/testswarm/mediawiki-git/clone

	<Directory /usr/share/testswarm/site>
		AllowOverride All
		order allow,deny
		allow from all
		Options +FollowSymLinks

		AddType application/x-httpd-php .php
		php_value include_path .

		DirectoryIndex index.html index.php
	</Directory>

	Alias /testswarm "/usr/share/testswarm/site/"
</VirtualHost>
