filter {
  if [type] == "syslog" {
    # General syslog message cleanup
    mutate {
      replace => [ "type",  "%{program}" ]
      add_field => { "level" => "%{severity_label}" }
      gsub => [ "message", "#012", "\n" ]
      add_tag => [ "syslog", "es" ]
    }

    # Strip "message repeated" preamble
    if [message] =~ /^message repeated \d+ times:/ {
      grok {
        match => [
          "message",
          "^message repeated %{NUMBER:repeated} times: \[%{GREEDYDATA:message}\]$"
        ]
        overwrite => [ "message" ]
        named_captures_only => true
      }
    }

    # Discard last message repeated messages
    if [message] =~ "last message repeated \d+ times$" {
      drop {}
    }

    # Strip leading newline from hhvm messages
    if [type] == "hhvm" {
      mutate {
        gsub => [ "message", "^\n", "" ]
      }
    }

    # Mark kernel messages forwared because of hhvm as hhvm messages
    if [type] == "kernel" and [message] =~ /hhvm/ {
      mutate {
        replace => [ "type",  "hhvm" ]
      }
    }
  }
}
