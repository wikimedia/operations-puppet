#!/bin/sh

PATH=/usr/bin:/bin
export PATH

if [ "$USER" = "gitpuppet" ]; then
    # Add an apache reload, since puppet is stupid and will botch
    # catalogues in a way that does not show up on the clients and causes
    # an insane amount of confusion. A reload makes it regenerate them properly.
    #/etc/init.d/apache2 reload

    # This bug has allegedly been fixed, so let's try with touch site.pp again
    touch /etc/puppet/manifests/site.pp

    if [ `hostname` = 'sockpuppet' ]; then
        # If no key is forwarded then this will use the ready-made equivalent command
        #  on stafford and ignore our command.
        ssh -t -t stafford.pmtpa.wmnet 'cd /var/lib/git/operations/puppet && git pull && git submodule update --init'
    fi
fi
