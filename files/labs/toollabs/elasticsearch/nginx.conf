upstream elasticsearch {
  server 127.0.0.1:9200;
}

server {
  listen 80;

  # Use named location error code handlers to control access
  set $anon 600;
  set $passwd 601;
  error_page $anon = @anon_elasticsearch;
  error_page $passwd = @protected_elasticsearch;

  # Named location for anon access
  location @anon_elasticsearch {
    proxy_pass http://elasticsearch;
    proxy_redirect off;
  }

  # Named location for authed access
  set $realm "Elasticsearch protected actions";
  set $htpasswd /etc/nginx/elasticsearch.htpasswd;
  location @protected_elasticsearch {
    auth_basic $realm;
    auth_basic_user_file $htpasswd;
    proxy_pass http://elasticsearch;
    proxy_redirect off;
  }

  location / {
    # Require auth for POST, PUT, DELETE, ... requests
    limit_except GET HEAD {
      auth_basic $realm;
      auth_basic_user_file $htpasswd;
    }

    # Searches
    location ^~ .*/(_search|_analyze)$ {
      return $anon;
    }

    # Meta-data requests
    location ^~ (/_nodes|.*/(_aliases|_mapping))$ {
      return $anon;
    }

    # Everything not otherwise whitelisted requires auth
    location ~* .+ {
      return $passwd;
    }

    # Server status
    return $anon;
  }
}
# vim:ft=nginx:sw=2:ts=2:sts=2:et:
