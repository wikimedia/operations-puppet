<VirtualHost *:80>
    ServerName gdash.wikimedia.org
    DocumentRoot /var/www/gdash.wikimedia.org

    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteCond %{REQUEST_URI} !^/status$
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
    Header always merge Vary X-Forwarded-Proto env=ProtoRedirect
    Header always set Strict-Transport-Security "max-age=604800"

    # Reqstats have been decommissioned, see T118979
    ReqriteRule ^/dashboards/reqerror.*$ https://grafana.wikimedia.org/dashboard/db/varnish-http-errors [R=301,L]
    ReqriteRule ^/dashboards/reqsum.*$ https://grafana.wikimedia.org/dashboard/db/varnish-http-requests [R=301,L]
    ReqriteRule ^/dashboards/reqmobile.*$ https://grafana.wikimedia.org/dashboard/db/varnish-http-requests [R=301,L]
    ReqriteRule ^/dashboards/reqwiki.*$ https://grafana.wikimedia.org/dashboard/db/varnish-http-requests [R=301,L]

    ExpiresActive On
    ExpiresDefault "access plus 1 year"

    AddOutputFilterByType DEFLATE application/javascript text/css text/html

    <Directory />
	Options -Indexes
	AllowOverride None
	Require all granted
    </Directory>

    <Directory /var/www/gdash.wikimedia.org>
	Options -Indexes
	AllowOverride None
	Require all granted
    </Directory>
</VirtualHost>
