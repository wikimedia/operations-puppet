#!/bin/bash

PATH=/bin:/usr/local/bin:/usr/bin:/sbin:/usr/sbin:
TERM=dumb

. /usr/local/lib/mw-deployment-vars.sh

mwVersionNums=$(mwversionsinuse)
if [ -z "$mwVersionNums" ]; then
	echo "Unable to read wikiversions.dat or it is empty"
	exit 1
fi

for mwVerNum in ${mwVersionNums[@]}; do
	echo -n "MediaWiki $mwVerNum: Compiling texvc..."
	builddir=`mktemp -dt texvc-build.XXXXXXXXXX`
	if [ -z "$builddir" ]; then
		echo "Unable to create temporary directory"
		exit 1
	fi

	mwIP="$MW_COMMON"/"$mwVerNum"
	MATHPATH=$mwIP/extensions/Math/math

	rsync -r --exclude=.svn/ --exclude=.git/ $MATHPATH/ "$builddir"
	cd "$builddir"
	if make -f Makefile texvc >/dev/null 2>/dev/null; then
		echo "ok"
		install -d /srv/deployment/mediawiki/uncommon/"$mwVerNum"/bin
		install -m 755 "$builddir"/texvc /srv/deployment/mediawiki/uncommon/"$mwVerNum"/bin
	else
		echo "failed"
		exit 1
	fi
	rm -r "$builddir"
	cd /
done
