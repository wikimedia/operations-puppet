#!/bin/bash
## synchronizes a directory from common/ on all apaches

BINDIR=/usr/local/bin

[ $# -lt 1 ] && {
	echo >&2 "Usage: sync-dir directory [message]"
	exit 1
}

FILE=$1
shift

# Sanity check
if [ ! -d "/home/wikipedia/common/$FILE" ]; then
	echo >&2 "Target file is not a directory"
	exit 1
fi

# Perform syntax check
find /home/wikipedia/common/$FILE -type f -a \( \
		-iname '*.php' -o \
		-iname '*.inc' -o \
		-iname '*.phtml' \
		\) -a -print0 | xargs -0 -n 1 -P 2 php -l || {
	echo >&2 "Aborted due to syntax errors"
	exit 1
}

# Cleanup permissions on any new files
$BINDIR/set-group-write

# Actually sync the dir...
$BINDIR/sync-common-file $FILE "$@"
