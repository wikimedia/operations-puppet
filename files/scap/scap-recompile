#!/bin/bash

PATH=/bin:/usr/bin:/sbin:/usr/sbin:
TERM=dumb

# wikiversions.dat just synced above
mwVersionNums=$(mwversionsinuse)
if [ -z "$mwVersionNums" ]; then
	echo "Unable to read wikiversions.dat or it is empty"
	exit 1
fi

arr=($mwVersionNums)
mwVerNum=${arr[1]}

echo -n "MediaWiki: Compiling texvc..."
builddir=`mktemp -dt texvc-build.XXXXXXXXXX`
if [ -z "$builddir" ]; then
	echo "Unable to create temporary directory"
	exit 1
fi

mwIP=/usr/local/apache/common-local/php-"$mwVerNum"
MATHPATH=$mwIP/extensions/Math/math
rsync -r --exclude=.git/ $MATHPATH/ "$builddir"
cd "$builddir"
if make -f Makefile texvc >/dev/null 2>/dev/null; then
	echo "ok"
	install -d /usr/local/apache/uncommon/bin
	install -m 755 "$builddir"/texvc /usr/local/apache/uncommon/bin
else
	echo "failed"
	exit 1
fi

rm -r "$builddir"

echo -n "MediaWiki: Compiling texvcheck..."
builddir=`mktemp -dt texvccheck-build.XXXXXXXXXX`
cd "$builddir"

if [ -z "$builddir" ]; then
        echo "Unable to create temporary directory"
        exit 1
fi

MATHPATH=$mwIP/extensions/Math/texvccheck
rsync -r --exclude=.git/ $MATHPATH/ "$builddir"

if make -f Makefile texvccheck >/dev/null 2>/dev/null; then
	echo "ok"
	install -d /usr/local/apache/uncommon/bin
	install -m 755 "$builddir"/texvccheck /usr/local/apache/uncommon/bin
else
	echo "failed"
	exit 1
fi

rm -r "$builddir"
cd /
