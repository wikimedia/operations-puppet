#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
  you know, scap.

"""
import argparse
import contextlib
import fcntl
import imp
import os
import pipes
import random
import socket
import struct
import subprocess
import tempfile
import time



def shell_map(mapping):
    """Convert a map to a string of space-separated KEY=VALUE pairs."""
    return ' '.join('%s=%s' % (k, pipes.quote(v)) for k, v in mapping.items())

def get_config():
    """Load environment variables from mw-deployment-vars.sh."""
    dep_env = imp.load_source('__env', '/usr/local/lib/mw-deployment-vars.sh')
    return {k: v for k, v in dep_env.__dict__.items() if k.startswith('MW_')}


@contextlib.contextmanager
def lock(filename):
    """Context manager. Acquires a file lock on entry, releases on exit."""
    # FIXME: Actually use this.
    with open(filename) as lock_fd:
        fcntl.lockf(lock_fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
        yield
        fcntl.lockf(lock_fd, fcntl.LOCK_UN)


def irc_echo(message, address=('neon.wikimedia.org', 9200)):
    """Echo a message on #wikimedia-operations via logmsgbot."""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    return sock.sendto(message, address)


def cdb_items(buf):
    """Iterates over CDB key/value pairs."""
    table_start, = struct.unpack_from('<L', buf)
    offset = 2048
    while offset < table_start:
        lengths = struct.unpack_from('<LL', buf, offset)
        offset += 8
        yield struct.unpack_from('%ds %ds' % lengths, buf, offset)
        offset += sum(lengths)


def get_branches(wikiversions_cdb_path):
    """Get the set of active branches from a wikiversions.cdb file."""
    with open(wikiversions_cdb_path, 'rb') as cdb_file:
        cdb = cdb_file.read()
        return {v for k, v in cdb_items(cdb) if k.startswith('ver:')}


def dsh(command, group, exports=None):
    """Run a command on multiple hosts via DSH."""
    if exports:
        command = '%s %s' % (shell_map(exports), command)
    group_file = os.path.join('/etc/dsh/group', group)
    return subprocess.check_call(['dsh', '-F40', '-cM', '-f', group_file, '-o',
                                  '-oSetupTimeout=10', '--', command.strip()])


def check_syntax(*paths):
    """Run lint.php on `paths`; raise CalledProcessError if nonzero exit."""
    command = ['/usr/bin/php', '-n', '-dextension=parsekit.so',
               '/usr/local/bin/lint.php'] + list(paths)
    return subprocess.check_call(command)


def parse_args():
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(description='Deploy MediaWiki')
    parser.add_argument('--active', action='store_true', default=False,
                        help='only sync active branches')
    parser.add_argument('message', nargs=argparse.REMAINDER)
    return parser.parse_args()


if 'SSH_AUTH_SOCK' not in os.environ:
    raise RuntimeError('SSH_AUTH_SOCK is unset. Is your agent running?')

start = time.time()
config = get_config()
env = {}
args = parse_args()
if args.active:
    branches = get_branches('%(MW_COMMON)s/wikiversions.cdb' % config)
    env['MW_VERSIONS_SYNC'] = ' '.join(branches)


# Perform syntax check
print('Checking syntax of wmf-config and multiversion... ')
check_syntax('%(MW_COMMON_SOURCE)s/wmf-config' % config)
check_syntax('%(MW_COMMON_SOURCE)s/multiversion' % config)
print('done')

# Update the current machine so that serialization works.
# Push wikiversions.dat changes so mwversionsinuse, set-group-write,
# and mwscript work with the right version of the files.
subprocess.check_call('/usr/local/bin/sync-common')

# Update list of extension message files and regenerate
# the localisation cache
subprocess.check_call('/usr/local/bin/mw-update-l10n')

# Notify
irc_echo('!log %s started scap: %s' % (os.getlogin(), args.message))

print('Updating rsync proxies...')
dsh('/usr/local/bin/scap-1', 'scap-proxies', env)
print('Finished')

with open('/etc/dsh/group/scap-proxies') as f:
    rsync_servers = ' '.join(ln.strip() for ln in f if not ln.startswith('#'))

# Randomize the order of target machines
with open('/etc/dsh/group/mediawiki-installation', 'rt') as f:
    hosts = random.shuffle(ln for ln in f if not ln.startswith('#'))
    with tempfile.NamedTemporaryFile(prefix='scap') as tmp:
        tmp.write(''.join(hosts))
        print('Copying code to apaches...',)
        dsh('/usr/local/bin/scap-1 "%s"' % rsync_servers, tmp.name, env)
        print('Finished')

        print('Rebuilding CDB files from /upstream...',)
        dsh('/usr/local/bin/scap-rebuild-cdbs', tmp.name, env)
        print('Finished')


# Builds wikiversions.cdb and syncs it to the apaches with the dat file.
# This is done after all else so that deploying new MW versions is easier.
subprocess.check_call('sync-wikiversions')

stop = time.time()
duration = '%02dm %02ds' % divmod(stop - start, 60)
print('scap completed in %s' % duration)
irc_echo('!log %s finished scap: %s (duration: %s)'
         % (os.getlogin(), args.message, duration))
