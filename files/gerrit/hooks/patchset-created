#!/usr/bin/env python
import re
import sys
from hookhelper import HookHelper
from optparse import OptionParser

def main():
	parser = OptionParser(conflict_handler="resolve")
	parser.set_usage("patchset-created --change")
	parser.add_option("--change", dest="change")
	parser.add_option("--change-url", dest="changeurl")
	parser.add_option("--project", dest="project")
	parser.add_option("--branch", dest="branch")
	parser.add_option("--uploader", dest="uploader")
	parser.add_option("--commit", dest="commit")
	parser.add_option("--patchset", dest="patchset", type="int")
	(options, args) = parser.parse_args()
	if not options.change or not options.change.isalnum():
		parser.error("No change id, or changeid invalid")
	if hookconfig.debug:
		sys.stderr.write("Patchset passed in: " + str(options.patchset) + "\n")
	helper = HookHelper()
	subject = helper.get_subject(options.change)
	if subject:
		message = "New patchset: " + re.sub(' \(.*', "", options.uploader) + '; "' + subject + '" [' + options.project + "] (" + options.branch + ") - " + options.changeurl + "\n"
		helper.log_to_file(options.project, options.branch, message)
	
	helper.runProjectHook('patchsetCreated', options)

if __name__ == '__main__':
	main()
