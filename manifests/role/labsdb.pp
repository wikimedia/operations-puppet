#include "mysql.db"

class role::labs::db::master {

    system::role { 'role::labs::db::master':
        description => 'Labs user database master',
    }

    include standard
    include mariadb::packages_wmf
    include role::mariadb::grants
    include role::mariadb::monitor

    class { 'mariadb::config':
        prompt   => 'TOOLSDB',
        config   => 'mariadb/toolsmaster.my.cnf.erb',
        password => $passwords::misc::scripts::mysql_root_pass,
        datadir  => '/srv/labsdb/data',
        tmpdir   => '/tmp',
    }

}

class role::labs::db::client {
    # There are three replica servers (c1, c2, c3).  The mapping of
    # "shards" (s1, etc.) and databases (enwiki, etc.) to these is
    # arbitrary and can be adjusted to depool a server or redistribute
    # load.
    $c1_dbs = ['s1', 'enwiki']
    $c2_dbs = ['s2', 's4', 's5', 'bgwiki', 'bgwiktionary',
        'commonswiki', 'cswiki', 'dewiki', 'enwikiquote',
        'enwiktionary', 'eowiki', 'fiwiki', 'idwiki', 'itwiki',
        'nlwiki', 'nowiki', 'plwiki', 'ptwiki', 'svwiki', 'thwiki',
        'trwiki', 'wikidatawiki', 'zhwiki']
    $c3_dbs = ['s3', 's6', 's7', 'aawiki', 'aawikibooks',
        'aawiktionary', 'abwiki', 'abwiktionary', 'acewiki',
        'advisorywiki', 'afwiki', 'afwikibooks', 'afwikiquote',
        'afwiktionary', 'akwiki', 'akwikibooks', 'akwiktionary',
        'alswiki', 'alswikibooks', 'alswikiquote', 'alswiktionary',
        'amwiki', 'amwikiquote', 'amwiktionary', 'angwiki',
        'angwikibooks', 'angwikiquote', 'angwikisource',
        'angwiktionary', 'anwiki', 'anwiktionary', 'arcwiki',
        'arwiki', 'arwikibooks', 'arwikimedia', 'arwikinews',
        'arwikiquote', 'arwikisource', 'arwikiversity',
        'arwiktionary', 'arzwiki', 'astwiki', 'astwikibooks',
        'astwikiquote', 'astwiktionary', 'aswiki', 'aswikibooks',
        'aswikisource', 'aswiktionary', 'avwiki', 'avwiktionary',
        'aywiki', 'aywikibooks', 'aywiktionary', 'azwiki',
        'azwikibooks', 'azwikiquote', 'azwikisource', 'azwiktionary',
        'barwiki', 'bat_smgwiki', 'bawiki', 'bawikibooks', 'bclwiki',
        'bdwikimedia', 'be_x_oldwiki', 'betawikiversity', 'bewiki',
        'bewikibooks', 'bewikimedia', 'bewikiquote', 'bewikisource',
        'bewiktionary', 'bgwikibooks', 'bgwikinews', 'bgwikiquote',
        'bgwikisource', 'bhwiki', 'bhwiktionary', 'biwiki',
        'biwikibooks', 'biwiktionary', 'bjnwiki', 'bmwiki',
        'bmwikibooks', 'bmwikiquote', 'bmwiktionary', 'bnwiki',
        'bnwikibooks', 'bnwikisource', 'bnwiktionary', 'bowiki',
        'bowikibooks', 'bowiktionary', 'bpywiki', 'brwiki',
        'brwikimedia', 'brwikiquote', 'brwikisource', 'brwiktionary',
        'bswiki', 'bswikibooks', 'bswikinews', 'bswikiquote',
        'bswikisource', 'bswiktionary', 'bugwiki', 'bxrwiki',
        'cawiki', 'cawikibooks', 'cawikimedia', 'cawikinews',
        'cawikiquote', 'cawikisource', 'cawiktionary', 'cbk_zamwiki',
        'cdowiki', 'cebwiki', 'centralauth', 'cewiki', 'chowiki',
        'chrwiki', 'chrwiktionary', 'chwiki', 'chwikibooks',
        'chwiktionary', 'chywiki', 'ckbwiki', 'cowiki', 'cowikibooks',
        'cowikimedia', 'cowikiquote', 'cowiktionary', 'crhwiki',
        'crwiki', 'crwikiquote', 'crwiktionary', 'csbwiki',
        'csbwiktionary', 'cswikibooks', 'cswikinews', 'cswikiquote',
        'cswikisource', 'cswikiversity', 'cswiktionary', 'cuwiki',
        'cvwiki', 'cvwikibooks', 'cywiki', 'cywikibooks',
        'cywikiquote', 'cywikisource', 'cywiktionary', 'dawiki',
        'dawikibooks', 'dawikiquote', 'dawikisource', 'dawiktionary',
        'dewikibooks', 'dewikinews', 'dewikiquote', 'dewikisource',
        'dewikiversity', 'dewikivoyage', 'dewiktionary', 'diqwiki',
        'dkwikimedia', 'donatewiki', 'dsbwiki', 'dvwiki',
        'dvwiktionary', 'dzwiki', 'dzwiktionary', 'eewiki', 'elwiki',
        'elwikibooks', 'elwikinews', 'elwikiquote', 'elwikisource',
        'elwikiversity', 'elwikivoyage', 'elwiktionary', 'emlwiki',
        'enwikibooks', 'enwikinews', 'enwikisource', 'enwikiversity',
        'enwikivoyage', 'eowikibooks', 'eowikinews', 'eowikiquote',
        'eowikisource', 'eowiktionary', 'eswiki', 'eswikibooks',
        'eswikinews', 'eswikiquote', 'eswikisource', 'eswikiversity',
        'eswikivoyage', 'eswiktionary', 'etwiki', 'etwikibooks',
        'etwikimedia', 'etwikiquote', 'etwikisource', 'etwiktionary',
        'euwiki', 'euwikibooks', 'euwikiquote', 'euwiktionary',
        'extwiki', 'fawiki', 'fawikibooks', 'fawikinews',
        'fawikiquote', 'fawikisource', 'fawikivoyage', 'fawiktionary',
        'ffwiki', 'fiu_vrowiki', 'fiwikibooks', 'fiwikimedia',
        'fiwikinews', 'fiwikiquote', 'fiwikisource', 'fiwikiversity',
        'fiwiktionary', 'fjwiki', 'fjwiktionary', 'foundationwiki',
        'fowiki', 'fowikisource', 'fowiktionary', 'frpwiki',
        'frrwiki', 'frwiki', 'frwikibooks', 'frwikinews',
        'frwikiquote', 'frwikisource', 'frwikiversity',
        'frwikivoyage', 'frwiktionary', 'furwiki', 'fywiki',
        'fywikibooks', 'fywiktionary', 'gagwiki', 'ganwiki', 'gawiki',
        'gawikibooks', 'gawikiquote', 'gawiktionary', 'gdwiki',
        'gdwiktionary', 'glkwiki', 'glwiki', 'glwikibooks',
        'glwikiquote', 'glwikisource', 'glwiktionary', 'gnwiki',
        'gnwikibooks', 'gnwiktionary', 'gotwiki', 'gotwikibooks',
        'guwiki', 'guwikibooks', 'guwikiquote', 'guwikisource',
        'guwiktionary', 'gvwiki', 'gvwiktionary', 'hakwiki', 'hawiki',
        'hawiktionary', 'hawwiki', 'hewiki', 'hewikibooks',
        'hewikinews', 'hewikiquote', 'hewikisource', 'hewikivoyage',
        'hewiktionary', 'hifwiki', 'hiwiki', 'hiwikibooks',
        'hiwikiquote', 'hiwiktionary', 'howiki', 'hrwiki',
        'hrwikibooks', 'hrwikiquote', 'hrwikisource', 'hrwiktionary',
        'hsbwiki', 'hsbwiktionary', 'htwiki', 'htwikisource',
        'huwiki', 'huwikibooks', 'huwikinews', 'huwikiquote',
        'huwikisource', 'huwiktionary', 'hywiki', 'hywikibooks',
        'hywikiquote', 'hywikisource', 'hywiktionary', 'hzwiki',
        'iawiki', 'iawikibooks', 'iawiktionary', 'idwikibooks',
        'idwikiquote', 'idwikisource', 'idwiktionary', 'iewiki',
        'iewikibooks', 'iewiktionary', 'igwiki', 'iiwiki', 'ikwiki',
        'ikwiktionary', 'ilowiki', 'incubatorwiki', 'iowiki',
        'iowiktionary', 'iswiki', 'iswikibooks', 'iswikiquote',
        'iswikisource', 'iswiktionary', 'itwikibooks', 'itwikinews',
        'itwikiquote', 'itwikisource', 'itwikiversity',
        'itwikivoyage', 'itwiktionary', 'iuwiki', 'iuwiktionary',
        'jawiki', 'jawikibooks', 'jawikinews', 'jawikiquote',
        'jawikisource', 'jawikiversity', 'jawiktionary', 'jbowiki',
        'jbowiktionary', 'jvwiki', 'jvwiktionary', 'kaawiki',
        'kabwiki', 'kawiki', 'kawikibooks', 'kawikiquote',
        'kawiktionary', 'kbdwiki', 'kgwiki', 'kiwiki', 'kjwiki',
        'kkwiki', 'kkwikibooks', 'kkwikiquote', 'kkwiktionary',
        'klwiki', 'klwiktionary', 'kmwiki', 'kmwikibooks',
        'kmwiktionary', 'knwiki', 'knwikibooks', 'knwikiquote',
        'knwikisource', 'knwiktionary', 'koiwiki', 'kowiki',
        'kowikibooks', 'kowikinews', 'kowikiquote', 'kowikisource',
        'kowikiversity', 'kowiktionary', 'krcwiki', 'krwiki',
        'krwikiquote', 'kshwiki', 'kswiki', 'kswikibooks',
        'kswikiquote', 'kswiktionary', 'kuwiki', 'kuwikibooks',
        'kuwikiquote', 'kuwiktionary', 'kvwiki', 'kwwiki',
        'kwwikiquote', 'kwwiktionary', 'kywiki', 'kywikibooks',
        'kywikiquote', 'kywiktionary', 'ladwiki', 'lawiki',
        'lawikibooks', 'lawikiquote', 'lawikisource', 'lawiktionary',
        'lbewiki', 'lbwiki', 'lbwikibooks', 'lbwikiquote',
        'lbwiktionary', 'lezwiki', 'lgwiki', 'lijwiki', 'liwiki',
        'liwikibooks', 'liwikiquote', 'liwikisource', 'liwiktionary',
        'lmowiki', 'lnwiki', 'lnwikibooks', 'lnwiktionary',
        'loginwiki', 'lowiki', 'lowiktionary', 'ltgwiki', 'ltwiki',
        'ltwikibooks', 'ltwikiquote', 'ltwikisource', 'ltwiktionary',
        'lvwiki', 'lvwikibooks', 'lvwiktionary', 'maiwiki',
        'map_bmswiki', 'mdfwiki', 'mediawikiwiki', 'metawiki',
        'mgwiki', 'mgwikibooks', 'mgwiktionary', 'mhrwiki', 'mhwiki',
        'mhwiktionary', 'minwiki', 'miwiki', 'miwikibooks',
        'miwiktionary', 'mkwiki', 'mkwikibooks', 'mkwikimedia',
        'mkwikisource', 'mkwiktionary', 'mlwiki', 'mlwikibooks',
        'mlwikiquote', 'mlwikisource', 'mlwiktionary', 'mnwiki',
        'mnwikibooks', 'mnwiktionary', 'mowiki', 'mowiktionary',
        'mrjwiki', 'mrwiki', 'mrwikibooks', 'mrwikiquote',
        'mrwikisource', 'mrwiktionary', 'mswiki', 'mswikibooks',
        'mswiktionary', 'mtwiki', 'mtwiktionary', 'muswiki',
        'mwlwiki', 'mxwikimedia', 'myvwiki', 'mywiki', 'mywikibooks',
        'mywiktionary', 'mznwiki', 'nahwiki', 'nahwikibooks',
        'nahwiktionary', 'napwiki', 'nawiki', 'nawikibooks',
        'nawikiquote', 'nawiktionary', 'nds_nlwiki', 'ndswiki',
        'ndswikibooks', 'ndswikiquote', 'ndswiktionary', 'newiki',
        'newikibooks', 'newiktionary', 'newwiki', 'ngwiki',
        'nlwikibooks', 'nlwikimedia', 'nlwikinews', 'nlwikiquote',
        'nlwikisource', 'nlwikivoyage', 'nlwiktionary', 'nnwiki',
        'nnwikiquote', 'nnwiktionary', 'nostalgiawiki', 'novwiki',
        'nowikibooks', 'nowikimedia', 'nowikinews', 'nowikiquote',
        'nowikisource', 'nowiktionary', 'nrmwiki', 'nsowiki',
        'nvwiki', 'nycwikimedia', 'nywiki', 'nzwikimedia', 'ocwiki',
        'ocwikibooks', 'ocwiktionary', 'omwiki', 'omwiktionary',
        'orwiki', 'orwikisource', 'orwiktionary', 'oswiki',
        'outreachwiki', 'pa_uswikimedia', 'pagwiki', 'pamwiki',
        'papwiki', 'pawiki', 'pawikibooks', 'pawiktionary', 'pcdwiki',
        'pdcwiki', 'pflwiki', 'pihwiki', 'piwiki', 'piwiktionary',
        'plwikibooks', 'plwikimedia', 'plwikinews', 'plwikiquote',
        'plwikisource', 'plwikivoyage', 'plwiktionary', 'pmswiki',
        'pnbwiki', 'pnbwiktionary', 'pntwiki', 'pswiki',
        'pswikibooks', 'pswiktionary', 'ptwikibooks', 'ptwikinews',
        'ptwikiquote', 'ptwikisource', 'ptwikiversity',
        'ptwikivoyage', 'ptwiktionary', 'qualitywiki', 'quwiki',
        'quwikibooks', 'quwikiquote', 'quwiktionary', 'rmwiki',
        'rmwikibooks', 'rmwiktionary', 'rmywiki', 'rnwiki',
        'rnwiktionary', 'roa_rupwiki', 'roa_rupwiktionary',
        'roa_tarawiki', 'rowiki', 'rowikibooks', 'rowikinews',
        'rowikiquote', 'rowikisource', 'rowikivoyage', 'rowiktionary',
        'rswikimedia', 'ruewiki', 'ruwiki', 'ruwikibooks',
        'ruwikimedia', 'ruwikinews', 'ruwikiquote', 'ruwikisource',
        'ruwikiversity', 'ruwikivoyage', 'ruwiktionary', 'rwwiki',
        'rwwiktionary', 'sahwiki', 'sahwikisource', 'sawiki',
        'sawikibooks', 'sawikiquote', 'sawikisource', 'sawiktionary',
        'scnwiki', 'scnwiktionary', 'scowiki', 'scwiki',
        'scwiktionary', 'sdwiki', 'sdwikinews', 'sdwiktionary',
        'sewiki', 'sewikibooks', 'sewikimedia', 'sgwiki',
        'sgwiktionary', 'shwiki', 'shwiktionary', 'simplewiki',
        'simplewikibooks', 'simplewikiquote', 'simplewiktionary',
        'siwiki', 'siwikibooks', 'siwiktionary', 'skwiki',
        'skwikibooks', 'skwikiquote', 'skwikisource', 'skwiktionary',
        'slwiki', 'slwikibooks', 'slwikiquote', 'slwikisource',
        'slwikiversity', 'slwiktionary', 'smwiki', 'smwiktionary',
        'snwiki', 'snwiktionary', 'sourceswiki', 'sowiki',
        'sowiktionary', 'specieswiki', 'sqwiki', 'sqwikibooks',
        'sqwikinews', 'sqwikiquote', 'sqwiktionary', 'srnwiki',
        'srwiki', 'srwikibooks', 'srwikinews', 'srwikiquote',
        'srwikisource', 'srwiktionary', 'sswiki', 'sswiktionary',
        'stqwiki', 'strategywiki', 'stwiki', 'stwiktionary', 'suwiki',
        'suwikibooks', 'suwikiquote', 'suwiktionary', 'svwikibooks',
        'svwikinews', 'svwikiquote', 'svwikisource', 'svwikiversity',
        'svwikivoyage', 'svwiktionary', 'swwiki', 'swwikibooks',
        'swwiktionary', 'szlwiki', 'tawiki', 'tawikibooks',
        'tawikinews', 'tawikiquote', 'tawikisource', 'tawiktionary',
        'tenwiki', 'test2wiki', 'testwiki', 'testwikidatawiki',
        'tetwiki', 'tewiki', 'tewikibooks', 'tewikiquote',
        'tewikisource', 'tewiktionary', 'tgwiki', 'tgwikibooks',
        'tgwiktionary', 'thwikibooks', 'thwikinews', 'thwikiquote',
        'thwikisource', 'thwiktionary', 'tiwiki', 'tiwiktionary',
        'tkwiki', 'tkwikibooks', 'tkwikiquote', 'tkwiktionary',
        'tlwiki', 'tlwikibooks', 'tlwiktionary', 'tnwiki',
        'tnwiktionary', 'towiki', 'towiktionary', 'tpiwiki',
        'tpiwiktionary', 'trwikibooks', 'trwikimedia', 'trwikinews',
        'trwikiquote', 'trwikisource', 'trwiktionary', 'tswiki',
        'tswiktionary', 'ttwiki', 'ttwikibooks', 'ttwikiquote',
        'ttwiktionary', 'tumwiki', 'twwiki', 'twwiktionary',
        'tyvwiki', 'tywiki', 'uawikimedia', 'udmwiki', 'ugwiki',
        'ugwikibooks', 'ugwikiquote', 'ugwiktionary', 'ukwiki',
        'ukwikibooks', 'ukwikimedia', 'ukwikinews', 'ukwikiquote',
        'ukwikisource', 'ukwikivoyage', 'ukwiktionary', 'urwiki',
        'urwikibooks', 'urwikiquote', 'urwiktionary', 'usabilitywiki',
        'uzwiki', 'uzwikibooks', 'uzwikiquote', 'uzwiktionary',
        'vecwiki', 'vecwikisource', 'vecwiktionary', 'vepwiki',
        'vewiki', 'vewikimedia', 'viwiki', 'viwikibooks',
        'viwikiquote', 'viwikisource', 'viwikivoyage', 'viwiktionary',
        'vlswiki', 'votewiki', 'vowiki', 'vowikibooks', 'vowikiquote',
        'vowiktionary', 'warwiki', 'wawiki', 'wawikibooks',
        'wawiktionary', 'wikimania2005wiki', 'wikimania2006wiki',
        'wikimania2007wiki', 'wikimania2008wiki', 'wikimania2009wiki',
        'wikimania2010wiki', 'wikimania2011wiki', 'wikimania2012wiki',
        'wikimania2013wiki', 'wikimania2014wiki', 'wikimania2015wiki',
        'wowiki', 'wowikiquote', 'wowiktionary', 'wuuwiki', 'xalwiki',
        'xhwiki', 'xhwikibooks', 'xhwiktionary', 'xmfwiki', 'yiwiki',
        'yiwikisource', 'yiwiktionary', 'yowiki', 'yowikibooks',
        'yowiktionary', 'zawiki', 'zawikibooks', 'zawikiquote',
        'zawiktionary', 'zeawiki', 'zh_classicalwiki',
        'zh_min_nanwiki', 'zh_min_nanwikibooks',
        'zh_min_nanwikiquote', 'zh_min_nanwikisource',
        'zh_min_nanwiktionary', 'zh_yuewiki', 'zhwikibooks',
        'zhwikinews', 'zhwikiquote', 'zhwikisource', 'zhwikivoyage',
        'zhwiktionary', 'zuwiki', 'zuwikibooks', 'zuwiktionary']

    host { 'c1.labsdb':
        ensure       => present,
        host_aliases => regsubst($c1_dbs, '$', '.labsdb'),
        ip           => '10.64.4.11',
    }

    host { 'c2.labsdb':
        ensure       => present,
        host_aliases => regsubst($c2_dbs, '$', '.labsdb'),
        ip           => '10.64.37.4',
    }

    host { 'c3.labsdb':
        ensure       => present,
        host_aliases => regsubst($c3_dbs, '$', '.labsdb'),
        ip           => '10.64.37.5',
    }
}
