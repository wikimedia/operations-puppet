#!/bin/bash

set -e

INDEX_FILE=/var/run/etcd_mw_config_lastindex

# Gather a random etcd host (they are already shuffled) and port
host="$(dig +short SRV _etcd._tcp.<%= @site %>.wmnet | awk 'NR==1 {{sub(/\.$/,"",$4)} print $4":"$3}')"
if [[ -z "${host}" ]]; then
    echo "Unable to get etcd host"
    exit 2
fi

# Define the URL to use to call etcd in order to get the MediaWiki config directory
url="https://${host}/v2/keys/conftool/v1/mediawiki-config?recursive=true"

# Find the maximum modifiedIndex in the whole directory
index="$(curl -m 2 -s "${url}" | jq '[.. | .modifiedIndex? | numbers] | max')"

# Validate the new index
if [[ "${index}" =~ ^[0-9]+$ && "${index}" -gt "0" ]]; then
    old_index=$(<${INDEX_FILE})
    # Update it only if they differ
    if [[ "${index}" != "${old_index}" ]]; then
        echo "Updating last index to '${index}'"
        echo -n "${index}" > "${INDEX_FILE}"
    fi
else
    echo "Got invalid last index '${index}'"
    exit 3
fi
