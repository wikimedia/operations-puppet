#!/bin/bash

#############################################################
# This file is maintained by puppet!
# puppet:///modules/snapshot/create-media-per-project-lists.sh.erb
#############################################################

DATE=`/bin/date '+%Y%m%d'`
outputdir="<%= scope.lookupvar('snapshot::dirs::datadir') -%>/public/other/imageinfo/$DATE"
scriptdir="<%= scope.lookupvar('snapshot::dirs::dumpsdir') %>"
errors=0

python "${scriptdir}/onallwikis.py" --outputdir "$outputdir" \
       --config "${scriptdir}/confs/wikidump.conf.monitor" --nooverwrite \
       --query "'select img_name, img_timestamp from image;'" \
       --filenameformat "{w}-{d}-local-wikiqueries.gz"
if [ $? -ne 0 ]; then
    echo "failed sql dump of image tables"
    errors=1
fi

python "${scriptdir}/onallwikis.py" --outputdir "$outputdir" \
       --config "${scriptdir}/confs/wikidump.conf.media" --nooverwrite \
       --query "'select gil_to from globalimagelinks where gil_wiki= \"{w};\"'" \
       --filenameformat "{w}-{d}-remote-wikiqueries.gz"

if [ $? -ne 0 ]; then
    echo "failed sql dump of globalimagelink tables"
    errors=1
fi

exit $errors
