#!/bin/bash
# This script is reloading categories into a new namespace
# NOTE: This should be run under user that has rights to
# sudo service nginx reload
if [ -r /etc/wdqs/vars.sh ]; then
  . /etc/wdqs/vars.sh
fi

DEPLOY_DIR=${DEPLOY_DIR:-"<%= @package_dir %>"}
DATA_DIR=${DATA_DIR:-"<%= @data_dir %>"}
ALIAS_FILE="<%= @alias_map %>"

today=$(date -u +'%Y%m%d')
newNamespace="categories{$today}"
# Drop old dumps
rm -f "${DATA_DIR}/*-categories.ttl.gz"
# Drop old logs
rm -f "${DATA_DIR}/categories*.log"
cd $DEPLOY_DIR
bash createNamespace.sh $newNamespace || exit 1
# Load the data
bash forAllCategoryWikis.sh loadCategoryDump.sh $newNamespace >> "${DATA_DIR}/${newNamespace}.log"
# Get old namespace
oldNamespace=$(cat $ALIAS_FILE | grep categories | cut -d' ' -f2)
# Switch the map
# NOTE: right now it overrides the map. If we reuse it for other purposes,
# this needs to be made smarter.
echo "categories ${newNamespace}" > $ALIAS_FILE
# Bump nginx to reload config
sudo service nginx reload
if [ -n "${oldNamespace}" ]; then
	# Drop old namespace
	curl -s -X DELETE http://localhost:9999/bigdata/namespace/${oldNamespace}
fi