#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### contint module templates/apache/integration.wikimedia.org.erb
#####################################################################
# vim: filetype=apache

NameVirtualHost *:443
<VirtualHost *:80>
	ServerName integration.wikimedia.org

	LogLevel warn
	ErrorLog /var/log/apache2/integration_error.log
	CustomLog /var/log/apache2/integration_access.log vhost_combined

	# Force any request to HTTPS except the Zuul git repository
	RedirectMatch permanent ^/((?!(zuul\/git)).*) https://integration.wikimedia.org/$1

	# Publish Zuul git repositories
	#
	# This let Jenkins slaves the possibility to fetch git references crafted
	# by Zuul.

	SetEnv GIT_PROJECT_ROOT <%= @zuul_git_dir %>/
	# Allow access to any repository:
	SetEnv GIT_HTTP_EXPORT_ALL

	# Rewrites borrowed from OpenStack Zuul configuration
	AliasMatch ^/zuul/git/(.*/objects/[0-9a-f]{2}/[0-9a-f]{38})$ <%= @zuul_git_dir %>/$1
	AliasMatch ^/zuul/git/(.*/objects/pack/pack-[0-9a-f]{40}.(pack|idx))$ <%= @zuul_git_dir %>/$1
	ScriptAlias /zuul/git/ /usr/lib/git-core/git-http-backend/

	# Restrict access to internal network
	<Directory <%= @zuul_git_dir %>>
		Order Deny,Allow
		Deny from all
		Allow from 10.0.0.0/8
		Allow from 127.0.0.1
		# gallium is a slave with a public IP address
		Allow from 208.80.154.135
	</Directory>

</VirtualHost>

<VirtualHost *:443>
	ServerName integration.wikimedia.org
	ServerAdmin noc@wikimedia.org

	DocumentRoot /srv/org/wikimedia/integration

	# Favicon proxy
	RewriteEngine On
	RewriteRule ^/favicon\.ico$ /favicon.php [L]

	SSLEngine on
	SSLProtocol -ALL +SSLv3 +TLSv1
	SSLCipherSuite AES128-GCM-SHA256:RC4-SHA:RC4-MD5:DES-CBC3-SHA:AES128-SHA:AES256-SHA
	SSLHonorCipherOrder on
	SSLCertificateFile /etc/ssl/certs/star.wikimedia.org.pem
	SSLCertificateKeyFile /etc/ssl/private/star.wikimedia.org.key
	SSLCACertificateFile /etc/ssl/certs/RapidSSL_CA.pem

	LogLevel warn
	ErrorLog /var/log/apache2/integration_error.log
	CustomLog /var/log/apache2/integration_access.log vhost_combined

	Include *_proxy

	<Directory />
		Order Deny,Allow
		AllowOverride All
	</Directory>

	<Directory /srv/org/wikimedia/integration>
		Options FollowSymLinks
		AllowOverride All
		Order allow,deny
		allow from all
	</Directory>

	<Directory /srv/org/wikimedia/integration/logs>
		# Let people browse the console logs
		Options +Indexes
	</Directory>

	<Directory /srv/org/wikimedia/integration/*Mobile/nightly/>
		Options +Indexes
		IndexOptions FancyIndexing
		IndexOptions SuppressIcon
		IndexOptions SuppressRules
		IndexOptions SuppressDescription
		IndexOptions SuppressHTMLPreamble
		IndexOptions HTMLTable
		IndexOptions VersionSort
		IndexOptions NameWidth=*

		ServerSignature Off

		IndexStyleSheet "../../nightly.css"
		HeaderName "HEADER.html"
		ReadmeName "README.html"
		IndexIgnore "*.html" ".."
	</Directory>

	# Generic nightly builds, no specific HTML there
	<Directory /srv/org/wikimedia/integration/nightly/>
		Options +Indexes
		IndexOptions FancyIndexing
		IndexOptions SuppressDescription
		IndexOptions HTMLTable
		IndexOptions VersionSort
		IndexOptions NameWidth=*
	</Directory>

	<Directory /srv/org/wikimedia/integration/nightly/mediawiki/core>
		IndexOrderDefault Descending Date
	</Directory>

</VirtualHost>
