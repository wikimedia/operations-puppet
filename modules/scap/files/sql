#!/bin/bash

# This file is managed by Puppet (modules/scap/files/sql).

# Read configuration.
. /etc/profile.d/mediawiki.sh
MWMULTIDIR=$MEDIAWIKI_DEPLOYMENT_DIR/multiversion

# Database that the user wants to read, or a special parameter.
db=$1
shift

if [ -z "$db" ] || [ "$db" = "--help" ]; then
    echo 'Usage: sql [--write] <dbname> [mysqloptions]'
    exit 0
elif [ "$db" = "--write" ]; then
    # Database will be the next parameter
    db=$1
    shift

    hostpass=`./sqlhost --write $db`
else
    hostpass=`./sqlhost $db`
fi

if [ $? -ne 0 ]; then
    # PHP error, probably an invalid DB code
    echo "sql: Error looking up DB \"$db\"" 1>&2
    exit $?
fi

hostpass=($hostpass)
host=${hostpass[0]}
pass=${hostpass[1]}

# Execute mysql.
exec mysql -u wikiadmin -p$pass -h $host -D $db "$@"
