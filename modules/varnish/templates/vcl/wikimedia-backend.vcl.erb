// common backend code for all clusters
include "wikimedia-common.inc.vcl";

sub vcl_recv {
	call wm_common_recv_before_access;

	if (client.ip !~ wikimedia_nets) {
		// Do not allow direct access to non-frontend layers
		error 403 "Access denied";
	}

	call wm_common_recv_after_access;

	/* Function vcl_recv in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_hit {
	call wm_common_hit;
	/* Function vcl_hit in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_miss {
	call wm_common_miss;
	/* Function vcl_miss in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_pass {
	call wm_common_pass;

<% if @site_tier == "two" -%>
	// pass-traffic should not use consistent hashing, to avoid unecessary
	// traffic focus on one node and keep things performant
	set req.backend = backend_random;
<% end -%>

	/* Function vcl_pass in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_fetch {
	call wm_common_fetch;
	/* Function vcl_fetch in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_deliver {
	call wm_common_deliver;
	/* Function vcl_deliver in <%= @vcl %>.inc.vcl will be appended here */
}

sub vcl_error {
	call wm_common_error;
	/* Function vcl_error in <%= @vcl %>.inc.vcl will be appended here */
}
