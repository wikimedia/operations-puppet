#!/bin/bash
#
# varnishmtail - pipe varnishncsa output to mtail

PROGS="${1:-/etc/mtail}"

FMT='url %U\tcache_status %{X-Cache-Status}o\thttp_status %s\tcache_control %{Cache-Control}o\tinm %{If-None-Match}i
h2 %{VCL_Log:CP-HTTP2}x
tls_version %{VCL_Log:CP-TLS-Version}x
session_reused %{VCL_Log:CP-TLS-Session-Reused}x
key_exchange %{VCL_Log:CP-Key-Exchange}x
auth %{VCL_Log:CP-Auth}x
cipher %{VCL_Log:CP-Cipher}x
full_cipher %{VCL_Log:CP-Full-Cipher}x'

/usr/bin/varnishncsa -n frontend -q 'ReqMethod ne "PURGE"' -F "${FMT}" |
    mtail -progs "${PROGS}" -logfds 0
