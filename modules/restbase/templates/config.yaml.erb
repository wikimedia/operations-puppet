# RESTBase config

info:
  name: restbase


# Log error messages and gracefully restart a worker if v8 reports using more
# heap (note: not RSS).
worker_heap_limit_mb: 500

logging:
  name: restbase
  level: <%= @logging_level %>
  streams:
  # XXX: Use gelf-stream -> logstash
  - type: gelf
    host: <%= @logstash_host %>
    port: <%= @logstash_port %>

# StatsD metrics collection
metrics:
  type: txstatsd
  host: <%= @statsd_host %>
  port: <%= @statsd_port %>

# Swagger spec templates, referenced using yaml references in the spec section
# below.
templates:

  wmf-content-1.0.0: &wp/content/1.0.0
    swagger: '2.0'
    # swagger options, overriding the shared ones from the merged specs (?)
    info:
      version: 1.0.0-abcd
      title: Wikimedia REST API
      description: A REST content API, currently strongly focused on page content.
      termsOfService: http://wikimedia.org/terms/
      contact:
        name: the Wikimedia Services team
        url: http://mediawiki.org/wiki/RESTBase
      license:
        name: Creative Commons 4.0 International
        url: http://creativecommons.org/licenses/by/4.0/
    security:
      # ACLs for public *.wikipedia.org wikis
      - mediaWikiAuth:
        - user:read
    x-subspecs:
      - mediawiki/v1/content
    # - mediawiki/v1/mobile
    # - mediawiki/v1/revision-scoring

  wmf-sys-1.0.0: &wp/sys/1.0.0
    info:
      title: Default MediaWiki sys API module
      version: 1.0.0
    paths:
      /{module:table}: &wp/sys/table # Can use this anchor to share the table
        x-modules:
          # There can be multiple modules too per stanza, as long as the
          # exported symbols don't conflict. The operationIds from the spec
          # will be resolved against all of the modules.
          - name: restbase-mod-table-cassandra
            version: 1.0.0
            type: npm
            options: # Passed to the module constructor
              conf:
                hosts: [<%= Array(@seeds).join(',') %>]
                keyspace: system
                localDc: <%= @cassandra_localDc %>
                username: <%= @cassandra_user %>
                password: <%= @cassandra_password %>
                defaultConsistency: <%= @cassandra_defaultConsistency %>

      /{module:page_revisions}: &wp-page-revisions
        x-modules:
            - name: page_revisions
              version: 1.0.0
              type: file

      /{module:key_rev_value}: &wp/sys/key_rev_value
        x-modules:
          - name: key_rev_value
            version: 1.0.0
            type: file

      /{module:parsoid}:
        x-modules:
          - name: parsoid
            version: 1.0.0
            type: file
            options:
              parsoidHost: http://parsoid-lb.eqiad.wikimedia.org

      /{module:action}:
        x-modules:
          - name: action
            type: file
            options:
              apiURI: http://{domain}/w/api.php

  wp-default-1.0.0: &wp/default/1.0.0
    x-subspecs:
      - paths:
          /{api:v1}:
            x-subspec: *wp/content/1.0.0
      - paths:
          /{api:sys}:
            x-subspec: *wp/sys/1.0.0


# Swagger spec root.
spec: &spec
  title: "The RESTBase root"
  # Some more general RESTBase info
  paths:
    /{domain:en.wikipedia.org}: *wp/default/1.0.0

# The main service setup. Each worker can offer one or more services.
services:
  - name: restbase
    module: ./restbase/lib/server
    conf:
      port: <%= @port %>
      spec: *spec
