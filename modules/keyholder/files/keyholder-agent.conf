# keyholder-agent - Shared SSH-agent
#
# Runs the ssh-agent(1) instance that holds shared identities.

description "Shared SSH agent"

start on (local-filesystems and net-device-up IFACE!=lo)

pre-start script
    [ ! -r /etc/default/keyholder ] && { stop; exit 0; }
    . /etc/default/keyholder
    /bin/rm -f /run/keyholder/agent.pid /run/keyholder/agent.sock
    /usr/bin/install -m 0755 -g keyholder -o keyholder -d /run/keyholder
end script

script
  /sbin/start-stop-daemon --quiet --start  \
    --chuid "keyholder:keyholder"          \
    --pidfile /run/keyholder/agent.pid     \
    --startas /usr/bin/ssh-agent --        \
      -d -a /run/keyholder/agent.sock
end script

post-start script
    . /etc/default/keyholder
    [ -S /run/keyholder/agent.sock ] || sleep 1
end script

post-stop exec /bin/rm -f /run/keyholder/agent.pid /run/keyholder/agent.sock

# vim: set ft=upstart:
