ALERT PuppetHugeFail
  IF (count(puppet_agent_failed == 1) / count(puppet_agent_failed)) * 100 > 7
  FOR 2m
  LABELS {
    severity="crit"
  }
  ANNOTATIONS {
    SUMMARY="Puppet big failure on {{$value}}% of machines"
  }

ALERT meta_PuppetHugeFail
  IF absent((count(puppet_agent_failed == 1) / count(puppet_agent_failed)) * 100)
  FOR 10m
  LABELS {
    severity="crit"
  }
  ANNOTATIONS {
    SUMMARY="Data not found for PuppetHugeFail"
  }


ALERT PuppetFail
   IF puppet_agent_failed == 1
   FOR 2m
   LABELS {
     severity="warn"
   }
  ANNOTATIONS {
    SUMMARY="Puppet failed on {{$labels.instance}}",
    LOGS="https://logstash-beta.wmflabs.org/app/kibana#/dashboard/66ed4030-782f-11e7-b59f-bdb74a2a8a82?_g=(time:(from:now-1h,mode:quick,to:now))&_a=(filters:!((query:(match:(host:(query:{{ reReplaceAll \":\\\\d+\" \"\" $labels.instance }},type:phrase))),meta:(alias:!n,disabled:!f,index:'logstash-*',key:host,negate:!f,value:{{ reReplaceAll \":\\\\d+\" \"\" $labels.instance }})),(meta:(alias:!n,disabled:!f,index:'logstash-*',key:program,negate:!f,value:puppet-agent),query:(match:(program:(query:puppet-agent,type:phrase)))),(meta:(alias:!n,disabled:!f,index:'logstash-*',key:level,negate:!f,value:ERROR),query:(match:(level:(query:ERROR,type:phrase))))))",
  }

ALERT PuppetStale
   IF time() - puppet_agent_last_run > (60 * 35)
   FOR 5m
   LABELS {
     severity="warn"
   }
  ANNOTATIONS {
    SUMMARY="Puppet stale on {{$labels.instance}} for {{$value | humanizeDuration}}",
  }
