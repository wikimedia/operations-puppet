# https://prometheus.io/docs/practices/rules/

cluster_device:network_transmit_bytes:rate5m = sum(rate(node_network_transmit_bytes{job="node"}[5m])) by (cluster,device)
cluster_device:network_receive_bytes:rate5m = sum(rate(node_network_receive_bytes{job="node"}[5m])) by (cluster,device)

# CPU utilization and counts
cluster_mode:cpu:rate5m = avg by (cluster, mode) (rate(node_cpu{job="node"}[5m]))
instance_mode:cpu:rate5m = avg by (instance, mode) (rate(node_cpu{job="node"}[5m]))
instance_cluster:node_cpu:count = count by (instance, cluster) (node_cpu{mode="idle",job="node"})
cluster:cpu:sum = sum(instance_cluster:node_cpu:count) by (cluster)
cluster:cpu_count:sum = cluster:cpu:sum

# Aggregated memory stats
cluster:memory_MemTotal:sum = sum(node_memory_MemTotal{job="node"}) by (cluster)
cluster:memory_MemFree:sum = sum(node_memory_MemFree{job="node"}) by (cluster)
cluster:memory_Buffers:sum = sum(node_memory_Buffers{job="node"}) by (cluster)
cluster:memory_Cached:sum = sum(node_memory_Cached{job="node"}) by (cluster)
cluster:memory_SwapTotal:sum = sum(node_memory_SwapTotal{job="node"}) by (cluster)
cluster:memory_SwapFree:sum = sum(node_memory_SwapFree{job="node"}) by (cluster)

# Derived memory stats from aggregation
cluster:memory_SwapUsed:sum = cluster:memory_SwapTotal:sum - cluster:memory_SwapFree:sum
cluster:memory_Used:sum = cluster:memory_MemTotal:sum - cluster:memory_Cached:sum - cluster:memory_Buffers:sum - cluster:memory_MemFree:sum

cluster:load1:sum = sum(node_load1{job="node"}) by (cluster)
cluster:up:sum = sum(up{job="node"}) by (cluster)
cluster:up:count = count(up{job="node"}) by (cluster)
cluster:procs_running:sum = sum(node_procs_running) by (cluster)

# Varnish backend stats aggregation without server=<UUID>
# See also https://github.com/jonnenauha/prometheus_varnish_exporter/issues/12
backend:varnish_backend_bereq_bodybytes:sum = sum(varnish_backend_bereq_bodybytes) without (server)
backend:varnish_backend_bereq_hdrbytes:sum = sum(varnish_backend_bereq_hdrbytes) without (server)
backend:varnish_backend_beresp_bodybytes:sum = sum(varnish_backend_beresp_bodybytes) without (server)
backend:varnish_backend_beresp_hdrbytes:sum = sum(varnish_backend_beresp_hdrbytes) without (server)
backend:varnish_backend_conn:sum = sum(varnish_backend_conn) without (server)
backend:varnish_backend_happy:sum = sum(varnish_backend_happy) without (server)
backend:varnish_backend_pipe_hdrbytes:sum = sum(varnish_backend_pipe) without (server)
backend:varnish_backend_pipe_in:sum = sum(varnish_backend_pipe_in) without (server)
backend:varnish_backend_pipe_out:sum = sum(varnish_backend_pipe_out) without (server)
backend:varnish_backend_req:sum = sum(varnish_backend_req) without (server)

# MySQL aggregated stats
job_role_shard:mysql_global_status_queries:rate5m = sum by (job, role, shard) (rate(mysql_global_status_queries[5m]))
job_role_shard:mysql_global_status_handlers_write_total:rate5m = sum by (job, role, shard) rate(mysql_global_status_handlers_total{handler=~"(write|update|delete).*"}[5m])
job_role_shard:mysql_global_status_handlers_read_total:rate5m = sum by (job, role, shard) rate(mysql_global_status_handlers_total{handler=~"read.*"}[5m])
job_role_shard:mysql_global_status_bytes_received:rate5m = sum by (job, role, shard) rate(mysql_global_status_bytes_received[5m])
job_role_shard:mysql_global_status_bytes_sent:rate5m = sum by (job, role, shard) rate(mysql_global_status_bytes_sent[5m])
job_shard:mysql_slave_status_seconds_behind_master:max = max(mysql_slave_status_seconds_behind_master) by (job, shard)
