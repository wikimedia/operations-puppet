#!/bin/bash

PRIVATE_DATA="/usr/local/sbin/check_private_data.py"
REPORTS_DIR="/var/log"
REPORT_NAME="private_data_report_${HOSTNAME}.log"

if [ ! -f "$PRIVATE_DATA" ]
then
    echo "$PRIVATE_DATA is not present"
    exit 1
fi

# run the script

if [ "$HOSTNAME" == "db1069" ]
then
    echo "This script will not work on db1069 as it has multiple instances"
    exit 1
fi
/bin/echo "Start time: $(date)" > "$REPORTS_DIR/$REPORT_NAME"
$PRIVATE_DATA >> $REPORTS_DIR/$REPORT_NAME 2>&1 

DATA=$(/bin/egrep -v "^--|^Start time" -c $REPORTS_DIR/$REPORT_NAME)

if [ "$DATA" -gt "0" ]
then
    echo "Private data detected at $HOSTNAME check: $REPORTS_DIR/$REPORT_NAME" | /usr/bin/mail -s "Private data found at $HOSTNAME" marostegui@wikimedia.org
fi
