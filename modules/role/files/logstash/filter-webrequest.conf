# vim:set sw=2 ts=2 sts=2 et
# Process webrequest logs (5xx) from role logging::kafkatee::webrequest::ops
filter {

  if [type] == "webrequest" {
    # Tag for storage in elasticsearch
    mutate {
      add_tag => [ "es" ]
    }

    # Build http_request field used for topN reporting
    mutate {
      add_field => {
        "http_request" => "%{http_method}"
      }
    }

    if [x_analytics] !~ /https=1/ {
      mutate => {
        replace => {
          "http_request" => "%{http_request} http://"
        }
      }
    } else {
      mutate => {
        replace => {
          "http_request" => "%{http_request} https://"
        }
      }
    }

    mutate {
      replace => {
        "http_request" => "%{http_request}%{uri_host}%{uri_path}"
      }
    }

    if [uri_query] =~ /.+/ {
      mutate {
        replace => {
          "http_request" => "%{http_request}?%{uri_query}"
        }
      }
    }

  }
}
