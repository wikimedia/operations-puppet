#!/bin/bash
# NFS management script for labstore HA cluster
# This should be used to bring up a node as the active NFS server (primary DRBD)
# node, or to stop NFS and make a node DRBD secondary - which may be needed prior
# to rebooting a node, or during failovers.
#
# Usage:
# ./nfs-manage [up|down|status]
# up - Makes node DRBD primary, assigns floating IP, mounts drbd devices onto
#         fileserver, runs nfs-exportd, and starts NFS server
# down - Stop NFS server, unmounts drbd devices, makes node drbd secondary, removes
#         floating IP assignment
# status - Display mount and drbd status

CMD="$1"

case $CMD in
    up)
        echo "Bringing nfs and drbd up"
        /usr/sbin/drbd-overview

        drbd_roles=$(/sbin/drbdadm role all)
        if [[ $drbd_roles == *"Primary"* ]]
        then
            /sbin/drbdadm primary all
            ip address add <%= @cluster_ip %>/24 dev eth0
            /usr/sbin/arping -c 3 -S <%= @cluster_ip -%> -i eth0 <%= @subnet_gateway_ip -%>
            <% @drbd_resource_config.each do |resource, config| -%>
                mount <%= config['device'] -%> <%= config['disk'] -%>
            <% end -%>
            /usr/sbin/drbd-overview
            /usr/bin/timeout 10s sudo -u nfsmanager nfs-exportd
            /usr/local/sbin/nfs-manage-binds
            service nfs-kernel-server start
        else
          echo "One or all of the drbd resources in this cluster are already primary, not bring this node up"
          exit 1
        fi
        ;;
    down)
        echo "Taking down drbd and nfs"
        /usr/sbin/drbd-overview
        service nfs-kernel-server stop
        <% @drbd_resource_config.each do |resource, config| -%>
            umount <%= config['device'] -%> <%= config['disk'] -%>
        <% end -%>
        /sbin/drbdadm secondary all
        ip a del <%= @cluster_ip -%>/24 dev eth0
        /usr/sbin/drbd-overview
        ;;
    status)
        /usr/bin/drbd-overview
        showmount -e localhost | wc
        ;;
    *)
        echo $"Usage: $0 {start|stop|status}"
        exit 1
esac
