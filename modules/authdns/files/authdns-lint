#!/bin/bash
#
# Shell script to use for linting zone templates & config. It sets up a gdnsd
# chroot directory, generates zone files based on the templates using
# authdns-gen-zones and runs gdnsd checkconf.
#
# Written by Faidon Liambotis, Aug 2013

set -e

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

die() { echo >&2 "E: $*"; exit 1; }

cleanup() {
   if [ "$CLEANUP" = "yes" ] && [ -d "$TESTDIR" ]; then
       rm -rf $TESTDIR
   fi
}
trap cleanup EXIT

WORKINGDIR=$1
TESTDIR=$2

if [ -z "$WORKINGDIR" ]; then
    die "no template dir specified"
fi
echo "Using $WORKINGDIR as the input working directory"

if [ -z "$TESTDIR" ]; then
    # no test directory passed, generate one and clean it up on exit
    TESTDIR=$(mktemp -d --tmpdir 'authdns-lint.XXXXXX')
    CLEANUP=yes
fi
echo "Using $TESTDIR as the output working directory (gdnsd chroot)"
mkdir -p $TESTDIR/etc/zones

if [ ! -e /var/lib/gdnsd/testconfig/config ]; then
    die "main config file not found, system misconfigured?"
fi
if [ ! -e /var/lib/gdnsd/testconfig/discovery-geo-resources ]; then
    die "discovery-geo-resources not found, system misconfigured?"
fi
if [ ! -e /var/lib/gdnsd/testconfig/discovery-metafo-resources ]; then
    die "discovery-metafo-resources not found, system misconfigured?"
fi
if [ ! -e /var/lib/gdnsd/testconfig/discovery-states ]; then
    die "discovery-states not found, system misconfigured?"
fi
if [ ! -e /var/lib/gdnsd/testconfig/discovery-map ]; then
    die "discovery-map not found, system misconfigured?"
fi
if [ ! -e "$WORKINGDIR/templates" ]; then
    die "templates not found, system misconfigured?"
fi
if [ ! -e "$WORKINGDIR/geo-maps" ]; then
    die "geo-maps not found, system misconfigured?"
fi
if [ ! -e "$WORKINGDIR/geo-resources" ]; then
    die "geo-resources not found, system misconfigured?"
fi

echo "Generating zonefiles from zone templates"
authdns-gen-zones $WORKINGDIR/templates $TESTDIR/etc/zones

echo "Generating gdnsd config"
cp -f /var/lib/gdnsd/testconfig/config $TESTDIR/etc/
cp -f /var/lib/gdnsd/testconfig/discovery-geo-resources $TESTDIR/etc/
cp -f /var/lib/gdnsd/testconfig/discovery-metafo-resources $TESTDIR/etc/
cp -f /var/lib/gdnsd/testconfig/discovery-states $TESTDIR/etc/
cp -f /var/lib/gdnsd/testconfig/discovery-map $TESTDIR/etc/
cp -f $WORKINGDIR/geo-maps $TESTDIR/etc/geo-maps
cp -f $WORKINGDIR/geo-resources $TESTDIR/etc/geo-resources

gdnsd -sSc $TESTDIR/etc checkconf
