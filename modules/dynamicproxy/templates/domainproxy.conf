#Copyright 2013 Yuvi Panda <yuvipanda@gmail.com>
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing, software
#distributed under the License is distributed on an "AS IS" BASIS,
#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#See the License for the specific language governing permissions and
#limitations under the License.

lua_package_path "/etc/nginx/lua/?.lua";

map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}

<%- if !@notfound_servers.empty? -%>
upstream notfound {
    <%- @notfound_servers.each do |server| -%>
    server <%= server %>;
    <%- end -%>
}
<%- end -%>

server {
    resolver <%= resolver %>;

    listen 80;

    <%- if @ssl_certificate_name != false -%>
    # Serve both HTTP and HTTPS
    listen 443 default_server ssl spdy;

    ssl_certificate /etc/ssl/certs/<%= @ssl_certificate_name %>.chained.pem;
    ssl_certificate_key /etc/ssl/private/<%= @ssl_certificate_name %>.key;

    # Copied from templates/nginx/nginx.conf.erb. Eugh
    # Enable a shared cache, since it is defined at this level
    # it will be used for all virtual hosts. 1m = 4000 active sessions,
    # so we are allowing 200,000 active sessions.
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 5m;
    # SSLv2 is insecure, only allow SSLv3 and TLSv1
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    # Limit ciphers allowed
    # We strongly prefer forward-secret chiphers using ECDHE and GCM for encrypting
    # data, for performance reasons
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!DH;
    # Prefer server ciphers (Prefer RC4 first to combat BEAST)
    ssl_prefer_server_ciphers on;
    <%- end -%>

    # Some projects have tools that take data in and process them
    # for a long time. While ideally they should be made async, this
    # is an interim solution that works for now.
    proxy_read_timeout 600s;

    # People upload large files, and that is okay.
    # We can make this larger if need be.
    client_max_body_size 128m;

    <%- if !@notfound_servers.empty? -%>
    location @notfound {
        proxy_pass  http://notfound;
    }
    error_page 404 = @notfound;
    <%- end -%>

    location / {
        set $backend '';
        set $vhost '';

        access_by_lua_file /etc/nginx/lua/domainproxy.lua;

        proxy_pass $backend;
        proxy_set_header Host $vhost;

        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        <%- if @set_xff -%>
        # Passes client's IP to the backend
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        <%- end -%>
    }

    # GZIP (ALMOST) ALL THE THINGS!
    gzip on;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml application/json application/javascript application/x-javascript;
}
