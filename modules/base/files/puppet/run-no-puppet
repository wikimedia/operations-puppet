#!/bin/bash
#
# Wrapper to run a given command avoiding races with puppet

if [ -z "$1" ]; then
    echo "Usage: $0 command" >&2
    exit 1
fi

# Re-enable puppet only if it was disabled by us
enable_puppet() {
    jq '.disabled_message' < /var/lib/puppet/state/agent_disabled.lock | tr -d \" |
      grep -x "$0: $1" && puppet agent --enable
}

# Disable puppet setting the reason to the command name
puppet agent --disable "$0: $1"

# Wait for puppet to finish running, timeout after 120s
for i in {1..10}; do
    if [ ! -f "/var/lib/puppet/state/agent_catalog_run.lock" ]; then
        # Puppet is not running, carry on
        break
    fi
    sleep 12
done

if [ "$i" -eq 10 ]; then
    # Puppet did not finish its work within the timeout. Re-enable it and exit
    enable_puppet
    echo "$0: timeout reached waiting for puppet to finish running" >&2
    exit 1
fi

# Run the command
"$@"

enable_puppet
