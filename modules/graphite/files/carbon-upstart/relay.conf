# graphite/carbon-relay
#
# carbon-relay.py listens for metrics and shards or replicates across multiple
# carbon-cache.py instances. Part of the Graphite suite.
#
description "Graphite metrics listener"

# Run after carbon/init has spun up all carbon/cache instances.
start on stopped carbon/init
stop on runlevel [!2345] or carbon.stop

setuid graphite
setgid graphite

pre-start script
    # Exit normally if no relay daemon is configured for this node.
    grep -Fqx '[relay]' /opt/graphite/conf/carbon.conf || { stop; exit 0; }
end script

# "--debug" makes carbon-* stay in the foreground and log to stdout, which
# allows Upstart to take care of daemonizing and logging.
exec /opt/graphite/bin/carbon-relay.py --debug start

respawn
