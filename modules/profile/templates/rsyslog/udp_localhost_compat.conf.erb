# Provide a UDP syslog input to accept JSON payloads (in the syslog message) and forwards them to
# Kakfa.
# To be recognized as JSON the syslog message must be prepended with "@cee: "
# see also https://www.rsyslog.com/doc/v8-stable/configuration/modules/mmjsonparse.html

# Kafka topic selection is based on the syslog message severity.

module(load="imudp")

template(name="udp_localhost_topic" type="string" string="udp_localhost-%syslogseverity-text:::lowercase%")

# Use a separate (in memory) queue to limit message processing to this ruleset only.
ruleset(name="udp_localhost_to_kafka" queue.type="LinkedList") {
  action(type="mmjsonparse" name="mmjsonparse_udp_localhost")

  action(type="omkafka"
         broker=<%= scope.lookupvar('logging_kafka_brokers').to_json %>
         topic="udp_localhost_topic"
         dynatopic="on"
         dynatopic.cachesize="1000"
         partitions.auto="on"
         template="syslog_cee"
     <%- if scope['queue_size'] > 0 -%>
         queue.type="LinkedList" queue.size="<%= scope['queue_size'] %>" queue.filename="udp_localhost_compat"
         queue.highWatermark="<%= (scope['queue_size'] * 0.7).to_i %>" queue.lowWatermark="<%= (scope['queue_size'] * 0.6).to_i %>"
         queue.checkpointInterval="5"
         queue.maxDiskSpace="<%= (scope['queue_size'] * 4096).to_i %>"
     <%- end -%>
         confParam=[ "security.protocol=ssl",
                     "ssl.ca.location=<%= @trusted_ca_path %>",
                     "compression.codec=snappy",
                     "socket.timeout.ms=60000",
                     "socket.keepalive.enable=true",
                     "queue.buffering.max.ms=50",
                     "batch.num.messages=1000" ]
  )
}

input(type="imudp" port="<%= @port %>" address="localhost" ruleset="udp_localhost_to_kafka")
