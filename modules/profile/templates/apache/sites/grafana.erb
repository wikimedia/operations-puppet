# Apache configuration for Grafana.
# This file is managed by Puppet.
<VirtualHost *:80>
  ServerName <%= @domain %>
<%- @server_aliases.each do |name| -%>
  ServerAlias <%= name %>
<%- end -%>
  DocumentRoot /usr/share/grafana/public

<% if @enable_cas %>
  RewriteEngine On

  # User has clicked 'login' on a dashboard.
  # Redirect to the same dashboard on the 'rw' vhost.
  RewriteCond "%{REQUEST_URI}" "^/login"
  RewriteCond "%{HTTP_REFERER}" "^https://grafana.wikimedia.org/d/(.*)"
  RewriteRule "^" "https://grafana-rw.wikimedia.org/d/%1" [R=302,L]

  # Direct /login visit, redirect to 'rw' homepage
  RewriteCond "%{REQUEST_URI}" "^/login"
  RewriteRule "^" "https://grafana-rw.wikimedia.org" [R=302,L]

  # /explore requires login, also backwards compatibility
  RewriteCond "%{REQUEST_URI}" "^/explore"
  RewriteRule "^" "https://grafana-rw.wikimedia.org/explore" [R=302,L]
<% end %>

  ProxyPreserveHost On
  ProxyPass / http://localhost:3000/
  ProxyPassReverse / http://localhost:3000/

  RequestHeader unset X-WEBAUTH-USER

  # Automatically log in all visitors as anonymous.
  RequestHeader set X-WEBAUTH-USER "Anonymous"
</VirtualHost>
