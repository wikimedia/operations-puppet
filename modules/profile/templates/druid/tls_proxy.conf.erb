upstream broker {
    server 127.0.0.1:8082 max_fails=0;
}

server {
    listen 8182 ssl default_server;
    listen [::]:8182 ssl default_server ipv6only=on;
    server_name <%= @fqdn %>;

    ssl on;
    ssl_certificate /etc/ssl/localcerts/<%= @cert_name %>.chained.crt;
    ssl_certificate_key /etc/ssl/private/<%= @cert_name %>.key;

    keepalive_timeout 60;

    access_log   /var/log/nginx/druid_access.log;
    error_log    /var/log/nginx/druid_error.log;

    root /dev/null;

    proxy_read_timeout 120s;
    proxy_buffering off;
    client_max_body_size 2m;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;

    location /status {
        proxy_pass http://broker/druid/v2;
    }

    location /v2/druid {
        proxy_pass http://broker/druid/v2;
        limit {
            auth_basic "broker";
            auth_basic_user_file "/etc/nginx/auth/druid.htpasswd";
        }
    }
}
