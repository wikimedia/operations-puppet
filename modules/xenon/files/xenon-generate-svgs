#!/bin/bash
set +C  # OK to clobber out-of-date SVGs
shopt -s globstar nullglob
for log in /srv/xenon/**/*.log; do
    lastmodified=$(stat $log | grep Modify | awk '{print $2, $3, $4}')
    lastmodifiedts=$(date -d "$lastmodified" +%s)
    currentts=$(date '+%s')
    delta=$((currentts-lastmodifiedts))
    # Don't process log files that have been recently modifed, they are likely to
    # still being written to
    if [ $delta -lt 600 ]; then
        continue
    fi

    dir="$(dirname "$log")"
    period="$(basename "$dir")"
    time="$(basename "$log" ".log")"
    title="MediaWiki - ${period} - ${time/_/ }"
    svg="${log//log/svg}z"
    rsvg="${svg//.svgz/.reversed.svgz}"
    mkdir -m0755 -p "$(dirname $svg)"
    [ ! -f "$svg" -o "$svg" -ot "$log" ] && {
        echo "Generating ${svg}..."
        nice /usr/local/bin/flamegraph.pl --minwidth=2 --title="$title" "$log" | gzip -9 > "$svg"
    }
    [ ! -f "$rsvg" -o "$rsvg" -ot "$log" ] && {
        echo "Generating ${rsvg}..."
        nice /usr/local/bin/flamegraph.pl --minwidth=2 --reverse --colors=blue --title="$title - reversed" "$log" | gzip -9 > "$rsvg"
    }
done

for svgz in /srv/xenon/**/*.svgz; do
    log="$(sed -e 's/svgz\?/log/g' -e 's/.reversed//' <<<"$svgz")"
    [ ! -f "$log" ] && rm -f "$svgz"
done
