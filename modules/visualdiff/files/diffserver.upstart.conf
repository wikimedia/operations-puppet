# vim: set ft=upstart:

description "Visual diff HTTP service"

start on (local-filesystem and net-device-up IFACE!=lo)
stop on runlevel [!2345]

# up ulimit -n a bit
limit nofile 10000 10000

setuid "visualdiff"
setgid "visualdiff"

env DEFAULTFILE=/etc/default/visualdiff

# Basic built-in defaults. Overridden by whatever
# is defined in the DEFAULTFILE defined above.
env NODE_PATH="/srv/visualdiff/node_modules"
env BASE_PATH="/srv/visualdiff/diffserver"
env LOG_FILE="/dev/null"
env SETTINGS_FILE="/etc/visualdiff/diffserver.settings.js"
env DAEMON_ARGS="--config $SETTINGS_FILE"
env PORT="8001"

respawn

script
    if [ -f "$DEFAULTFILE" ] ; then
        . "$DEFAULTFILE"
    fi
    chdir "$BASE_PATH"
    echo "Starting visual diffing on port $PORT"
    exec /usr/bin/nodejs server.js $DAEMON_ARGS < /dev/null >> "$LOG_FILE" 2>&1
end script
