#!/bin/sh

set -e
set -x

# Install the public root ssh key
mkdir /target/root/.ssh
wget -O /target/root/.ssh/authorized_keys http://apt.wikimedia.org/autoinstall/ssh/authorized_keys
chmod go-rwx /target/root/.ssh/authorized_keys

# openssh-server: to make the machine accessible
# puppet: because we'll need it soon anyway
# lldpd: announce the machine on the network
apt-install openssh-server puppet lldpd

# Change /etc/motd to read the auto-install date
chroot /target /bin/sh -c 'echo $(cat /etc/issue.net) auto-installed on $(date). > /etc/motd.tail'

# Disable IPv6 privacy extensions before the first boot
[ -f /target/etc/sysctl.d/10-ipv6-privacy.conf ] && rm -f /target/etc/sysctl.d/10-ipv6-privacy.conf

# Install patched intel ixgbe kernel module (precise only)
if grep -qs '3\.6' /sys/module/ixgbe/version; then
	apt-install ixgbe-dkms
fi

# kernel update + optimized mkfs for all cache nodes
# (the upgrade is to grab our updated firmware packages first for initramfs...)
# (the crazy PHYS_CORES thing is to get the bnx2x option set before the first boot,
#  otherwise we'd need a reboot after puppet sets up the same file on the first run)
case `hostname` in \
	amssq[0-9]*|cp[1234]*|dysprosium)
		mount -t sysfs none /target/sys
		PHYS_CORES=$(chroot /target /usr/bin/ruby -e "require 'pathname'; print Pathname::glob('/sys/devices/system/cpu/cpu[0-9]*/topology/thread_siblings_list').map{|x| File.open(x,'r').read().split(',')[0] }.sort.uniq.count")
		umount /target/sys
		chroot /target /bin/sh -c "echo options bnx2x num_queues=$PHYS_CORES >/etc/modprobe.d/rps.conf"
		chroot /target apt-get -y upgrade
		apt-install linux-image-3.19
		mke2fs -F -F -t ext4 -T huge -m 0 -L sda3-varnish /dev/sda3
		mke2fs -F -F -t ext4 -T huge -m 0 -L sdb3-varnish /dev/sdb3
		;;
	# upgrade kernel on HP swift machines, raid controller is not recognized by
	# trusty' stock kernel
	ms-be101[678])
		mount -t sysfs none /target/sys
		mount -t proc none /target/proc
		chroot /target apt-get -y install linux-image-generic
		umount /target/sys
		umount /target/proc
		;;
esac
