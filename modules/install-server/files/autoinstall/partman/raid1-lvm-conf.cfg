# Automatic software RAID 1 with LVM partitioning.
# / is 30GB on /dev/md0.
# /dev/md1 fills up rest of disk, and a single LVM volume group is created on it.
#   swap is 8GB on an LV
#   /var is a 60G LV
#   /var/lib/zookeeper is a 250G LV
#   /var/lib/etcd is a 250G LV

d-i	partman-auto/method	string	raid
# Use the first two disks
d-i	partman-auto/disk	string	/dev/sda /dev/sdb

# Define physical partitions
d-i	partman-auto/expert_recipe	string	\
	multiraid ::	\
		5000 8000 30000 raid \
            method{ raid } \
            $primary{ } \
            $lvmignore{ } \
		. \
		64 8000 1000000 raid \
            method{ raid }	\
            $primary{ } \
            $lvmignore{ } \
		. \
		1000 1000 8000 linux-swap \
            method{ swap } \
            format{ } \
            $lvmok{ } \
            lv_name{ swap } \
			$defaultignore{ } \
		. \
		1000 1000 60000 ext4 \
    		mountpoint{ /var } \
    		method{ format } \
			$primary{ } \
			format{ } \
			$lvmok{ } \
			lv_name{ zookeeper } \
			use_filesystem{ } \
			filesystem{ ext4 } \
			$defaultignore{ } \
		. \
		1000 2000 250000 xfs \
    		mountpoint{ /var/lib/zookeeper } \
    		method{ format } \
			$primary{ } \
			format{ } \
			$lvmok{ } \
			lv_name{ zookeeper } \
			use_filesystem{ } \
			filesystem{ xfs } \
			$defaultignore{ } \
		. \
    	1000 2000 250000 ext4 \
    		mountpoint{ /var/lib/etcd } \
    		method{ format } \
			$primary{ } \
			format{ } \
			$lvmok{ } \
			lv_name{ etcd } \
			use_filesystem{ } \
			filesystem{ ext4 } \
			$defaultignore{ } \
		.

# Parameters are:
# <raidtype> <devcount> <sparecount> <fstype> <mountpoint> \
#          <devices> <sparedevices>
d-i	partman-auto-raid/recipe	string	\
		1	2	0	ext4	/	/dev/sda1#/dev/sdb1	\
		.	\
		1	2	0	lvm	-	/dev/sda2#/dev/sdb2	\
		.

d-i	partman-md/confirm	boolean	true
d-i	partman-md/device_remove_md	boolean	true

d-i	partman/confirm_write_new_label	boolean	true
d-i	partman/choose_partition	select	finish
d-i	partman/confirm	boolean	true
d-i	partman/confirm_nooverwrite	true

d-i	partman-auto-lvm/guided_size	string	80%

# the install makes sure we want to wipe the lvm
d-i	partman-lvm/device_remove_lvm	boolean	true
d-i	partman-lvm/confirm	boolean	true
d-i	partman-lvm/confirm_nooverwrite	true