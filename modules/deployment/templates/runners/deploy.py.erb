'''
Wrapper for salt commands to see which minions failed
'''

import salt.key
import salt.client
import re

# TODO: make this configurable
reg = {<% deployment_minion_regex.each do |repo,regex| %>'<%= repo %>': '<%= regex %>',<% end %>}

def fetch(repo):
    '''
    Fetch from a master, for the specified repo
    '''
    client = salt.client.LocalClient(__opts__['conf_file'])
    cmd = 'deploy.fetch'
    if repo not in reg:
        return "Error: repo isn't defined"
    regex = reg[repo]
    arg = (repo,)
    minions = {}
    ret = client.cmd_cli(regex, cmd, expr_form='pcre', arg=arg, timeout=120)
    for minion in ret:
        minions = dict(minions.items() + minion.items())
    key = salt.key.Key(__opts__)
    keys = key.list_keys()
    return report(minions,keys,repo)

def checkout(repo):
    '''
    Fetch from a master, for the specified repo
    '''
    client = salt.client.LocalClient(__opts__['conf_file'])
    cmd = 'deploy.checkout'
    if repo not in reg:
        return "Error: repo isn't defined"
    regex = reg[repo]
    arg = (repo,)
    minions = {}
    ret = client.cmd_cli(regex, cmd, expr_form='pcre', arg=arg, timeout=120)
    for minion in ret:
        minions = dict(minions.items() + minion.items())
    key = salt.key.Key(__opts__)
    keys = key.list_keys()
    return report(minions,keys,repo)

def report(minions,keys,repo):
    success = []
    didnotrun = []
    fail = {}
    for minion,ret in sorted(minions.items()):
        if not isinstance(ret, dict):
            fail[minion] = ret
            continue
        if 'ret' in ret.keys():
            if ret['ret'] == 0:
                success.append(minion)
            else:
                if 'comment' in ret.keys():
                    fail[minion] = ret['comment']
                else:
                    fail[minion] = ret
    ret = sorted(set(keys['minions_pre']) - set(minions))
    for minion in ret:
        if re.search(reg[repo],minion):
            didnotrun.append(minion)
    report = [{'success': success}, {'didnotrun': didnotrun}, {'fail': fail}]
    print report
    return report
