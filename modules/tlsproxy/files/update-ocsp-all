#!/bin/bash

if [ $# != 1 ]; then
    echo One argument required: the proxy hostname:port
    exit 1
fi

PROXY=$1
CFG_DIR=/etc/ocsp_updater
OCSP_DIR=/var/cache/ocsp
LCERT_DIR=/etc/ssl/localcerts

some_failed=0

for cfg_file in ${CFG_DIR}/*; do
    ocsp_args=$(cat $cfg_file)
    /usr/local/sbin/update-ocsp -p $PROXY $ocsp_args
    if [ $? -ne 0 ]; then
        echo "OCSP update failed for $cfg_file ($ocsp_args)"
        some_failed=1
    fi
done

/usr/sbin/service nginx reload >/dev/null 2>&1 || exit 99

exit $some_failed
