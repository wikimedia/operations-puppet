#
# THIS FILE IS MAINTAINED BY PUPPET
# source: modules/toollabs/templates/exim4.conf.erb
# from:   toollabs::mailrelay
#

primary_hostname = relay.<%= @maildomain %>
qualify_domain = <%= @maildomain %>

domainlist local_domains = <%= @maildomain %>
hostlist relay_from_hosts = 10.0.0.0/8

acl_smtp_rcpt = acl_check_rcpt
acl_smtp_data = acl_check_data

never_users = root

host_lookup = *
ignore_bounce_errors_after = 2d
timeout_frozen_after = 7d

local_from_suffix = .*

begin acl

acl_check_rcpt:
accept  hosts = :
deny    message       = Restricted characters in address
        domains       = +local_domains
        local_parts   = ^[.] : ^.*[@%!/|]

deny    message       = Restricted characters in address
        domains       = !+local_domains
        local_parts   = ^[./|] : ^.*[@%!] : ^.*/\\.\\./

accept  local_parts   = postmaster
        domains       = +local_domains

accept  hosts         = +relay_from_hosts
        control       = submission

accept  authenticated = *
        control       = submission

require message = relay not permitted
        domains = +local_domains

require verify = recipient

accept


acl_check_data:
accept


begin routers

dnslookup:
  driver = dnslookup
  domains = ! +local_domains
  transport = remote_smtp
  ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8
  no_more

postmaster_mail:
  driver = redirect
  condition = ${if forany{root:postmaster}{eq{$item}{$local_part}}}
  data = <%= instanceproject %>.admin

tool_fallback:
  driver = redirect
  local_part_prefix = <%= instanceproject %>.
  not_local_part_prefix_optional
  caseful_local_part
  local_parts = passwd;<%= instanceproject %>.$local_part
  check_ancestor
  modemask = 002
  data = $local_part.maintainers

user_forward:
  driver = redirect
  caseful_local_part
  check_local_user
  no_expn
  check_ancestor
  modemask = 002
  data = ${run{/usr/local/sbin/localuser $local_part}{$value}fail}

tool_forward_specific:
  driver = redirect
  local_part_suffix = .*
  not_local_part_suffix_optional
  caseful_local_part
  local_parts = passwd;<%= instanceproject %>.$local_part
  require_files = <%= instanceproject %>.$local_part:$home/.forward$local_part_suffix
  router_home_directory = ${lookup passwd{<%= instanceproject %>.$local_part}{${extract{5}{:}{$value}}}fail}
  file = /data/project/$local_part/.forward$local_part_suffix
  no_expn
  check_ancestor
  modemask = 002
  pipe_transport = gridqueue
  no_allow_filter
  no_allow_defer
  allow_fail
  forbid_include
  forbid_file
  forbid_smtp_code
  hide_child_in_errmsg

tool_forward_general:
  driver = redirect
  local_part_suffix = .*
  not_local_part_suffix_optional
  caseful_local_part
  local_parts = passwd;<%= instanceproject %>.$local_part
  require_files = <%= instanceproject %>.$local_part:$home/.forward
  router_home_directory = ${lookup passwd{<%= instanceproject %>.$local_part}{${extract{5}{:}{$value}}}fail}
  file = /data/project/$local_part/.forward
  no_expn
  check_ancestor
  modemask = 002
  pipe_transport = gridqueue
  no_allow_filter
  no_allow_defer
  allow_fail
  forbid_include
  forbid_file
  forbid_smtp_code
  hide_child_in_errmsg

tool_default:
  driver = redirect
  local_part_suffix = .*
  not_local_part_suffix_optional
  caseful_local_part
  local_parts = passwd;<%= instanceproject %>.$local_part
  router_home_directory = ${lookup passwd{<%= instanceproject %>.$local_part}{${extract{5}{:}{$value}}}fail}
  no_expn
  check_ancestor
  modemask = 002
  data = ${run{/usr/local/sbin/maintainers <%= instanceproject %>.$local_part}{$value}fail}

system_aliases:
  driver = redirect
  allow_fail
  allow_defer
  data = ${lookup{$local_part}lsearch{/etc/aliases}}

begin transports

gridqueue:
  driver = pipe
  batch_max = 1
  umask = 007
  user = <%= instanceproject %>.$local_part
  group = <%= instanceproject %>.$local_part
  path = /bin:/usr/bin:/usr/local/bin
  allow_commands = jmail
  return_fail_output
  temp_errors = 73:74:75

remote_smtp:
  driver = smtp

begin retry
*   *   F,2h,15m; G,16h,1h,1.5; F,4d,6h

