#!/usr/bin/python
"""
NodeJS starter script for Wikimedia Tool Labs
"""
import re
import socket
import os
import pwd

pwd_entry = pwd.getpwuid(os.getuid())  # Use uid as reserved port for each tool
TOOL = re.sub(r'^tools.', '', pwd_entry.pw_name) # Tool users are of form tools.TOOLNAME

PORT = os.getuid()

proxies = ('tools-webproxy', 'tools-webproxy-01', 'tools-webproxy-02')

socks = []
for proxy in proxies:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((proxy, 8282))
    sock.send(".*\nhttp://%s:%s\n" % (socket.getfqdn(), PORT))
    socks.append(sock)  # Keep this around, otherwise socket seems to get closed and collected

os.chdir(os.path.expanduser('~/www/js'))

# Pass in all of our parent environment too
# npm doesn't like it too much if you give it an almost empty environment
os.environ['TOOL_WEB_PORT'] = str(PORT)

os.execv('/usr/bin/npm', ['/usr/bin/npm', 'start'])
