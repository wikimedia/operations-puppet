#!/usr/bin/python3
"""
Simple helper for the cdnjs mirror
Makes a packages.json that is just a list containing
contents of all the packages.json found in the repository.
"""
import argparse
import http.client
import json
from urllib.request import urlopen

def main():
    """Main script"""
    argparser = argparse.ArgumentParser()
    argparser.add_argument('outputpath', help='Path to output JSON')
    args = argparser.parse_args()

    fields = "version,description,homepage,keywords,license,repository,author,assets"
    upstream_url = "https://api.cdnjs.com/libraries?fields={}".format(fields)
    resp = urlopen(upstream_url)
    raw_json = ""
    try:
        raw_json = resp.read().decode('utf-8')
    except http.client.IncompleteRead as inc_read:
        raw_json = raw_json + inc_read.partial.decode('utf-8')

    processed_json = json.loads(raw_json)
    packages = processed_json['results']

    with open(args.outputpath, 'w', encoding='utf-8') as f:
        json.dump(packages, f)

if __name__ == "__main__":
    main()
