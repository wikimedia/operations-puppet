#!/usr/bin/python

import errno
import grp
import os
import pwd
import time

import MySQLdb

def wmflabs_project():
    try:
        return wmflabs_project.project_name
    except AttributeError:
        with open('/etc/wmflabs-project', 'r') as f:
            wmflabs_project.project_name = f.read().rstrip('\n')
        return wmflabs_project.project_name

def update_tools_table(db):
    def read_normalized_file(path, default=None):
        try:
            with open(path, 'r') as f:
                return ' '.join(f.readlines())
        except IOError as e:
            if e.errno in (errno.EACCES, errno.ENOENT):
                return default
            raise

    def get_tool_description(homedir):
        return read_normalized_file(homedir + '/.description', '')

    def get_tool_toolinfo(homedir):
        return read_normalized_file(homedir + '/toolinfo.json',
                                    read_normalized_file(homedir + '/public_html/toolinfo.json', ''))

    # Get list of all accounts starting with "tools.".
    tool_accounts = {account.pw_name[len(wmflabs_project()) + 1:]:
                     {'home': account.pw_dir.rstrip('/'),
                      'id': account.pw_uid,
                      'maintainers': ' '.join(grp.getgrnam(account.pw_name)[3])}
                     for account in pwd.getpwall() if account.pw_name.startswith(wmflabs_project() + '.') and os.access(account.pw_dir, os.X_OK)}
    tool_accounts['test-tool'] = {'home': '/tmp', 'id': 4711, 'maintainers': ''}

    # Get list of all database entries and if they were updated in the
    # past five minutes.
    cur = db.cursor()
    cur.execute('SELECT name, UNIX_TIMESTAMP() - updated >= 300 FROM tools')
    for tools_entry in cur.fetchall():
        try:
            tool_account = tool_accounts[tools_entry[0]]
            if tools_entry[1]:
                # The database entry was last updated more than five
                # minutes ago, so update description and toolinfo as
                # well.
                cur.execute('UPDATE tools SET id = %s, home = %s, maintainers = %s, description = %s, toolinfo = %s, updated = UNIX_TIMESTAMP() WHERE name = %s', (tool_account['id'], tool_account['home'], tool_account['maintainers'], get_tool_description(tool_account['home']), get_tool_toolinfo(tool_account['home']), tools_entry[0]))
            else:
                # Only the basic information needs to be updated.
                cur.execute('UPDATE tools SET id = %s, home = %s, maintainers = %s WHERE name = %s', (tool_account['id'], tool_account['home'], tool_account['maintainers'], tools_entry[0]))
            # Remove processed tool account from list.
            del tool_accounts[tools_entry[0]]
        # If the database entry has no corresponding account, delete
        # it.
        except KeyError:
            cur.execute('DELETE FROM tools WHERE name = %s', (tools_entry[0], ))

    # Create new database entries for accounts.
    for tool_account_name, tool_account in tool_accounts.iteritems():
        cur.execute('INSERT INTO tools (name, id, home, maintainers, description, toolinfo, updated) VALUES (%s, %s, %s, %s, %s, %s, UNIX_TIMESTAMP())', (tool_account_name, tool_account['id'], tool_account['home'], tool_account['maintainers'], get_tool_description(tool_account['home']), get_tool_toolinfo(tool_account['home'])))

    db.commit()

def update_users_table(db):
    project_members = grp.getgrnam('project-%s' % wmflabs_project())[3]

    # Update users table.
    cur = db.cursor()
    cur.execute('DELETE FROM users')
    for project_member in project_members:
        passwd = pwd.getpwnam(project_member)
        if passwd.pw_gid == 500 and passwd.pw_shell == '/bin/bash':
            cur.execute('INSERT INTO users (name, id, wikitech, home) VALUES (%s, %s, %s, %s)',
                        (passwd.pw_name,
                         passwd.pw_uid,
                         str.upper(passwd.pw_gecos[0]) + passwd.pw_gecos[1:],
                         passwd.pw_dir))
    db.commit()

if __name__ == '__main__':
    while True:
        db = MySQLdb.connect(host='tools.labsdb',
                             db='toollabs_p',
                             read_default_file=pwd.getpwuid(os.getuid()).pw_dir + '/replica.my.cnf')
        update_tools_table(db)
        update_users_table(db)
        db.close()
        time.sleep(120)
