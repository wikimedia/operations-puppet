#! /bin/bash
#
# THIS FILE IS MAINTAINED BY PUPPET
# source: modules/toollabs/files/localuser
# from:   toollabs::mailrelay
#

# Test if the user is currently a member of this project.
if ! echo " $(groups "$2") " | fgrep -q " project-$1 "; then
    exit 1
fi

BIND="-D $(sed -ne '/^binddn\s/{;s/.*\s\(.*\)/\1/;p;}' /etc/ldap.conf)"
BIND="$BIND -w $(sed -ne '/^bindpw\s/{;s/.*\s\(.*\)/\1/;p;}' /etc/ldap.conf)"
echo $(
  /usr/bin/ldapsearch -LLL $BIND -b "uid=$1,ou=people,dc=wikimedia,dc=org" mail |
  	/bin/sed -ne '/^mail: \(.*\)/{;s//\1,/;p;}'
) | sed -e 's/,\s*$//'

||||||| parent of c4c17de... Tools: Only forward mail for project users
/usr/bin/ldapsearch -D "$(sed -ne 's/^binddn\s\+\(.*\)$/\1/p;' /etc/ldap.conf)" -w "$(sed -ne 's/^bindpw\s\+\(.*\)$/\1/p;' /etc/ldap.conf)" -b "uid=$1,ou=people,dc=wikimedia,dc=org" -LLL -o ldif-wrap=no mail | /bin/sed -ne 's/^mail: //p;'
