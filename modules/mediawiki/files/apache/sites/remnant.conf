# Meta
<VirtualHost *:80>
    ServerName meta.wikimedia.org
    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    # Early phase 2 compatibility URLs
    RewriteRule ^/wiki\.phtml$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php [R=301,L]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/meta/$1 [R=302]

    # Used for Firefox OS web application manifest living on meta.wikimedia.org
    AddType application/x-web-app-manifest+json .webapp
</VirtualHost>

# Wikisource
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/wikisource.org"
    ServerName wikisource.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/wikisource.org/w/index.php
    Include "sites-enabled/public-wiki-rewrites.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/sources/$1 [R=302]

    Include "sites-enabled/api-rewrites.incl"

    <Directory "/srv/mediawiki/docroot/wikisource.org/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/wikisource.org/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

# Wikimedia Commons
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/wikimedia.org"
    ServerName commons.wikimedia.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Make robots.txt editable via Mediawiki:robots.txt
    RewriteRule ^/robots.txt$ /w/robots.php [L]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/wikimedia.org/w/index.php
    Include "sites-enabled/public-wiki-rewrites.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/commons/$1 [R=302]

    # /data/ path T163922
    RewriteRule ^/data/(.*)/(.*)$ %{ENV:RW_PROTO}://commons.wikimedia.org/wiki/Special:PageData/$1/$2 [R=301,QSA]

    Include "sites-enabled/api-rewrites.incl"

    <Directory "/srv/mediawiki/docroot/wikimedia.org/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/wikimedia.org/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

# Private wikis
<VirtualHost *:80>
    ServerName private-wikis
    ServerAlias grants.wikimedia.org
    ServerAlias fdc.wikimedia.org
    ServerAlias internal.wikimedia.org
    ServerAlias board.wikimedia.org
    ServerAlias boardgovcom.wikimedia.org
    ServerAlias spcom.wikimedia.org
    ServerAlias affcom.wikimedia.org
    ServerAlias searchcom.wikimedia.org
    ServerAlias office.wikimedia.org
    ServerAlias chair.wikimedia.org
    ServerAlias auditcom.wikimedia.org
    ServerAlias otrs-wiki.wikimedia.org
    ServerAlias exec.wikimedia.org
    ServerAlias collab.wikimedia.org
    ServerAlias movementroles.wikimedia.org
    ServerAlias checkuser.wikimedia.org
    ServerAlias steward.wikimedia.org
    ServerAlias ombudsmen.wikimedia.org
    ServerAlias projectcom.wikimedia.org
    ServerAlias quality.wikimedia.org
    ServerAlias techconduct.wikimedia.org
    ServerAlias advisors.wikimedia.org
    ServerAlias electcom.wikimedia.org
    ServerAlias wikimaniateam.wikimedia.org

    UseCanonicalName off

    AllowEncodedSlashes On
    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^/(.*)$ https://%{SERVER_NAME}/$1 [R=301,L,NE]

    Include "sites-enabled/wikimedia-common.incl"
</VirtualHost>

# Incubator wiki
<VirtualHost *:80>
    ServerName incubator.wikimedia.org

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
</VirtualHost>

# WikiSpecies wiki
<VirtualHost *:80>
    ServerName species.wikimedia.org

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/species/$1 [R=302]
</VirtualHost>

# Usability Wiki
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/wikimedia.org"
    ServerName usability.wikimedia.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/wikimedia.org/w/index.php

    Include "sites-enabled/public-wiki-rewrites.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    <Directory "/srv/mediawiki/docroot/wikimedia.org/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/wikimedia.org/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

# strategy  wiki
<VirtualHost *:80>
    ServerName strategy.wikimedia.org

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
</VirtualHost>

# advisory board PUBLIC wiki
<VirtualHost *:80>
    ServerName advisory.wikimedia.org

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
</VirtualHost>

# Outreach Wiki
<VirtualHost *:80>
    ServerName outreach.wikimedia.org
    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
</VirtualHost>

## donatewiki has been moved to main.conf so it can catch donate.wikipedia.org
