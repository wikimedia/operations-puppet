# Meta
<VirtualHost *:80>
    ServerName meta.wikimedia.org
    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    # Early phase 2 compatibility URLs
    RewriteRule ^/wiki\.phtml$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php [R=301,L]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/meta/$1 [R=302]

    # Used for Firefox OS web application manifest living on meta.wikimedia.org
    AddType application/x-web-app-manifest+json .webapp
</VirtualHost>

# Wikisource
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/wikisource.org"
    ServerName wikisource.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/wikisource.org/w/index.php
    Include "sites-enabled/public-wiki-rewrites.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/sources/$1 [R=302]

    Include "sites-enabled/api-rewrites.incl"

    <Directory "/srv/mediawiki/docroot/wikisource.org/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/wikisource.org/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

# Wikimedia Commons
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/commons"
    ServerName commons.wikimedia.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Make robots.txt editable via Mediawiki:robots.txt
    RewriteRule ^/robots.txt$ /w/robots.php [L]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/commons/w/index.php
    Include "sites-enabled/public-wiki-rewrites.incl"
    Include "sites-enabled/wikimedia-legacy.incl"

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/commons/$1 [R=302]

    Include "sites-enabled/api-rewrites.incl"

    <Directory "/srv/mediawiki/docroot/commons/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/commons/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerName wikimedia-common
    ServerAlias grants.wikimedia.org
    ServerAlias fdc.wikimedia.org
    ServerAlias internal.wikimedia.org
    ServerAlias board.wikimedia.org
    ServerAlias boardgovcom.wikimedia.org
    ServerAlias spcom.wikimedia.org
    ServerAlias affcom.wikimedia.org
    ServerAlias searchcom.wikimedia.org
    ServerAlias office.wikimedia.org
    ServerAlias auditcom.wikimedia.org
    ServerAlias otrs-wiki.wikimedia.org
    ServerAlias exec.wikimedia.org
    ServerAlias collab.wikimedia.org
    ServerAlias movementroles.wikimedia.org
    ServerAlias checkuser.wikimedia.org
    ServerAlias steward.wikimedia.org
    ServerAlias ombudsmen.wikimedia.org
    ServerAlias projectcom.wikimedia.org
    UseCanonicalName off

    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    # First grab the domain from HTTP_HOST
    RewriteCond %{HTTP_HOST} (.*)
    # Now use it
    RewriteRule ^/(.*)$ https://%1/$1 [R=301,L,NE]

    Include "sites-enabled/wikimedia-common.incl"
</VirtualHost>

<VirtualHost *:80>
    ServerName wikimedia-common-legacy
    ServerAlias outreach.wikimedia.org
    ServerAlias quality.wikimedia.org
    ServerAlias advisory.wikimedia.org
    ServerAlias chair.wikimedia.org
    ServerAlias incubator.wikimedia.org
    ServerAlias strategy.wikimedia.org
    UseCanonicalName off

    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    # First grab the domain from HTTP_HOST
    RewriteCond %{HTTP_HOST} (.*)
    # Now use it
    RewriteRule ^/(.*)$ https://%1/$1 [R=301,L,NE]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
</VirtualHost>

# WikiSpecies wiki
<VirtualHost *:80>
    ServerName species.wikimedia.org

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    Include "sites-enabled/wikimedia-common.incl"
    Include "sites-enabled/wikimedia-legacy.incl"
    # Uploads are offsite
    RewriteRule ^/upload/(.*)$ %{ENV:RW_PROTO}://upload.wikimedia.org/wikipedia/species/$1 [R=302]
</VirtualHost>

# Usability Wiki
<VirtualHost *:80>
    DocumentRoot "/srv/mediawiki/docroot/usability"
    ServerName usability.wikimedia.org

    AllowEncodedSlashes On

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Primary wiki redirector:
    Alias /wiki /srv/mediawiki/docroot/usability/w/index.php

    Include "sites-enabled/public-wiki-rewrites.incl"

    # UseMod compatibility URLs
    RewriteCond %{QUERY_STRING} ([^&;]+)
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php?title=%1 [R=301,L]
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://%{SERVER_NAME}/w/index.php [R=301,L]

    RewriteRule ^/math/(.*) %{ENV:RW_PROTO}://upload.wikimedia.org/math/$1 [R=301]

    <Directory "/srv/mediawiki/docroot/usability/w">
        <IfModule mod_php5.c>
            php_admin_flag engine on
        </IfModule>
    </Directory>
    <Directory "/srv/mediawiki/docroot/usability/w/extensions">
        <IfModule mod_php5.c>
            php_admin_flag engine off
        </IfModule>
    </Directory>
</VirtualHost>

## donatewiki has been moved to main.conf so it can catch donate.wikipedia.org
