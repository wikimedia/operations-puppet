# rsyslog configuration for MediaWiki
# This file is managed by Puppet

# Emulate MediaWiki's wfDebugLog / wfErrorLog format
$template MediaWiki,"%programname% %timegenerated% %HOSTNAME%: %msg%\n"

# The trailing tilde in the filter definitions below excludes
# the messages from further processing.

# Forward Apache to /var/log/apache2.log and log aggregator.
# Rotate /var/log/apache2.log when it exceeds 100MB.
$outchannel apache2, /var/log/apache2.log, 100000000, /usr/sbin/logrotate -f /etc/logrotate.d/mediawiki_apache

:programname, isequal, "apache2" :omfile:$apache2
& @<%= scope['::mediawiki::log_aggregator'] %>;MediaWiki
& ~

# Forward HHVM logs and stack traces to log aggregator.
:programname, isequal, "hhvm" @<%= scope['::mediawiki::log_aggregator'] %>;MediaWiki
& ~

:syslogtag, isequal, "hhvm-fatal:" @<%= scope['::mediawiki::log_aggregator'] %>;MediaWiki
& ~

# Forward messages logged by the kernel and containing the string
# "hhvm" (such as warnings that the process was killed or respawned)
# to the log aggregator.
if $msg contains "hhvm" and $programname == "kernel" then @<%= scope['::mediawiki::log_aggregator'] %>;MediaWiki
