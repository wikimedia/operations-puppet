<VirtualHost *:80>
    ServerName wikipedia.<%= @domain_suffix %>

    # Redirecting from subdirectories of wikipedia.org to subdomains
    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    RewriteRule ^/([a-z]{2}|meta)/(.*)$ %{ENV:RW_PROTO}://$1.wikipedia.<%= @domain_suffix %>/wiki/$2 [R=301,L,NE]

    # Prevent the catch-all redirect below from breaking the apple-app-site-association alias
    RewriteRule /apple-app-site-association - [L]
    Alias /apple-app-site-association /srv/mediawiki/docroot/wikipedia.org/apple-app-site-association

    RewriteRule ^(.*)$ %{ENV:RW_PROTO}://www.wikipedia.<%= @domain_suffix %>$1 [R=301,L]
</VirtualHost>

<VirtualHost *:80>
    DocumentRoot /srv/mediawiki/docroot/wwwportal
    ServerName www.wikipedia.<%= @domain_suffix %>

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    # Front page...
    RewriteRule ^/$ /<%= @portal_dir %>/wikipedia.org/index.html [L]
    <%- if @rewrite_portal -%>
        RewriteRule ^/portal/(.*)$ /<%= @portal_dir %>/$1 [L]
    <%- end -%>
    RewriteRule ^/<%= @portal_dir %>/.*$ - [L]

    # We need to be able to update HTML on short notice
    <Location ~ "^/$">
        Header set Cache-Control "s-maxage=86400, must-revalidate, max-age=3600"
    </Location>
    # All other resources can be cached for a reasonably long time
    <Location ~ "^/<%= @portal_dir %>/">
        Header set Cache-Control "s-maxage=86400, max-age=86400"
    </Location>

    # search-redirect.php, let it through
    RewriteRule ^/search-redirect.php /w/search-redirect.php [L]

    # Language-specific links
    RewriteRule ^/wiki/(aa|ab|af|am|as|ay|az|ba|be|bh|bi|bn|bo|ca|co|dz|et|eu|fa|fi|fj|fo|fy|ga|gl|gn|gu|ha|hy|ia|id|ik|is|it|iu|jv|ka|kk|kl|km|kn|ks|ku|ky|la|lo|lv|mg|mi|mk|mn|mo|mr|my|na|ne|no|oc|om|or|pa|ps|pt|qu|rm|rn|rw|sa|sd|sg|si|sk|sm|sn|so|sq|ss|st|su|sw|ta|te|tg|th|ti|tk|tl|tn|to|ts|tt|tw|ug|uk|ur|uz|vi|vo|wo|xh|yi|yo|za|zu):(.*)$ %{ENV:RW_PROTO}://$1.wikipedia.<%= @domain_suffix %>/wiki/$2 [R,L]
    RewriteRule ^/wiki/(ar|bs|cs|cy|da|de|dk|el|en|eo|es|fr|gd|gv|he|hi|hr|hu|ja|ko|ml|ms|nl|pl|ro|ru|sh|sl|sr|sv|tr|zh|zh-cn|zh-tw|nds):(.*)$ %{ENV:RW_PROTO}://$1.wikipedia.<%= @domain_suffix %>/wiki/$2 [R,L]

    # English Wikipedia pages
    # ErrorDocument defined in sites-available/01-main.conf should be served directly and not redirected
    RewriteCond %{REQUEST_URI} !=/w/404.php
    RewriteRule ^/(upload|wiki|stats|w)/(.*)$ %{ENV:RW_PROTO}://en.wikipedia.<%= @domain_suffix %>/$1/$2 [R=301,L]

    RewriteRule ^/wiki$ %{ENV:RW_PROTO}://en.wikipedia.<%= @domain_suffix %>/ [R=301,L]

    # Mailing lists...
    RewriteRule ^/(mailman|pipermail)(.*)$ https://lists.wikimedia.org/$1$2 [R=301,L]

    # Old-style english wikipedia
    RewriteCond %{QUERY_STRING} ([^&;]+)
    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://en.wikipedia.<%= @domain_suffix %>/wiki/%1 [R=302,L]

    RewriteRule ^/wiki\.cgi$ %{ENV:RW_PROTO}://en.wikipedia.<%= @domain_suffix %>/ [R=302,L]

    # Prevent the catch-all redirect below from breaking the apple-app-site-association alias
    RewriteRule /apple-app-site-association - [L]
    Alias /apple-app-site-association /srv/mediawiki/docroot/wikipedia.org/apple-app-site-association

    # Everything else
    # ErrorDocument defined in sites-available/01-main.conf should be served directly and not redirected
    RewriteCond %{REQUEST_URI} !=/w/404.php
    RewriteRule ^(.*)$ %{ENV:RW_PROTO}://en.wikipedia.<%= @domain_suffix %>$1 [R=301,L]

    <IfModule mod_php5.c>
        php_admin_flag engine on
    </IfModule>

</VirtualHost>

<VirtualHost *:80>
    ServerName m.wikipedia.<%= @domain_suffix %>
    ServerAlias zero.wikipedia.<%= @domain_suffix %>
    UseCanonicalName off

    DocumentRoot /srv/mediawiki/docroot/m.wikipedia.org
    <IfModule mod_php5.c>
        php_admin_flag engine on
    </IfModule>

    RewriteEngine On

    # Everything will be redirected to the appropriate lang.m.wikipedia.org or lang.zero.wikipedia.org based on zero configuration @ meta
    RewriteRule ^/$ /w/mobilelanding.php [L]
</VirtualHost>

<VirtualHost *:80>
    ServerName www.wikibooks.<%= @domain_suffix %>
    ServerAlias m.wikibooks.<%= @domain_suffix %>
    Serveralias www.wikinews.<%= @domain_suffix %>
    ServerAlias m.wikinews.<%= @domain_suffix %>
    ServerAlias www.wikiquote.<%= @domain_suffix %>
    ServerAlias m.wikiquote.<%= @domain_suffix %>
    ServerAlias www.wikiversity.<%= @domain_suffix %>
    ServerAlias m.wikiversity.<%= @domain_suffix %>
    ServerAlias www.wikivoyage.<%= @domain_suffix %>
    ServerAlias m.wikivoyage.<%= @domain_suffix %>
    ServerAlias www.wiktionary.<%= @domain_suffix %>
    ServerAlias m.wiktionary.<%= @domain_suffix %>

    DocumentRoot /srv/mediawiki/docroot/wwwportal
    <IfModule mod_php5.c>
        php_admin_flag engine on
    </IfModule>

    RewriteEngine On
    RewriteRule . - [E=RW_PROTO:%{HTTP:X-Forwarded-Proto}]
    RewriteCond %{ENV:RW_PROTO} !=https
    RewriteRule . - [E=RW_PROTO:http]

    SetEnvIf Host "^(www|m)\.wik(i(books|news|quote|voyage)|tionary)\.<%= @domain_suffix %>$" project=$2

    # Front page...
    RewriteRule ^/$ /<%= @portal_dir %>/%{ENV:project}.org/index.html [L]

    <%- if @rewrite_portal -%>
        RewriteRule ^/portal/(.*)$ /<%= @portal_dir %>/$1 [L]
    <%- end -%>

    # We need to be able to update HTML on short notice
    <Location ~ "^/$">
        Header set Cache-Control "s-maxage=86400, must-revalidate, max-age=3600"
    </Location>
    # All other resources can be cached for a reasonably long time
    <Location ~ "^/<%= @portal_dir %>/">
        Header set Cache-Control "s-maxage=86400, max-age=86400"
    </Location>

    # search-redirect.php, let it through
    RewriteRule ^/search-redirect.php /w/search-redirect.php [L]

    # wikivoyage, old /de
    RewriteCond %{HTTP_HOST} ^(www|m)\.wikivoyage\.<%= @domain_suffix %>$
    RewriteRule ^/de/(.*)$ %{ENV:RW_PROTO}://de.wikivoyage.<%= @domain_suffix %>/wiki/$1 [R=301,L]

    # wikivoyage, old /it
    RewriteCond %{HTTP_HOST} ^(www|m)\.wikivoyage\.<%= @domain_suffix %>$
    RewriteRule ^/it/(.*)$ %{ENV:RW_PROTO}://it.wikivoyage.<%= @domain_suffix %>/wiki/$1 [R=301,L]

    # Everything else
    # ErrorDocument defined in sites-available/01-main.conf should be served directly and not redirected
    RewriteCond %{REQUEST_URI} !=/w/404.php
    RewriteRule ^(.*)$ %{ENV:RW_PROTO}://en.%{ENV:project}.<%= @domain_suffix %>$1 [R=301,L]
</VirtualHost>

# vim: sts=4 sw=4 syn=apache autoindent
