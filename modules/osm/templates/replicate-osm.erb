#!/bin/bash

EXPIRY_FILE=<%= @expire_dir %>/expire.list.$(date "+%Y%m%d%H%M")
EXTRA_PARAMS=<%if @flat_nodes %>'--flat-nodes <%= @osmosis_dir %>/nodes.bin'<% end %>

<% if @proxy -%>
export JAVACMD_OPTIONS="\
    -Dhttp.proxyHost=<%= @proxy.split(':')[0] %>  -Dhttp.proxyPort=<%= @proxy.split(':')[1] %> \
    -Dhttps.proxyHost=<%= @proxy.split(':')[0] %> -Dhttps.proxyPort=<%= @proxy.split(':')[1] %>"
<% end -%>

/usr/bin/flock -xn <%= @osmosis_dir %>/replicate-osm.lck \
  /usr/bin/osmosis \
       --read-replication-interval \
       workingDirectory=<%= @osmosis_dir %> \
       --simplify-change \
       --write-xml-change - 2>/tmp/osmosis.log \
    | /usr/bin/osm2pgsql \
      --hstore \
      --slim \
      --input-reader <%= @input_reader_format %> \
      --cache <%= @memory_limit %> \
      --number-processes <%= @num_threads %> \
      --expire-tiles <%= @expire_levels %> \
      --expire-output $EXPIRY_FILE \
      --username osmupdater \
      --database gis \
      --append $EXTRA_PARAMS - && \
    /usr/bin/curl \
      -d expdirpath=<%= @expire_dir %>             \ # expiration files dir
      -d expmask=expire\\.list\\.*                 \ # regex to match expiration files
      -d statefile=<%= @expire_dir %>/expire.state \ # tilerator uses this file to record last imported data file
      -d fromZoom=10                               \ # new jobs will be created from this zoom
      -d beforeZoom=16                             \ # and until (but not including) this zoom
      -d generatorId=gen                           \ # copy tiles from ("gen" will only produce non-empty tiles)
      -d storageId=v3                              \ # copy tiles to
      -d deleteEmpty=1                             \ # if tile is empty, make sure we don't store it, if it was there before
      http://localhost:6535/add
