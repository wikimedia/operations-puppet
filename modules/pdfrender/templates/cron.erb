#!/bin/bash

# WARNING: This file is managed by Puppet, modifying it manually is futile

check_cmd='curl http://localhost:<%= @port %> >/dev/null 2>&1';

if ${check_cmd}; then
	# the service is up, we are done here
	exit 0;
fi

# since the service is down, first depool it
/usr/local/bin/depool-pdfrender;

# try to restart the service
counter=10;
while [[ ${counter} > 0 ]]; do
	/bin/systemctl stop pdfrender;
	sleep 12;
	/bin/systemctl start pdfrender;
	sleep 2;
	if ${check_cmd}; then
		# the service is up, we are done
		counter=-1;
	else
		# not done yet, we need another round
		(( counter-- ));
	fi
done

if [[ ${counter} == 0 ]]; then
	# bringing up the service failed, so echo something
	echo "[$(date)] Failed to bring pdfrender up, leaving it depooled!" >2;
	exit 1;
fi

# the service is now up, we are good to go, repool it
/usr/local/bin/pool-pdfrender;
exit 0;

