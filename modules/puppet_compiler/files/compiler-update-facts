#!/bin/bash
# update facts from all puppet masters to the puppet compiler machine

set -e
set -u
set -x

COMPILER=${PUPPET_COMPILER:-compiler02.puppet3-diffs.eqiad.wmflabs}
MASTERS=$(ruby -e "require 'yaml'; a = YAML.load(STDIN.read)['puppetmaster::servers']; puts a.map{|k, v| a[k].map {|v| v['worker']}}.flatten().join(' ')" < hieradata/common/puppetmaster.yaml)

for master in $MASTERS; do
    echo -e "\n### Syncing facts from $master"
    ssh "$master" 'sudo /usr/local/bin/puppet-facts-export 1>/dev/null'
    # tunnel via your localhost without ever the file touching the disk
    ssh "$master" cat /tmp/puppet-facts-export.tar.xz | ssh "$COMPILER" 'cat > puppet-facts-export.tar.xz'
    ssh "$master" 'sudo rm /tmp/puppet-facts-export.tar.xz'
    ssh "$COMPILER" 'sudo rm -rf /tmp/catalogs; sudo mkdir -p /tmp/catalogs'
    ssh "$COMPILER" 'sudo tar Jxf puppet-facts-export.tar.xz --directory /tmp/catalogs && rm puppet-facts-export.tar.xz'
    # Do not modify the files in /tmp/catalogs, the modified date counts for the rsync
    ssh "$COMPILER" 'sudo chown -R jenkins-deploy:wikidev /tmp/catalogs/yaml'
    ssh "$COMPILER" 'sudo rsync -au /tmp/catalogs/yaml/ /var/lib/catalog-differ/puppet/yaml/ && sudo rm -rf /tmp/catalogs'
done
