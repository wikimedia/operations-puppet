# Transparent proxy which passes requests to a set of un-pooled
# application servers that are reserved for debugging, based on
# the value of the X-Wikimedia-Debug header.

map $http_x_wikimedia_debug $debug_backend {
  <%= @backend_regexp.sub(/^~*/, '~').to_pson %> $http_x_wikimedia_debug;
  <%= @backend_aliases.sort.map { |k, v| "#{k.to_pson} #{v.to_pson};" }.join("\n  ") %>
  default 'invalid';
}

server {
    listen       [::]:80 ipv6only=off;
    server_name  _;
    access_log   /var/log/nginx/debug_proxy_access.log;
    error_log    /var/log/nginx/debug_proxy_error.log;

    location / {
        if ($debug_backend = invalid) {
            return 400;
        }

        proxy_buffering off;
        proxy_pass $scheme://$debug_backend;
        proxy_pass_request_headers on;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
    }
}
