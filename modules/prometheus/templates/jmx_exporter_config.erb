<%-
# All labels / targets list
all = []


# Find all servers in the current site, and filter them by the servers list we just found
@site_clusters.each do |cluster, val|
  targets = val[@site].select { |server| keys(@resources).include?(server) }
  if targets.length > 0
    all.push(
      {
        'labels' => @labels.merge({'cluster' => cluster}),
        'targets' => targets.map{|t| "#{@resources[t]['title']}:#{@resources[t]['port']}" },
      }
    )
  end
end
-%>
# This file is managed by puppet
<%= scope.function_ordered_yaml([all]) %>
