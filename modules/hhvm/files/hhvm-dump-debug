#!/bin/bash
# hhvm-dump-debug: dump HHVM backtrace to /tmp.
# When invoked with "--core", also dump core.

die() { local st="$?"; echo "$@" >&2; exit $st; }

[[ ! $SUDO_COMMAND ]] && {
    sudo $0 "$@"
    exit $?
}

. /etc/default/hhvm || die

read PID <"${HHVM_RUN_DIR:-/run/hhvm}/hhvm.pid"
case $PID in ''|*[!0-9]*)
    die "Can't find PID file of HHVM." ;;
esac

args=("-batch" "-p" "$PID" "-ex" "thread apply all backtrace full")

if [[ $1 == --core ]]; then
   args+=("-ex" "generate-core-file /tmp/hhvm.${PID}.core")
   cp "/proc/$PID/exe" "/tmp/hhvm.${PID}.bin"
fi

gdb "${args[@]}" >"/tmp/hhvm.${PID}.bt" 2>/dev/null
die "Saved HHVM debug data in /tmp/hhvm.${PID}.*"
