#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### puppet:///templates/apache/sites/gerrit.wikimedia.org.erb
#####################################################################
# vim: filetype=apache

# Due to Jetty's connection limiting flooding logs with "Dispatched
# Failed" Error messages, we limit connections already here.
MaxClients 50

<VirtualHost *:80>
    ServerAdmin noc@wikimedia.org
    ServerName <%= @host %>

    <%- if @labs_https -%>
    Include gerrit-http
    <%- else -%>
    Include gerrit-https
    <%- end -%>
<%- if @labs_https -%>
</VirtualHost>

NameVirtualHost *:443
<VirtualHost *:443>
    ServerAdmin noc@wikimedia.org
    ServerName <%= @host %>
    # https://httpoxy.org/
    RequestHeader unset Proxy early

    SSLEngine on
    SSLCertificateFile /etc/acme/cert/gerrit.crt
    SSLCertificateChainFile /etc/acme/cert/gerrit.chain.crt
    SSLCertificateKeyFile /etc/acme/key/gerrit.key
    <%= @ssl_settings.join("\n") %>

    Include gerrit-https
    <%- else -%>
    RewriteEngine on
    RewriteCond %{SERVER_PORT} !^80$
    RewriteRule ^/(.*)$ https://<%= @host %>/$1 [L,R=301,NE]

    Include gerrit-https
    <%- end -%>

</VirtualHost>
