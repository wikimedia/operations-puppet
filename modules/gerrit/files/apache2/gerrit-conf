    <%- if @gerrit_ssl -%>
    RedirectMatch ^/$ https://<%= @host %>/r/
    RedirectMatch ^/r$ https://<%= @host %>/r/
    <%- else -%>
    RedirectMatch ^/$ http://<%= @host %>/r/
    RedirectMatch ^/r$ http://<%= @host %>/r/
    <%- end -%>

    # Misbehaving bots
    SetEnvIf User-Agent 80legs bad_browser
    SetEnvIf User-Agent bingbot bad_browser
    SetEnvIf User-Agent Baiduspider bad_browser
    SetEnvIf User-Agent Sogou bad_browser
    SetEnvIf User-Agent TweetmemeBot bad_browser
    SetEnvIf User-Agent Yeti bad_browser
    SetEnvIf Remote_Addr 208.110.84.34 bad_browser
    SetEnvIf Remote_Addr 89.83.122.45 bad_browser
    SetEnvIf Remote_Addr 129.242.4.62 bad_browser

    TimeOut 720

    DocumentRoot /var/www
    <Directory />
        Options FollowSymLinks
        AllowOverride None
        <IfVersion < 2.4>
          Order deny,allow
          deny from env=bad_browser
        </IfVersion>
        <IfVersion >= 2.4>
            <RequireAll>
              Require all granted
              Require not env bad_browser
            </RequireAll>
        </IfVersion>
    </Directory>
    <Directory /var/www/>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
    </Directory>

    ProxyRequests Off
    ProxyVia Off
    ProxyPreserveHost On

    <Proxy *>
        <IfVersion < 2.4>
          Order deny,allow
          deny from env=bad_browser
        </IfVersion>
        <IfVersion >= 2.4>
            <RequireAll>
              Require all granted
              Require not env bad_browser
            </RequireAll>
        </IfVersion>
    </Proxy>

    AllowEncodedSlashes On
    RewriteEngine On

    # git-review for some reason sometimes uses <https://gerrit.wikimedia.org/tools/hooks/commit-msg>
    # instead of <https://gerrit.wikimedia.org/r/tools/hooks/commit-msg>, except when somebody is
    # trying to reproduce this behavior. But people run into this all the time.
    <%- if @gerrit_ssl -%>
    RewriteRule ^/tools/hooks/commit-msg$ https://<%= @host %>/r/tools/hooks/commit-msg
    <%- else -%>
    RewriteRule ^/tools/hooks/commit-msg$ http://<%= @host %>/r/tools/hooks/commit-msg
    <%- end -%>

    # Workaround for really broken browser detection in Gerrit code. Not sure if the hex string is
    # stable, this will probably need to be updated at least after Gerrit upgrades. Just load up
    # Gerrit in Firefox and look in the Network Monitor for a similarly named .cache.js file.
    <%- if @gerrit_ssl -%>
    RewriteRule ^/r/gerrit_ui/undefined.cache.js$ https://<%= @host %>/r/gerrit_ui/D39174379837CB12534D3B279AEAC59F.cache.js
    <%- else -%>
    RewriteRule ^/r/gerrit_ui/undefined.cache.js$ http://<%= @host %>/r/gerrit_ui/D39174379837CB12534D3B279AEAC59F.cache.js
    <%- end -%>

    <%- if @maint_mode -%>
    RedirectMatch temp "/r" "/error.html#"
    <%- else -%>
    ProxyPass /r/ http://127.0.0.1:8080/r/ retry=0 nocanon
    ErrorDocument 503 "/error.html#"
    <%- end -%>

    ErrorLog /var/log/apache2/<%= @host %>.https.error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/<%= @host %>.https.access.log wmf
    ServerSignature Off
