#!/bin/sh

PATH=/usr/bin:/bin
export PATH
<% if @server_type == 'standalone' or @server_type == 'frontend' -%>
PMASTER="yes"
<% end -%>

if [ "$USER" = "gitpuppet" ]; then
    # Add an apache reload, since puppet is stupid and will botch
    # catalogues in a way that does not show up on the clients and causes
    # an insane amount of confusion. A reload makes it regenerate them properly.
    #/etc/init.d/apache2 reload

    # This bug has allegedly been fixed, so let's try with touch site.pp again
    touch /etc/puppet/manifests/site.pp

    # TODO: After migration delete the sockpuppet references
    if [ `hostname` = 'sockpuppet' -o "$PMASTER" == "yes" ]; then
        # If no key is forwarded then this will use the ready-made equivalent command
        #  on worker and ignore our command.
	<%- @workers.each do |worker| -%>
	ssh -t -t <%= worker -%> 'cd /var/lib/git/operations/puppet && git pull && git submodule update --init'
	<%- end -%>
	<%- if @fqdn == 'sockpuppet.pmtpa.wmnet' -%>
	ssh -t -t stafford.pmtpa.wmnet 'cd /var/lib/git/operations/puppet && git pull && git submodule update --init'
	<%- end -%>
    fi
fi
