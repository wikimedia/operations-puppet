#!/bin/bash
set -e
MAXMIND_DB_SOURCE_DIR="<%= @maxmind_db_source_dir %>"
MAXMIND_DB_ARCHIVE_DIR="<%= @archive_dir %>"
CURRENT_DATE=$(date +'%Y-%m-%d')

cd <%= @archive_dir %>
# is the archive directory empty?
if [ -z "$(ls -A .)" ]
then
#  - if so, copy the contents of /usr/share/geoip into a timestamped directory
	mkdir $CURRENT_DATE
	cp -R "$MAXMIND_DB_SOURCE_DIR/." "$MAXMIND_DB_ARCHIVE_DIR/$CURRENT_DATE"
else
# otherwise do a diff between the last directory archived and the current contents of /usr/share/geoip
	 # echo "diffing " "$MAXMIND_DB_SOURCE_DIR/" $("ls | head -1") and "$MAXMIND_DB_ARCHIVE_DIR/$CURRENT_DATE"
	if [ -z "$(diff -r $MAXMIND_DB_SOURCE_DIR "$MAXMIND_DB_ARCHIVE_DIR/"$(ls | head -1))" ]
	then
	# if there is no difference, do nothing, end script
		exit 0
	else
	# if there's a difference, copy the contents of /usr/share/geoip into a timestamped directory
		mkdir $CURRENT_DATE
		cp -R "$MAXMIND_DB_SOURCE_DIR/." "$MAXMIND_DB_ARCHIVE_DIR/$CURRENT_DATE"
	fi
fi

HDFS_ARCHIVE_LOCATION="<%= @hdfs_archive_dir %>"

# does /wmf/data/archive/geoip exist in hdfs?
if [ ! $(hdfs dfs -test -d "$HDFS_ARCHIVE_LOCATION")]
# copy the last directory (the one just created) to the directory structure in hdfs
then
	hdfs dfs -mkdir $HDFS_ARCHIVE_LOCATION
fi
hdfs dfs -put "$MAXMIND_DB_ARCHIVE_DIR/$CURRENT_DATE" "$HDFS_ARCHIVE_LOCATION"
#  - no: create