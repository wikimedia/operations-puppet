# vim: filetype=apache.erb
# Apache site configuration for <%= @servername %>.

<VirtualHost *:80>
    ServerName "<%= @servername %>"
    DocumentRoot "<%= @docroot %>"

    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
    Header always merge Vary X-Forwarded-Proto
    Header set Strict-Transport-Security "max-age=604800"

<%- if @restricted_to -%>
    AuthName "<%= @auth_realm %>"
    AuthType Basic
    AuthBasicProvider ldap
    AuthLDAPBindDN cn=proxyagent,ou=profile,dc=wikimedia,dc=org
    AuthLDAPBindPassword <%= scope.lookupvar('::passwords::ldap::production::proxypass') %>
    AuthLDAPURL "ldaps://ldap-labs.eqiad.wikimedia.org ldap-labs.codfw.wikimedia.org/ou=people,dc=wikimedia,dc=org?cn"
    <%- (@restricted_to.kind_of?(String) ? [@restricted_to] : @restricted_to).each do |group| -%>
    Require ldap-group "cn=<%= group %>,ou=groups,dc=wikimedia,dc=org"
    <%- end -%>
<%- end -%>

    <Directory />
        Order Deny,Allow
        AllowOverride All
    </Directory>

    <Directory "<%= @docroot %>">
        Allow from all
    </Directory>
</VirtualHost>
