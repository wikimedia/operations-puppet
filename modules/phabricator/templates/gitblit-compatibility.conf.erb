# Apache configuration for Phabricator (<%= @gitblit_servername %>)
# This file is managed by Puppet.

<VirtualHost *:80>
  ServerName <%= @gitblit_servername %>
<% if !@serveradmin.empty? -%>
  ServerAdmin <%= @serveradmin %>
<%- end %>

  <IfModule mod_remoteip.c>
    RemoteIPHeader X-Client-IP
    RemoteIPInternalProxy <%= @trusted_proxies.join(' ') %>
  </IfModule>

  RewriteEngine on

  LogLevel warn
  ErrorLog /var/log/apache2/phabricator_error.log
  CustomLog /var/log/apache2/phabricator_access.log wmf
  ServerSignature Off

  # in general slashes in the repo name or ref name may be %2f or %2F or an actual /

  # https://git.wikimedia.org/summary/mediawiki/core.git -> https://phabricator.wikimedia.org/r/p/mediawiki/core
  RewriteRule ^/summary/([a-z/]+)\.git$ https://phabricator.wikimedia.org/r/p/$1 [NE,L,R=301]

  # https://git.wikimedia.org/tree/mediawiki/core.git -> https://phabricator.wikimedia.org/r/p/mediawiki/core;browse/
  RewriteRule ^/tree/([a-z/]+)\.git$ https://phabricator.wikimedia.org/r/p/$1;browse/ [NE,L,R=301]

  # https://git.wikimedia.org/tree/mediawiki/core.git/refs%2Fheads%2Fmaster -> https://phabricator.wikimedia.org/r/p/mediawiki/core;browse/master/
  RewriteRule ^/tree/([a-z/]+)\.git(\%2[Ff]|/).+(\%2[Ff]|/)([a-z]+)$ https://phabricator.wikimedia.org/r/p/$1;browse/$4/ [NE,L,R=301]

  # https://git.wikimedia.org/log/mediawiki/core.git/refs%2Fheads%2Fmaster -> https://phabricator.wikimedia.org/r/p/mediawiki/core;history/master/
  RewriteRule ^/log/([a-z/]+)\.git(\%2[Ff]|/).+(\%2[Ff]|/)([a-z]+)$ https://phabricator.wikimedia.org/r/p/$1;history/$4/ [NE,L,R=301]

  # https://git.wikimedia.org/commit/mediawiki/core.git/4d294bceab9669ee7169248e92fe747a3b5fce7c -> https://phabricator.wikimedia.org/r/revision/mediawiki/core;4d294bceab9669ee7169248e92fe747a3b5fce7c
  RewriteRule ^/commit/([a-z/]+)\.git(\%2[Ff]|/)([0-9a-f]+)$ https://phabricator.wikimedia.org/r/revision/$1;$3 [NE,L,R=301]

  #TODO check the above

  # static
  RewriteRule ^/activity/$ https://phabricator.wikimedia.org/diffusion/query/active/ [NE,L,R=301]
  RewriteRule ^/projects/$ https://phabricator.wikimedia.org/diffusion/query/all/ [NE,L,R=301]
  RewriteRule ^/repositories/$ https://phabricator.wikimedia.org/diffusion/query/all/ [NE,L,R=301]
  RewriteRule ^/lucene/$ https://phabricator.wikimedia.org/diffusion/query/advanced/ [NE,L,R=301]
  RewriteRule ^/$ https://phabricator.wikimedia.org/diffusion [NE,L,R=301]

  # catch all
  RewriteRule ^.*$ https://phabricator.wikimedia.org/diffusion [NE,L,R=301]

</VirtualHost>
