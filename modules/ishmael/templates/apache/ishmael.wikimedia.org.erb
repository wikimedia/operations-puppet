# vim: filetype=apache

NameVirtualHost *:80
NameVirtualHost *:443

<VirtualHost *:443>
	ServerName ishmael.wikimedia.org
	SSLEngine On
	SSLProtocol -ALL +SSLv3 +TLSv1
	SSLCipherSuite AES128-GCM-SHA256:RC4-SHA:RC4-MD5:DES-CBC3-SHA:AES128-SHA:AES256-SHA
	SSLHonorCipherOrder on
	SSLCertificateFile /etc/ssl/private/star.wikimedia.org.pem
	SSLCertificateKeyFile /etc/ssl/private/star.wikimedia.org.key
	SSLCACertificateFile /etc/ssl/certs/RapidSSL_CA.pem
	DocumentRoot /srv/ishmael

	<Directory "/srv/ishmael">
		Options FollowSymLinks
		SSLRequireSSL
		Options ExecCGI
		DirectoryIndex index.php
		AllowOverride AuthConfig
		Order Allow,Deny
		Allow From All
		AuthName "WMF Labs (use wiki login name not shell)"
		AuthType Basic
		AuthBasicProvider ldap
		AuthLDAPBindDN cn=proxyagent,ou=profile,dc=wikimedia,dc=org
		AuthLDAPBindPassword <%= proxypass %>
		AuthLDAPURL "ldaps://virt0.wikimedia.org virt1000.wikimedia.org/ou=people,dc=wikimedia,dc=org?cn"
		Require ldap-group cn=wmf,ou=groups,dc=wikimedia,dc=org
	</Directory>
</VirtualHost>

<VirtualHost *:80>
	ServerName ishmael.wikimedia.org
	DocumentRoot /srv/ishmael

	RewriteEngine on
	RewriteCond %{SERVER_PORT} !^443$
	RewriteRule ^/(.*)$ https://ishmael.wikimedia.org/$1 [L,R]
</VirtualHost>
