# Apache configuration for tessera.wikimedia.org
# This file is managed by Puppet.
<VirtualHost *:80>
    ServerName tessera.wikimedia.org
    ServerAdmin noc@wikimedia.org

    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteCond %{REQUEST_URI} !^/status$
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
    Header always merge Vary X-Forwarded-Proto env=ProtoRedirect
    Header always set Strict-Transport-Security "max-age=604800"

    <Location />
        SetHandler uwsgi-handler
        uWSGIsocket /run/uwsgi/tessera.sock
        uWSGIForceWSGIScheme https

        <Limit POST PUT DELETE>
            AuthName "<%= @auth_ldap['name'] %>"
            AuthType Basic
            AuthBasicProvider ldap
            AuthLDAPBindDN <%= @auth_ldap['bind_dn'] %>
            AuthLDAPBindPassword <%= @auth_ldap['bind_password'] %>
            AuthLDAPURL "<%= @auth_ldap['url'] %>"
            <% @auth_ldap['groups'].each do |group| -%>
            Require ldap-group <%= group %>
            <% end -%>
        </Limit>
    </Location>
</VirtualHost>
