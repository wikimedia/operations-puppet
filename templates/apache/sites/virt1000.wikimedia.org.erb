#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### puppet:///templates/apache/sites/virt1000.wikimedia.org
#####################################################################
# vim: filetype=apache

<VirtualHost *:80>
    ServerAdmin noc@wikimedia.org
    ServerName virt1000.wikimedia.org

    DocumentRoot /usr/local/apache/common/docroot/wikimedia.org
    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>
    <Directory /usr/local/apache/common/docroot/wikimedia.org>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>

    RewriteEngine on
    RewriteCond %{SERVER_PORT} !^443$
    RewriteRule ^/(.*)$ https://virt1000.wikimedia.org/$1 [L,R]

    ErrorLog /var/log/apache2/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/access.log combined
    ServerSignature Off

</VirtualHost>
<VirtualHost *:443>
    ServerAdmin noc@wikimedia.org
    ServerName virt1000.wikimedia.org

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/<%= @certificate %>.pem
    SSLCertificateKeyFile /etc/ssl/private/<%= @certificate %>.key
    SSLCACertificatePath /etc/ssl/certs/
    <%= @ssl_settings.join("\n") %>

    RedirectMatch ^/$ https://virt1000.wikimedia.org/wiki/

    RewriteEngine on
    RewriteRule ^/view/(.*)$ https://virt1000.wikimedia.org/wiki/$1 [L,R]
    RewriteCond %{HTTP_HOST}   !^virt1000\.wikimedia\.org [NC]
    RewriteRule ^/(.*)         https://virt1000.wikimedia.org/$1 [L,R]

    DocumentRoot /usr/local/apache/common/docroot/wikimedia.org
    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>
    <Directory /usr/local/apache/common/docroot/wikimedia.org>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>
    <Directory /srv/org/wikimedia/controller/wikis/images>
        php_flag engine off
    </Directory>
    <Location /server-status>
        SetHandler server-status
        Order deny,allow
        Deny from all
        Allow from 208.80.154.18
        Allow from 208.80.152.32
    </Location>

    Alias /w/images /srv/org/wikimedia/controller/wikis/images
    Alias /w /usr/local/apache/common/docroot/wikimedia.org/w
    Alias /wiki /usr/local/apache/common/docroot/wikimedia.org/w/index.php
    Alias /dumps /a/backup/public

    ErrorLog /var/log/apache2/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/access.log combined
    ServerSignature Off

</VirtualHost>
