#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### puppet:///templates/apache/sites/wikitech.wikimedia.org
#####################################################################
# vim: filetype=apache

<VirtualHost *:80>
    ServerAdmin noc@wikimedia.org
    ServerName <%= @webserver_hostname %>
    ServerAlias wmflabs.org www.wmflabs.org

    DocumentRoot /var/www
    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>
    <Directory /var/www/>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>

    RewriteEngine on
    RewriteCond %{SERVER_PORT} !^443$
    RewriteRule ^/(.*)$ https://<%= @webserver_hostname %>/$1 [L,R]

    ErrorLog /var/log/apache2/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/access.log combined
    ServerSignature Off

</VirtualHost>
<VirtualHost *:443>
    ServerAdmin noc@wikimedia.org
    ServerName <%= @webserver_hostname %>

    SSLEngine on
    SSLProtocol +ALL -SSLv2
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!DH
    SSLHonorCipherOrder on
    SSLCertificateFile /etc/ssl/certs/<%= @certificate %>.pem
    SSLCertificateKeyFile /etc/ssl/private/<%= @certificate %>.key
    SSLCACertificatePath /etc/ssl/certs/

    Header append Strict-Transport-Security "max-age=604800"

    RedirectMatch ^/$ https://<%= @webserver_hostname %>/wiki/

    RewriteEngine on
    RewriteRule ^/view/(.*)$ https://<%= @webserver_hostname %>/wiki/$1 [L,R]
    RewriteCond %{HTTP_HOST}   !^<%= @webserver_hostname.gsub(%r[\.],'\\.') %> [NC]
    RewriteRule ^/(.*)         https://<%= @webserver_hostname %>/$1 [L,R]

    DocumentRoot /var/www
    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>
    <Directory /var/www/>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>
    <Directory /srv/org/wikimedia/controller/wikis/images>
        php_flag engine off
    </Directory>

    Alias /w/images /srv/org/wikimedia/controller/wikis/images
    Alias /w /srv/org/wikimedia/controller/wikis/w
    Alias /wiki /srv/org/wikimedia/controller/wikis/w/index.php
    Alias /dumps /a/backup/public
    <% if realm == "labs" %>
    # Add additional wikis for development
    Alias /w2 /srv/org/wikimedia/controller/wikis/w2
    Alias /wiki2 /srv/org/wikimedia/controller/wikis/w2/index.php
    Alias /w3 /srv/org/wikimedia/controller/wikis/w3
    Alias /wiki3 /srv/org/wikimedia/controller/wikis/w3/index.php
    <% end %>


    ErrorLog /var/log/apache2/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/access.log combined
    ServerSignature Off

</VirtualHost>
