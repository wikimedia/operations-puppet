# Note: This file is managed by Puppet.
<%
# ERb template variables:
#
#   site_name
#   redirect_target
#
-%>

<VirtualHost *:80>
  # <%= @site_name %>, and metrics-api.wikimedia.org are
  # deprecated. The services it provided are now available through
  # Wikimetrics.
  #
  # We keep the domain around only because old documentation and
  # search engines still refer to it.

  ServerName <%= @site_name %>
  ServerAlias metrics-api.wikimedia.org
  ServerAdmin noc@wikimedia.org

  Redirect permanent / <%= @redirect_target %>

  ErrorLog /var/log/apache2/error.metrics.log
  LogLevel warn
  CustomLog /var/log/apache2/access.metrics.log combined
</VirtualHost>

<VirtualHost *:443>
  # Same as above <VirtualHost *:80 />, but as we do not want to
  # pollute puppet with a separate configuration that we can include
  # both above and here, and until we can use Apache 2.4 to use
  # <If />, we have to duplicate the above configuration verbatim.

  # Copied configuration from above <VirtualHost *:80 /> ---------------

  ServerName <%= @site_name %>
  ServerAlias metrics-api.wikimedia.org
  ServerAdmin noc@wikimedia.org

  Redirect permanent / <%= @redirect_target %>

  ErrorLog /var/log/apache2/error.metrics.log
  LogLevel warn
  CustomLog /var/log/apache2/access.metrics.log combined

  # SSL configuration --------------------------------------------------

  SSLEngine on
  SSLProtocol +ALL -SSLv2
  SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!DH
  SSLHonorCipherOrder on
  SSLCertificateFile    /etc/ssl/certs/<%= site_name %>.pem
  SSLCertificateChainFile /etc/ssl/certs/<%= site_name %>.chained.pem
  SSLCertificateKeyFile /etc/ssl/private/<%= site_name %>.key
</VirtualHost>
