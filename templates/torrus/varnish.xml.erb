<?xml version="1.0" encoding="UTF-8"?>

<%
def node_lists(role, site)
	return scope.lookupvar("role::cache::configuration::decommissioned_nodes")[role][site], scope.lookupvar("role::cache::configuration::active_nodes")[role][site]
end

def varnish_nodes(role, site)
	decommissioned_nodes, active_nodes = node_lists(role, site)
	result = []

	decommissioned_nodes.each do |node|
		result << "<subtree name=\"#{node}\">"
		result << "\t<param name=\"hostname\" value=\"#{node}\"/>"
		result << "\t<apply-template name=\"decommissioned-varnish-server\"/>"
		result << "</subtree>"
	end

	active_nodes.each do |node|
		result << "<subtree name=\"#{node}\">"
		result << "\t<param name=\"hostname\" value=\"#{node}\"/>"
		result << "\t<apply-template name=\"wikimedia-varnish-server\"/>"
		result << "</subtree>"
	end
	
	return result
end

%>

<configuration>
	<creator-info>
		Written by Mark Bergsma &lt;mark@wikimedia.org&gt;
	</creator-info>
	<include filename="varnish-mib.xml"/>

	<datasources>
		<template name="wikimedia-varnish-server">
			<param name="comment" value="%hostname% Varnish statistics"/>

			<apply-template name="varnish-clientsgroup"/>
			<apply-template name="varnish-cacheperformancegroup"/>
			<apply-template name="varnish-backendsgroup"/>
			<apply-template name="varnish-storagegroup"/>
			<apply-template name="varnish-workersgroup"/>
			<apply-template name="varnish-overheadgroup"/>
		</template>

		<template name="decommissioned-varnish-server">
			<param name="ds-type" value="rrd-file"/>
			<param name="hidden" value="yes"/>
			
			<apply-template name="wikimedia-varnish-server"/>
		</template>

		<subtree name="Varnish">
			<param name="ds-type" value="rrd-file"/>
			<param name="leaf-type" value="rrd-def"/>
			<param name="rrd-cf"    value="AVERAGE" />
			<param name="rrd-ds" value="sum"/>
			<param name="data-dir" value="/var/lib/ganglia/rrds"/>
			<param name="data-file" value="%varnishcluster%/%hostname%/%metric%.rrd"/>

			<subtree name="pmtpa">
				<subtree name="bits">
					<param name="system-id" value="%hostname%"/>
					<param name="varnishcluster" value="Bits caches pmtpa"/>
					<param name="site" value="pmtpa"/>

<% varnish_nodes('bits', 'pmtpa').each do |line| -%>
					<%= line %>
<% end -%>
				</subtree>
			</subtree>

			<subtree name="eqiad">
				<subtree name="bits">
					<param name="system-id" value="%hostname%"/>
					<param name="varnishcluster" value="Bits caches eqiad"/>
					<param name="site" value="eqiad"/>

<% varnish_nodes('bits', 'eqiad').each do |line| -%>
					<%= line %>
<% end -%>
				</subtree>
			
				<subtree name="upload">
					<param name="system-id" value="%hostname%"/>
					<param name="varnishcluster" value="Upload caches eqiad"/>
					<param name="site" value="eqiad"/>
					
<% varnish_nodes('upload', 'eqiad').each do |line| -%>
					<%= line %>
<% end -%>
				</subtree>
				
				<subtree name="mobile">
					<param name="system-id" value="%hostname%"/>
					<param name="varnishcluster" value="Mobile caches eqiad"/>
					<param name="site" value="eqiad"/>

<% varnish_nodes('mobile', 'eqiad').each do |line| -%>
					<%= line %>
<% end -%>
				</subtree>
			</subtree>
			
			<subtree name="esams">
				<subtree name="bits">
					<param name="system-id" value="%hostname%"/>
					<param name="varnishcluster" value="Bits caches esams"/>
					<param name="site" value="esams"/>

<% varnish_nodes('bits', 'esams').each do |line| -%>
					<%= line %>
<% end -%>
				</subtree>
			</subtree>
		</subtree>
	</datasources>
</configuration>
