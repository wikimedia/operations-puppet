// Varnish VCL include file for Parsoid backends

// Include common Parsoid config shared between front- and backend
include "parsoid-common.inc.vcl";

sub vcl_miss {
	if (req.http.Cache-Control ~ "only-if-cached") {
		error 412 "Entity not in cache";
	}
}

sub vcl_pass {
	if (req.http.Cache-Control ~ "only-if-cached") {
		error 412 "Entity not in cache";
	}
}

sub vcl_fetch {
	// This is our legacy retry5xx code, only parsoid backend still uses it
	if (beresp.status >= 500 && beresp.status < 505) {
		# Retry the backend request 3 times, then give up and display
		# the backend's error page, instead of our own.
		#
		# Note that max_restarts is 4 by default, so Varnish would
		# otherwise detect this as a loop and present its own 503.
		if (req.restarts < 3) {
			return(restart);
		} else {
			return(deliver);
		}
	}
}
