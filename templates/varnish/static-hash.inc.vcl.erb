
// The only difference below from the varnish default vcl_hash implementation
// is the hostname mangling for static paths.  The point of this is to avoid
// duplicate hashing of the /static/ stuff for every (lang * proj), which
// would waste a bunch of space (and a bunch of fetches on new static assets)
sub vcl_hash {
	hash_data(req.url);

	// force host to www.wm.o for /static, so it's always consistent.
	// Otherwise, requests for apache-level redirect domains cache the
	// redirect for all possible domains, creating redirect loops.
	// See: https://phabricator.wikimedia.org/T104532
	if (req.url ~ "^/static/") {
		req.http.host = "www.wikimedia.org";
	}

	if (req.http.host) {
		hash_data(req.http.host);
	} else {
		hash_data(server.ip);
	}
	return (hash);
}
