// Varnish VCL include file for mobile backends

include "errorpage.inc.vcl";
include "text-common.inc.vcl";

sub vcl_recv {
	call vcl_recv_purge;
	// FIXME: restrict access

	if (req.http.host ~ "^test\.") {
		set req.http.X-Wikimedia-Debug = "1";
	}

<% if @site_tier == "one" -%>
	if (req.http.X-Wikimedia-Debug == "1") {
		set req.backend = test_wikipedia;
	} else if (req.url ~ "^/w/api\.php") {
		set req.backend = api;
	}
<% end -%>

	if (req.request != "GET" && req.request != "HEAD") {
		return (pass);
	}

	call evaluate_cookie_mobile;
	call pass_authorization;
	return (lookup);
}

sub vcl_pass {
	call restore_cookie;
}

sub vcl_miss {
	call restore_cookie;
}

sub vcl_fetch {
	if (req.url ~ "mobileaction=" || req.url ~ "useformat=") {
		set beresp.ttl = 60 s;
	}

	if (beresp.ttl <= 0s || req.http.X-Wikimedia-Debug == "1") {
		set beresp.ttl = 120s;
		return (hit_for_pass);
	}

	return (deliver);
}

sub vcl_error {
	call errorpage;
	return (deliver);
}
