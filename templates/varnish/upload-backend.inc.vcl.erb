# Varnish VCL include file for mobile backends

sub vcl_recv {
	if (client.ip !~ wikimedia_nets) {
		error 403 "Access denied";
	}

	if ( req.http.host == "upload.wikimedia.org") {
		return (lookup);
	} else {
		error 403 "Requested target domain not allowed."; 
	}
}

sub vcl_miss {
	# Send thumbnails to the Swift thumbs cluster
	if ( req.url ~ "^/+[^/]+/[^/]+/thumb/" ) {
		set req.backend = swift_thumbs;
	}
}
