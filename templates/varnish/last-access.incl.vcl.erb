// Varnish VCL include file for WMF-Last-Access Cookie
// Please see what this cookie is trying to acomplish:
// https://wikitech.wikimedia.org/wiki/Analytics/Unique_clients/Last_visit_solution

// General notes on timestamp format strings used here:
// "now" stringifies as "Wed, 01 Jan 2000 01:01:01 GMT", which is the
// same format used by Set-Cookie "Expires" data.  The format for the
// last access value, and thus X-NowDay and X-LastStamp as well, is
// "01-Jan-2000" (because the other info is redundant or too-specific,
// and cookie values shouldn't have whitespace or commas).

// private to below...
sub set_last_access_cookie__ {
	// This should be:
	// 	header.append(resp.http.Set-Cookie,
	//		"WMF-Last-Access="
	//		+ resp.http.X-NowDay
	//		+ ";Path=/;HttpOnly;Expires="
	//		+ (now + 32d)
	// 	);
	// However, varnish3 is buggy wrt str + (time + duration), so
	// we're forced to drop to inline C a bit here and do what the
	// VCL compiler should have done for us above...
	C{
		Vmod_Func_header.append(sp, HDR_RESP, "\013Set-Cookie:",
			"WMF-Last-Access=",
			VRT_GetHdr(sp, HDR_RESP, "\011X-NowDay:"),
			";Path=/;HttpOnly;Expires=",
			VRT_time_string(sp, ((VRT_r_now(sp) + 2764800))),
			vrt_magic_string_end
		);
	}C
}

sub analytics_last_access {
	// Create X-NowDay in last-access form, from "now" in cookie-expires form
	set resp.http.X-NowDay = regsub(now, "^..., (..) (...) (....) .*$", "\1-\2-\3");

	// XXX need to look at Cookie vs Orig-Cookie stuff and where this lands in relation to that...

	// Check for a valid-looking existing cookie...
	// Note we don't validate that the 3-letter month abbreviation is
	// legal, or that the numeric values for the date/year are legal, just
	// that they have the right count of the right kinds of characters
	if (req.http.Cookie ~ "(^|;\s*)WMF-Last-Access=[0-9]{2}-[A-Za-z]{3}-[0-9]{4}(;|$)") {
		// send the stamp to Analytics
		set resp.http.X-LastStamp = regsub(req.http.Cookie, "^(?:.*;\s*)?WMF-Last-Access=([^;]+).*$", "\1");
		if (resp.http.X-Analytics) {
			set resp.http.X-Analytics = resp.http.X-Analytics + ";WMF-Last-Access=" + resp.http.X-LastStamp;
		} else {
			set resp.http.X-Analytics = "WMF-Last-Access=" + resp.http.X-LastStamp;
		}

		// re-set the cookie if it's not from today
		if (resp.http.X-NowDay != resp.http.X-LastStamp) {
			call set_last_access_cookie__;
		}

		// clear temp vars from above
		unset resp.http.X-LastStamp;
	}
	else {
		// sets the initial cookie if no valid one existed
		call set_last_access_cookie__;
	}

	// clear temp vars from above
	unset resp.http.X-NowDay;
}
