sub misc_recv_pass {
<%
    hostcmps = []
    @vcl_config['req_handling'].keys.sort.each do |reqhost|
        if @vcl_config['req_handling'][reqhost]['force-pass']
            if reqhost ~ /^[-.A-Za-z0-9]+$/
                hostop = "=="
            else
                hostop = "~"
            end
            hostcmps.push(%Q[req.http.Host #{hostop} "#{reqhost}"])
        end
    end
    pass_conds = hostcmps.join("\n        || ");
%>
    if (
           <%= pass_conds -%>
    ) {
        return (pass);
    }

    if (req.method != "GET" && req.method != "HEAD") {
        // We only deal with GET and HEAD
        return (pass);
    }

    // don't cache authorized requests
    if (req.http.Authorization) {
        return (pass);
    }

    // don't cache cookie requests, but ignore google analytics cookies and our
    // own global WMF-Last-Access, GeoIP, and CP cookies.
    set req.http.NC-Cookie = regsuball(req.http.Cookie, "(?i)(^|;\s*)(_ga[-_a-z]*|_utm[-_a-z]*|WMF-Last-Access|GeoIP|CP)=[^;]*", "");
    set req.http.NC-Cookie = regsub(req.http.NC-Cookie, "^;?\s*", "");
    if (req.http.NC-Cookie != "") {
        unset req.http.NC-Cookie;
        return (pass);
    }
    unset req.http.NC-Cookie;
}
