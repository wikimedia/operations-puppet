sub misc_recv_pass {
<%
    def_action = false
    if_stmts = []
    @vcl_config['req_handling'].keys.sort.each do |reqhost|
        options = @vcl_config[reqhost]
        host_action = false
        if options.has_key?('subpaths')
            path_def_action = false
            path_ifs = []
            options['subpaths'].keys.sort.each do |subpath|
                path_options = options['subpaths'][subpath]
                if path_options['force-pass']
                    path_action = 'return (pass);'
                    if subpath == 'default'
                        path_def_action = path_action
                    else
                        path_ifs.push(%Q[if (req.url ~ "#{subpath}") { #{path_action} }]
                    end
                end
            end
            if path_def_action
                path_ifs.push("e { #{path_def_action} } ")
            end
            host_action = path_ifs.join(' els')
        elsif options['force-pass']
            host_action = 'return (pass);'
        end

        if host_action
            if reqhost == 'default'
                def_action = host_action
            else
                if reqhost =~ /^[-.A-Za-z0-9]+$/
                    hostop = '=='
                else
                    hostop = '~'
                end
                hostcmp = %Q[req.http.Host #{hostop} "#{reqhost}"]
                if_stmts.push("if (#{hostcmp}) {\n        #{host_action}    }")
            end
        end
    end
    if def_action
        if_stmts.push("e {\n        #{def_action}\n    }")
    end
    do_passes = if_stmts.join(' els')
%>
    <%= do_passes -%>

    if (<%= @req_method -%> != "GET" && <%= @req_method -%> != "HEAD") {
        // We only deal with GET and HEAD
        return (pass);
    }
}
