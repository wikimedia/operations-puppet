# Varnish VCL include file for text backends

include "errorpage.inc.vcl";

sub vcl_recv {
	call vcl_recv_purge;
<% if cluster_tier == 1 -%>

	if ( req.http.host ~ "^test\." ) {
		set req.backend = test_wikipedia;
		return (pass);
	}
	if (req.url ~ "^/w/api.php") {
		set req.backend = api;
	}
<% end -%>

	return(lookup);
}

sub vcl_miss {
	/* Restore the original Cookie header for MediaWiki */
	set req.http.Cookie = req.http.Orig-Cookie;
	unset req.http.Orig-Cookie;
}

sub vcl_error {
	call errorpage;
	return(deliver);
}