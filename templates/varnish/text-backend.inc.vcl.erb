# Varnish VCL include file for text backends

include "errorpage.inc.vcl";
include "text-common.inc.vcl";

sub vcl_recv {
	call vcl_recv_append_xff;
	call vcl_recv_purge;
	call restrict_access;

<% if vcl_config.fetch("cluster_tier", "1") == "1" -%>
	if ( req.http.host ~ "^test\." ) {
		set req.backend = test_wikipedia;
		return (pass);
	}

<% end -%>
<% if vcl_config.fetch("cluster_tier", "1") == "1" -%>
	if (req.url ~ "^/w/api\.php") {
		set req.backend = api;
	} else if (req.url ~ "^/w/thumb(_handler)?\.php") {
		set req.backend = rendering;
	}

<% end -%>
	if (req.request != "GET" && req.request != "HEAD") {
		return (pass);
	}

	call cookie_munging;

	return(lookup);
}

sub vcl_pass {
	call restore_cookie;
}

sub vcl_miss {
	call restore_cookie;
}

sub vcl_fetch {
	/* FIXME: Fix up missing Vary headers on Apache redirects */
	if ((beresp.status == 301 || beresp.status == 302)
		&& beresp.http.Location ~ "^http"
		&& beresp.http.Vary !~ "X-Forwarded-Proto") {
		if (beresp.http.Vary) {
			set beresp.http.Vary = beresp.http.Vary + ",X-Forwarded-Proto";
		} else {
			set beresp.http.Vary = "X-Forwarded-Proto";
		}
	}

	if (beresp.ttl <= 0s) {
		set beresp.ttl = 120s;
		return (hit_for_pass);
	}
	return (deliver);
}

sub vcl_error {
	call errorpage;
	return(deliver);
}