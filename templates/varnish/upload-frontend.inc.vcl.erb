# Varnish VCL include file for upload frontends

import std;

sub vcl_recv {
	/* Support HTTP PURGE from localhost */
	if (req.request == "PURGE") {
		if (!client.ip ~ purge) {
			error 405 "Denied.";
		# This is a stupid hack to make varnishhtcpd work - it's using a perl mod that sends purge reqs like
		# PURGE http://de.wikipedia.orghttp://de.wikipedia.org/w/index.php
		} elsif (req.url ~ "^http://upload.wikimedia.org") {
			set req.url = regsub ( req.url, "^http://[\w.]+(/.*)", "\1");
			return (lookup);
		} else {
			error 200 "Domain not cached here.";
		}
	}

	if (req.request != "GET" && req.request != "HEAD") {
		/* We only deal with GET, HEAD at this point */
		error 403 "HTTP method not allowed.";
	}

	if ( req.http.host == "upload.wikimedia.org") {
		return (lookup);
	} else {
		error 403 "Requested target domain not allowed.";
	}
}

sub vcl_fetch {
	# Cache media objects for 1 hour by default
	set beresp.ttl = 1h;

	# Stream large objects, > 64 MB
	if (std.integer(beresp.http.Content-Length, 0) > 67108864) {
		set beresp.do_stream = true;
		/* don't attempt to cache these in the frontend */
		return (hit-for-pass);
	}
}
