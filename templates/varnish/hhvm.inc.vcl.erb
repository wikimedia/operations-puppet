# Common functions for HHVM handling

sub hhvm_add_vary {
	/* Set Vary to depend on X-Use-HHVM */
	if (beresp.http.Vary !~ "X-Use-HHVM") {
		if (beresp.http.Vary) {
			set beresp.http.Vary = beresp.http.Vary + ",X-Use-HHVM";
		} else {
			set beresp.http.Vary = "X-Use-HHVM";
		}
	}
}


sub hhvm_is_cacheable {
	/* do not cache requests that should go to hhvm but have been
	 * replied by Zend. */
	if (req.http.X-Use-HHVM == "1" && beresp.http.X-Powered-By !~ "^HHVM") {
		set beresp.ttl = 0s;
	}
}

/* Manage X-Analytics token for HHVM/Zend tracking */
sub php_mark_engine {	
	if (resp.http.X-Analytics) {
		if (resp.http.X-Powered-By ~ "^HHVM") {
			set resp.http.X-Analytics = resp.http.X-Analytics + ";php=hhvm";
		} else {
			set resp.http.X-Analytics = resp.http.X-Analytics + ";php=zend";
		}
	} else {
		if (resp.http.X-Powered-By ~ "^HHVM") {
			set resp.http.X-Analytics = "php=hhvm";
		} else {
			set resp.http.X-Analytics = "php=zend";
		}
	}
}

sub choose_hhvm_backend {
	/* Use the hhvm backend for any request to the standard appservers.
	On a request restart (often due to an error), fallback to the Zend pool */
	if ( req.http.X-Use-HHVM == "1" && req.restarts == 0) {
		if (req.backend == api) {
			set req.backend = hhvm_api
		} else {
			set req.backend = hhvm_appservers;
		}
	}
}
