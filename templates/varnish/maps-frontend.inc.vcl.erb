// Varnish VCL include file for upload frontends

include "errorpage.inc.vcl";

sub vcl_recv {
	call recv_purge;
	if (req.http.referer
		&& req.url != "/"
		&& req.http.referer !~ "(?i)^https?://([-a-zA-Z0-9.]+\.)?(mediawiki|wikivoyage|wikivoyage-ev|wmflabs)\.org/"
		&& req.http.referer !~ "(?i)^https?://(maps|phabricator|wikitech|incubator)\.wikimedia\.org/"
		&& req.http.referer !~ "(?i)^https?://(localhost|127\.0\.0\.1)(:\d+)?/"
	) {
		<%= error_synth(403, "Access Denied") %>
	}

<% if @varnish_version4 -%>
	return (hash);
<% else -%>
	return (lookup);
<% end -%>
}

<% if @varnish_version4 -%>
sub vcl_backend_error {
<% else -%>
sub vcl_error {
<% end -%>
	call errorpage;
	return (deliver);
}
