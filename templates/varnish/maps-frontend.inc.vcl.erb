// Varnish VCL include file for upload frontends

include "errorpage.inc.vcl";

sub vcl_recv {
	call vcl_recv_purge;
	if (req.http.referer
		&& req.http.referer !~ "(?i)^https://maps\.wikimedia\.org/"
		&& req.http.referer !~ "(?i)^https://[-a-zA-Z0-9.]+\.wikivoyage\.org/"
		&& req.http.referer !~ "(?i)^https?://[-a-zA-Z0-9.]+\.wmflabs\.org/"
	) {
		error 403 "Access Denied";
	}

	return (lookup);
}

sub vcl_fetch {
	// Cap TTL to 1 day for now (purging still hasn't been sorted out...)
	if (beresp.ttl > 1d) {
		set beresp.ttl = 1d;
	}
	return (deliver);
}

sub vcl_error {
	call errorpage;
	return (deliver);
}
