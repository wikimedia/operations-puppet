username = 'novaadmin'
password = '<%= @wikitech_nova_ldap_user_pass %>'
projects = ['project-proxy', 'deployment-prep', 'tools', 'toolserver-legacy']
# TODO: When we have a v3 Nova API, get a list of projects dynamically instead of hardcoding them here.

from novaclient import client as novaclient
import json
out = []
for project in projects:
	client = novaclient.Client("1.1", username, password, project, 'http://<%= @nova_controller_hostname %>:35357/v2.0')

	for server in client.servers.list():
		serverAddresses = {}
		for address in server.addresses['public']:
			if address['OS-EXT-IPS:type'] == 'floating':
				serverAddresses['public_ip'] = str(address['addr'])
			elif address['OS-EXT-IPS:type'] == 'fixed':
				serverAddresses['private_ip'] = str(address['addr'])
		if 'public_ip' in serverAddresses:
			out.append((str(server.name), serverAddresses['public_ip'], serverAddresses['private_ip']))

with open('/etc/powerdns/ip-alias.lua', 'w') as f:
	f.write("aliasmapping = {}\n")
	for name, public, private in out:
		f.write("aliasmapping[\"" + public + "\"] = \"" + private + "\" # " + name + "\n")
	f.write("""
function postresolve ( remoteip, domain, qtype, records, origrcode )
    for key,val in ipairs(records)
    do
            if (aliasmapping[val.content] and val.qtype == pdns.A)
            then
                    val.content = aliasmapping[val.content]
                    setvariable()
            end
    end
    return origrcode, records
end
""")
