<%# these functions are adapted from modules/torrus/templates/varnish.xml.erb
    which references values in manifests/role/cache.pp -%>
<%
cache_types = ['bits', 'mobile', 'text', 'upload']
cache_colos = ['esams', 'ulsfo']
main_colos = ['eqiad', 'codfw']

def node_lists(role, site)
    realm = @realm
    return scope.lookupvar("role::cache::configuration::active_nodes")[realm][role][site]
nd

def varnish_nodes(role, site)
    active_nodes = node_lists(role, site)
    result = []

    # TODO: _by_ipv4, _by_ipv6
    active_nodes.each do |node|
        result << "conn #{fqdn}-#{node}_by_hostname"
        result << "\t# #{role} cache: #{node}"
        result << "\ttype=transport"
        #result << "\tauto=start"
        result << "\tauto=route"
        result << "\tleft=#{fqdn} "
        result << "\tleftcert=#{fqdn}.pem"
        result << "\tright=#{node}"
        result << "\trightid=\"CN=#{node}\""
        result << ""
    end

    return result
end
-%>
# ipsec.conf - strongSwan IPsec configuration file
# Generated by Puppet

# Basic configuration
config setup
	plutostart=no	# IKEv1 daemon
	charonstart=yes	# IKEv2 daemon
	charondebug="cfg 2, dmn 2"
    esp="aes256-sha512-modp4096!"

# Connections
#<%# FIXME: this could be half as long if I figure out how to trim the tld from @domain to check 'if main_colos.include? ...' -%>
<% if @domain == 'eqiad.wmflabs' %>
<% cache_colos.each do |colo_type| -%>
<% cache_types.each do |cache_type| -%>
<% varnish_nodes(cache_type, colo_type).each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
<% end -%>
<%# -------------------------------------------------- -%>
<% elsif @domain == 'codfw.wmflabs' %>
<% cache_colos.each do |colo_type| -%>
<% cache_types.each do |cache_type| -%>
<% varnish_nodes(cache_type, colo_type).each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
<% end -%>
<%# -------------------------------------------------- -%>
<% elsif @domain == 'esams.wmnet' %>
<% main_colos.each do |colo_type| -%>
<% cache_types.each do |cache_type| -%>
<% varnish_nodes(cache_type, colo_type).each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
<% end -%>
<%# -------------------------------------------------- -%>
<% elsif @domain == 'ulsfo.wmnet' %>
<% main_colos.each do |colo_type| -%>
<% cache_types.each do |cache_type| -%>
<% varnish_nodes(cache_type, colo_type).each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
<% end -%>
<%# -------------------------------------------------- -%>
<% end -%>
