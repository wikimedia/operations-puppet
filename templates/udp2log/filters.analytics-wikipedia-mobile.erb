# Note: This file is managed by Puppet.

<%
# pull in $role::cache::configuration::active_nodes
# to find mobile host names and build a regex on which to grep.
cache_configuration = scope.lookupvar('::role::cache::configuration::active_nodes')
mobile_hosts_regex = '(' + cache_configuration['production']['mobile'].values.flatten.join('|') + ')'

-%>

# Note:  packet-loss is not debianize or puppetized.
# I have manually copied it into /usr/local/bin. - otto

# udp2log packet loss monitoring
pipe 10 /usr/bin/packet-loss 10 '\t' >> <%= packet_loss_log %>

# Produce logs into Kafka:

# pipe all requests from mobile frontend cache servers into kafka
pipe 1 /bin/grep -P '<%= mobile_hosts_regex %>' | /opt/kraken/bin/kafka-produce webrequest-wikipedia-mobile 9951 > /dev/null