# Note: This file is managed by Puppet.

<%
# pull in $role::cache::configuration::active_nodes
# to find mobile host names and build a regex on which to grep.
cache_configuration = scope.lookupvar('::role::cache::configuration::active_nodes')
mobile_hosts_regex = '(' + cache_configuration['production']['mobile'].values.flatten.join('|') + ')'

-%>

# udp2log packet loss monitoring
pipe 10 /usr/bin/packet-loss 10 '\t' >> <%= packet_loss_log %>

# Produce logs into Kafka:

# pipe all requests from mobile frontend cache servers into kafka
pipe 1 /bin/grep -P '<%= mobile_hosts_regex %>' | /usr/bin/udp-filter -F '\t' --geocode --bird=country --anonymize='<%= scope.lookupvar('::passwords::analytics::libanon_salt') %>' | /opt/kraken/bin/kafka-produce webrequest-mobile 9951 > /dev/null