###
####    This file managed by puppet.
###

### udp2log packet loss monitoring
pipe 10 /usr/bin/packet-loss 10 '\t' >> /var/log/udp2log/packet-loss.log

### Capture all logs with 'zero=' set.  The X-Analytics header is set with this
# by mobile varnish frontends upon getting a Wikipedia Zero request.
#
# This filter has been migrated to Hive. It's output is available on
# stat1002 at /a/log/webrequest/archive/zero
pipe 1 /bin/grep -P 'zero=\d' >> <%= log_directory %>/zero.tsv.log

### All edits
# This filter has been migrated to Hive. It's output is available on
# stat1002 at /a/log/webrequest/archive/edits
pipe 1 /usr/bin/udp-filter -F '\t' -p action=submit,action=edit >> <%= log_directory %>/edits.tsv.log

<%
# find mobile host names and build a regex on which to grep.
cache_nodes_mobile = scope.lookupvar('::cache::nodes::mobile')
mobile_hosts_regex = '(' + cache_nodes_mobile.values.flatten.sort.join('|') + ')'
-%>

### Mobile traffic filter
# All mobile traffic goes through CC-cp1044 varnish hosts.
#
# This filter has been migrated to Hive. It's output is available on
# stat1002 at /a/log/webrequest/archive/mobile
pipe 100 /bin/grep -P '<%= mobile_hosts_regex %>' >> <%= log_directory %>/mobile-sampled-100.tsv.log

### All 5xx error responses -- domas (now using udp-filter instead of 5xx-filter).
# pipe 1 <%= @template_variables['webrequest_filter_directory'] %>/5xx-filter | awk -W interactive '$9 !~ "upload.wikimedia.org"' >> <%= log_directory %>/5xx.tsv.log
#
# This filter has been migrated to Hive. It's output is available on
# stat1002 at /a/log/webrequest/archive/5xx
pipe 1 /usr/bin/udp-filter -F '\t' -r -s '^5' | awk -W interactive '$9 !~ "upload.wikimedia.org"' >> <%= log_directory %>/5xx.tsv.log
