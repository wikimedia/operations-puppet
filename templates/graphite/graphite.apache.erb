# Apache configuration for graphite.wikimedia.org
# This file is managed by Puppet.
<VirtualHost *:80>
    ServerName <%= @hostname %>

    <Location />
        Order allow,deny
        Allow from all

<%= @apache_auth -%>

        # uWSGI reverse-proxy
        uWSGIsocket /run/uwsgi/graphite-web.sock
        uWSGIForceWSGIScheme https
        SetHandler uwsgi-handler
    </Location>

    RewriteEngine on
    RewriteMap graphite_referer_ban "txt:/etc/apache2/graphite-referer-ban"

    RewriteCond "%{HTTP_REFERER}" !=""
    RewriteCond "${graphite_referer_ban:%{HTTP_REFERER}}" =-
    RewriteRule "^" "" [F]

    <Location ~ "/(render|metrics)">
        Satisfy Any
        Allow from all
    </Location>

</VirtualHost>
