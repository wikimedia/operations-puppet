# Apache configuration for graphite.wikimedia.org
# This file is managed by Puppet.
<VirtualHost *:80>
    ServerName <%= @hostname %>
    ServerAdmin noc@wikimedia.org

    RewriteEngine on
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteCond %{REQUEST_URI} !^/status$
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
    Header always merge Vary X-Forwarded-Proto env=ProtoRedirect
    Header set Strict-Transport-Security "max-age=604800"

    <Location />
        Order allow,deny
        Allow from all

<%= @apache_auth -%>

        # uWSGI reverse-proxy
        uWSGIsocket /run/uwsgi/graphite-web.sock
        SetHandler uwsgi-handler
    </Location>

    <Location ~ "/(render|metrics)">
        Satisfy Any
        Allow from all
    </Location>

</VirtualHost>
