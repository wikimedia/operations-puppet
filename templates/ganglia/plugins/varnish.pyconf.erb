modules {
	module {
		name = "varnish"
		language = "python"
		path = "varnish.py"
		
		param instances {
			value = "<%= varnish_instances.join(',') %>"
		}
	}
}

<% varnish_instances.each do |instance|
prefix = (instance.empty? ? "" : instance + '.')
-%>

collection_group {
	collect_every = 15
	time_threshold = 15

	metric {
		name = '<%= prefix %>shm_writes'
		title = 'SHM writes'
	}

	metric {
		name = '<%= prefix %>s_pass'
		title = 'Total pass'
	}

	metric {
		name = '<%= prefix %>backend_conn'
		title = 'Backend conn. success'
	}

	metric {
		name = '<%= prefix %>n_vbc'
		title = 'N struct vbc'
	}

	metric {
		name = '<%= prefix %>fetch_chunked'
		title = 'Fetch chunked'
	}

	metric {
		name = '<%= prefix %>fetch_204'
		title = 'Fetch no body (204)'
	}

	metric {
		name = '<%= prefix %>n_wrk_max'
		title = 'N worker threads limited'
	}

	metric {
		name = '<%= prefix %>n_vampireobject'
		title = 'N unresurrected objects'
	}

	metric {
		name = '<%= prefix %>n_vcl'
		title = 'N vcl total'
	}

	metric {
		name = '<%= prefix %>esi_errors'
		title = 'ESI parse errors (unlock)'
	}

	metric {
		name = '<%= prefix %>n_vcl_avail'
		title = 'N vcl available'
	}

	metric {
		name = '<%= prefix %>n_ban_add'
		title = 'N new bans added'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.g_alloc'
		title = 'Allocations outstanding'
	}

	metric {
		name = '<%= prefix %>dir_dns_hit'
		title = 'DNS director cached lookups hit'
	}

	metric {
		name = '<%= prefix %>s_fetch'
		title = 'Total fetch'
	}

	metric {
		name = '<%= prefix %>client_drop_late'
		title = 'Connection dropped late'
	}

	metric {
		name = '<%= prefix %>n_objecthead'
		title = 'N struct objecthead'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.c_bytes'
		title = 'Bytes allocated'
	}

	metric {
		name = '<%= prefix %>fetch_bad'
		title = 'Fetch had bad headers'
	}

	metric {
		name = '<%= prefix %>backend_fail'
		title = 'Backend conn. failures'
	}

	metric {
		name = '<%= prefix %>s_pipe'
		title = 'Total pipe'
	}

	metric {
		name = '<%= prefix %>backend_unhealthy'
		title = 'Backend conn. not attempted'
	}

	metric {
		name = '<%= prefix %>n_ban'
		title = 'N total active bans'
	}

	metric {
		name = '<%= prefix %>fetch_length'
		title = 'Fetch with Length'
	}

	metric {
		name = '<%= prefix %>n_vcl_discard'
		title = 'N vcl discarded'
	}

	metric {
		name = '<%= prefix %>backend_recycle'
		title = 'Backend conn. recycles'
	}

	metric {
		name = '<%= prefix %>n_wrk_lqueue'
		title = 'work request queue length'
	}

	metric {
		name = '<%= prefix %>shm_flushes'
		title = 'SHM flushes due to overflow'
	}

	metric {
		name = '<%= prefix %>fetch_304'
		title = 'Fetch no body (304)'
	}

	metric {
		name = '<%= prefix %>backend_req'
		title = 'Backend requests made'
	}

	metric {
		name = '<%= prefix %>hcb_insert'
		title = 'HCB Inserts'
	}

	metric {
		name = '<%= prefix %>n_backend'
		title = 'N backends'
	}

	metric {
		name = '<%= prefix %>n_gzip'
		title = 'Gzip operations'
	}

	metric {
		name = '<%= prefix %>n_ban_retire'
		title = 'N old bans deleted'
	}

	metric {
		name = '<%= prefix %>s_sess'
		title = 'Total Sessions'
	}

	metric {
		name = '<%= prefix %>client_req'
		title = 'Client requests received'
	}

	metric {
		name = '<%= prefix %>s_bodybytes'
		title = 'Total body bytes'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.g_bytes'
		title = 'Bytes outstanding'
	}

	metric {
		name = '<%= prefix %>backend_reuse'
		title = 'Backend conn. reuses'
	}

	metric {
		name = '<%= prefix %>cache_hitpass'
		title = 'Cache hits for pass'
	}

	metric {
		name = '<%= prefix %>sess_closed'
		title = 'Session Closed'
	}

	metric {
		name = '<%= prefix %>sms_nobj'
		title = 'SMS outstanding allocations'
	}

	metric {
		name = '<%= prefix %>n_objwrite'
		title = 'Objects sent with write'
	}

	metric {
		name = '<%= prefix %>shm_records'
		title = 'SHM records'
	}

	metric {
		name = '<%= prefix %>n_wrk_create'
		title = 'N worker threads created'
	}

	metric {
		name = '<%= prefix %>backend_toolate'
		title = 'Backend conn. was closed'
	}

	metric {
		name = '<%= prefix %>sms_nreq'
		title = 'SMS allocator requests'
	}

	metric {
		name = '<%= prefix %>fetch_head'
		title = 'Fetch head'
	}

	metric {
		name = '<%= prefix %>accept_fail'
		title = 'Accept failures'
	}

	metric {
		name = '<%= prefix %>sess_linger'
		title = 'Session Linger'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.c_fail'
		title = 'Allocator failures'
	}

	metric {
		name = '<%= prefix %>dir_dns_failed'
		title = 'DNS director failed lookups'
	}

	metric {
		name = '<%= prefix %>n_ban_obj_test'
		title = 'N objects tested'
	}

	metric {
		name = '<%= prefix %>fetch_close'
		title = 'Fetch wanted close'
	}

	metric {
		name = '<%= prefix %>n_wrk'
		title = 'N worker threads'
	}

	metric {
		name = '<%= prefix %>client_conn'
		title = 'Client connections accepted'
	}

	metric {
		name = '<%= prefix %>n_wrk_queued'
		title = 'N queued work requests'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.g_space'
		title = 'Bytes available'
	}

	metric {
		name = '<%= prefix %>losthdr'
		title = 'HTTP header overflows'
	}

	metric {
		name = '<%= prefix %>fetch_eof'
		title = 'Fetch EOF'
	}

	metric {
		name = '<%= prefix %>n_lru_nuked'
		title = 'N LRU nuked objects'
	}

	metric {
		name = '<%= prefix %>shm_cycles'
		title = 'SHM cycles through buffer'
	}

	metric {
		name = '<%= prefix %>sess_herd'
		title = 'Session herd'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.c_freed'
		title = 'Bytes freed'
	}

	metric {
		name = '<%= prefix %>esi_warnings'
		title = 'ESI parse warnings (unlock)'
	}

	metric {
		name = '<%= prefix %>dir_dns_lookups'
		title = 'DNS director lookups'
	}

	metric {
		name = '<%= prefix %>cache_hit'
		title = 'Cache hits'
	}

	metric {
		name = '<%= prefix %>n_objoverflow'
		title = 'Objects overflowing workspace'
	}

	metric {
		name = '<%= prefix %>n_ban_re_test'
		title = 'N regexps tested against'
	}

	metric {
		name = '<%= prefix %>fetch_failed'
		title = 'Fetch failed'
	}

	metric {
		name = '<%= prefix %>n_lru_moved'
		title = 'N LRU moved objects'
	}

	metric {
		name = '<%= prefix %>n_object'
		title = 'N struct object'
	}

	metric {
		name = '<%= prefix %>shm_cont'
		title = 'SHM MTX contention'
	}

	metric {
		name = '<%= prefix %>n_gunzip'
		title = 'Gunzip operations'
	}

	metric {
		name = '<%= prefix %>n_wrk_failed'
		title = 'N worker threads not created'
	}

	metric {
		name = '<%= prefix %>uptime'
		title = 'Client uptime'
	}

	metric {
		name = '<%= prefix %>client_drop'
		title = 'Connection dropped, no sess/wrk'
	}

	metric {
		name = '<%= prefix %>n_sess'
		title = 'N struct sess'
	}

	metric {
		name = '<%= prefix %>sess_readahead'
		title = 'Session Read Ahead'
	}

	metric {
		name = '<%= prefix %>fetch_zero'
		title = 'Fetch zero len'
	}

	metric {
		name = '<%= prefix %>cache_miss'
		title = 'Cache misses'
	}

	metric {
		name = '<%= prefix %>hcb_lock'
		title = 'HCB Lookups with lock'
	}

	metric {
		name = '<%= prefix %>n_objsendfile'
		title = 'Objects sent with sendfile'
	}

	metric {
		name = '<%= prefix %>s_req'
		title = 'Total Requests'
	}

	metric {
		name = '<%= prefix %>backend_retry'
		title = 'Backend conn. retry'
	}

	metric {
		name = '<%= prefix %>SMA.Transient.c_req'
		title = 'Allocator requests'
	}

	metric {
		name = '<%= prefix %>sms_balloc'
		title = 'SMS bytes allocated'
	}

	metric {
		name = '<%= prefix %>n_wrk_drop'
		title = 'N dropped work requests'
	}

	metric {
		name = '<%= prefix %>sess_pipeline'
		title = 'Session Pipeline'
	}

	metric {
		name = '<%= prefix %>n_waitinglist'
		title = 'N struct waitinglist'
	}

	metric {
		name = '<%= prefix %>dir_dns_cache_full'
		title = 'DNS director full dnscache'
	}

	metric {
		name = '<%= prefix %>sms_bfree'
		title = 'SMS bytes freed'
	}

	metric {
		name = '<%= prefix %>hcb_nolock'
		title = 'HCB Lookups without lock'
	}

	metric {
		name = '<%= prefix %>vmods'
		title = 'Loaded VMODs'
	}

	metric {
		name = '<%= prefix %>fetch_oldhttp'
		title = 'Fetch pre HTTP/1.1 closed'
	}

	metric {
		name = '<%= prefix %>sms_nbytes'
		title = 'SMS outstanding bytes'
	}

	metric {
		name = '<%= prefix %>backend_busy'
		title = 'Backend conn. too many'
	}

	metric {
		name = '<%= prefix %>n_ban_dups'
		title = 'N duplicate bans removed'
	}

	metric {
		name = '<%= prefix %>n_objectcore'
		title = 'N struct objectcore'
	}

	metric {
		name = '<%= prefix %>s_hdrbytes'
		title = 'Total header bytes'
	}

	metric {
		name = '<%= prefix %>n_sess_mem'
		title = 'N struct sess_mem'
	}

	metric {
		name = '<%= prefix %>fetch_1xx'
		title = 'Fetch no body (1xx)'
	}

	metric {
		name = '<%= prefix %>n_expired'
		title = 'N expired objects'
	}
}
<% end -%>
