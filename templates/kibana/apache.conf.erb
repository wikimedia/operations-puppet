# vim: sw=2 ts=2 sts=2 et ft=apache
#####################################################################
### THIS FILE IS MANAGED BY PUPPET
### puppet:///modules/kibana/apache.conf
#####################################################################

<VirtualHost *:80>
  ServerName <%= @vhost %>
  ServerAdmin <%= @serveradmin %>

  DocumentRoot /dev/null

  RewriteEngine on
<%- if @require_ssl -%>
  RewriteCond %{HTTP:X-Forwarded-Proto} !https
  RewriteCond %{REQUEST_URI} !^/status$
  RewriteRule ^/(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,E=ProtoRedirect]
  Header always merge Vary X-Forwarded-Proto env=ProtoRedirect
<%- end -%>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
    <IfVersion >= 2.4>
      Require all denied
    </IfVersion>
    <IfVersion < 2.4>
      Order Allow,Deny
      Deny from all
    </IfVersion>
  </Directory>

  <Location />
<%= @apache_auth -%>
  </Location>

  ProxyRequests Off

  <Proxy http://localhost:5601>
    ProxySet connectiontimeout=5 timeout=90 retry=0
  </Proxy>

  # Tell caches that we are using http authentication
  Header set Vary Authorization

  # Expose the status api without authenticating
  # Due to varnish frontend, all requests are seen by Apache as being internal
  # so using IP ranges is not any more restrictive than "all"
  <Location /status>
    <IfVersion >= 2.4>
      Require all granted
    </IfVersion>
    <IfVersion < 2.4>
      Order Allow,Deny
      Allow from all
      Satisfy Any
    </IfVersion>
  </Location>

</VirtualHost>
