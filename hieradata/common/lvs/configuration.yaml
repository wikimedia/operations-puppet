lvs_service_ips:
  apaches: &id001
    codfw: 10.2.1.1
    eqiad: 10.2.2.1
  api: &id002
    codfw: 10.2.1.22
    eqiad: 10.2.2.22
  bits: &id003
    codfw:
      bitslb: 208.80.153.234
      bitslb6: 2620:0:860:ed1a::1:a
    eqiad:
      bitslb: 208.80.154.234
      bitslb6: 2620:0:861:ed1a::1:a
      bitssvc: 10.2.2.23
    esams:
      bitslb: 91.198.174.202
      bitslb6: 2620:0:862:ed1a::1:a
      bitssvc: 10.2.3.23
    ulsfo:
      bitslb: 198.35.26.106
      bitslb6: 2620:0:863:ed1a::1:a
      bitssvc: 10.2.4.23
  citoid: &id004
    eqiad: 10.2.2.19
  cxserver: &id005
    eqiad: 10.2.2.18
  dns_rec: &id006
    codfw:
      dns_rec: 208.80.153.254
      dns_rec6: 2620:0:860:ed1a::3:fe
    eqiad:
      dns_rec: 208.80.154.239
      dns_rec6: 2620:0:861:ed1a::3:fe
    esams:
      dns_rec: 91.198.174.216
      dns_rec6: 2620:0:862:ed1a::3:fe
  graphoid: &id007
    eqiad: 10.2.2.15
  kartotherian: &id008
    codfw: 10.2.1.13
  mathoid: &id009
    eqiad: 10.2.2.20
  misc_web: &id010
    eqiad:
      misc_weblb: 208.80.154.241
      misc_weblb6: 2620:0:861:ed1a::11
  mobile: &id011
    codfw:
      mobilelb: 208.80.153.236
      mobilelb6: 2620:0:860:ed1a::1:c
    eqiad:
      mobilelb: 208.80.154.236
      mobilelb6: 2620:0:861:ed1a::1:c
      mobilesvc: 10.2.2.26
    esams:
      mobilelb: 91.198.174.204
      mobilelb6: 2620:0:862:ed1a::1:c
      mobilesvc: 10.2.3.26
    ulsfo:
      mobilelb: 198.35.26.108
      mobilelb6: 2620:0:863:ed1a::1:c
      mobilesvc: 10.2.4.26
  mobileapps: &id012
    eqiad: 10.2.2.32
  ocg: &id013
    eqiad: 10.2.2.31
  osm: &id014
    eqiad: 208.80.154.244
  parsoid: &id015
    eqiad: 10.2.2.28
  parsoidcache: &id016
    eqiad:
      parsoidcachelb: 208.80.154.248
      parsoidcachelb6: 2620:0:861:ed1a::3:14
      parsoidsvc: 10.2.2.29
  rendering: &id017
    codfw: 10.2.1.21
    eqiad: 10.2.2.21
  restbase: &id018
    eqiad: 10.2.2.17
  search: &id019
    eqiad: 10.2.2.30
  stream: &id020
    eqiad:
      streamlb: 208.80.154.249
      streamlb6: 2620:0:861:ed1a::3:15
  swift: &id021
    codfw: 10.2.1.27
    eqiad: 10.2.2.27
  text: &id022
    codfw:
      textlb: 208.80.153.224
      textlb6: 2620:0:860:ed1a::1
    eqiad:
      textlb: 208.80.154.224
      textlb6: 2620:0:861:ed1a::1
      textsvc: 10.2.2.25
    esams:
      textlb: 91.198.174.192
      textlb6: 2620:0:862:ed1a::1
      textsvc: 10.2.3.25
    ulsfo:
      textlb: 198.35.26.96
      textlb6: 2620:0:863:ed1a::1
      textsvc: 10.2.4.25
  upload: &id023
    codfw:
      uploadlb: 208.80.153.240
      uploadlb6: 2620:0:860:ed1a::2:b
    eqiad:
      uploadlb: 208.80.154.240
      uploadlb6: 2620:0:861:ed1a::2:b
      uploadsvc: 10.2.2.24
    esams:
      uploadlb: 91.198.174.208
      uploadlb6: 2620:0:862:ed1a::2:b
      uploadsvc: 10.2.3.24
    ulsfo:
      uploadlb: 198.35.26.112
      uploadlb6: 2620:0:863:ed1a::2:b
      uploadsvc: 10.2.4.24
  zotero: &id024
    eqiad: 10.2.2.16
lvs_services:
  apaches:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: appserver
      service: apache2
    depool-threshold: '.9'
    description: Main MediaWiki application server cluster, appservers.svc.%{::site}.wmnet
    icinga:
      check_command: check_http_lvs!en.wikipedia.org!/wiki/Main_Page
      sites:
        eqiad:
          hostname: appservers.svc.eqiad.wmnet
    ip: *id001
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://en.wikipedia.org/wiki/Main_Page
      RunCommand:
        arguments: '[ ''/etc/pybal/runcommand/check-apache'', server.host ]'
        command: /bin/sh
        interval: 60
        timeout: 10
    sites:
    - eqiad
    - codfw
  api:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: api_appserver
      service: apache2
    depool-threshold: '.6'
    description: MediaWiki API cluster, api.svc.%{::site}.wmnet
    icinga:
      check_command: check_http_lvs!en.wikipedia.org!/w/api.php?action=query&meta=siteinfo
      sites:
        eqiad:
          hostname: api.svc.eqiad.wmnet
    ip: *id002
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://en.wikipedia.org/w/api.php
      RunCommand:
        arguments: '[ ''/etc/pybal/runcommand/check-apache'', server.host ]'
        command: /bin/sh
        interval: 60
        timeout: 10
    sites:
    - eqiad
    - codfw
  bits:
    bgp: 'yes'
    class: high-traffic1
    conftool:
      cluster: cache_bits
      service: varnish-fe
    depool-threshold: '.5'
    description: Site assets (CSS/JS) LVS service, bits.%{::site}.wikimedia.org
    icinga:
      sites:
        eqiad:
          hostname: bits-lb.eqiad.wikimedia.org
        esams:
          hostname: bits-lb.esams.wikimedia.org
        ulsfo:
          hostname: bits-lb.ulsfo.wikimedia.org
      uri: bits.wikimedia.org!/static-current/resources/assets/poweredby_mediawiki_88x31.png
    ip: *id003
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  bits-https:
    bgp: 'no'
    class: high-traffic1
    conftool:
      cluster: cache_bits
      service: nginx
    depool-threshold: '.5'
    description: Site assets (CSS/JS) LVS service, bits.%{::site}.wikimedia.org
    ip: *id003
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - https://bits.wikimedia.org/pybal-test-file
    port: 443
    scheduler: sh
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  citoid:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: citoid
    depool-threshold: '.5'
    description: Citation lookup service, citoid.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!citoid.svc.eqiad.wmnet!1970!/
      contact_group: admins,parsoid
      sites:
        eqiad:
          hostname: citoid.svc.eqiad.wmnet
    ip: *id004
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://citoid.svc.eqiad.wmnet
    port: 1970
    sites:
    - eqiad
  cxserver:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: cxserver
    depool-threshold: '.5'
    description: Content Translation service, cxserver.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!citoid.svc.eqiad.wmnet!8080!/
      sites:
        eqiad:
          hostname: cxserver.svc.eqiad.wmnet
    ip: *id005
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://cxserver.svc.eqiad.wmnet
    port: 8080
    sites:
    - eqiad
  dns_rec:
    bgp: 'no'
    class: high-traffic2
    conftool:
      cluster: dns
      service: pdns_recursor
    depool-threshold: '.5'
    description: Recursive DNS - TCP
    ip: *id006
    monitors:
      DNSQuery:
        fail-on-nxdomain: 'no'
        hostnames:
        - en.wikipedia.org
        - www.google.com
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 53
    protocol: tcp
    sites:
    - eqiad
    - codfw
    - esams
  dns_rec_udp:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: dns
      service: pdns_recursor
    depool-threshold: '.5'
    description: Recursive DNS - UDP
    ip: *id006
    monitors:
      DNSQuery:
        fail-on-nxdomain: 'no'
        hostnames:
        - en.wikipedia.org
        - www.google.com
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 53
    protocol: udp
    sites:
    - eqiad
    - codfw
    - esams
  graphoid:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: graphoid
    depool-threshold: '.5'
    description: Graph-rendering service, graphoid.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!graphoid.svc.eqiad.wmnet!19000!/_info
      contact_group: admins,parsoid
      sites:
        eqiad:
          hostname: graphoid.svc.eqiad.wmnet
    ip: *id007
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://graphoid.svc.eqiad.wmnet/_info
    port: 19000
    sites:
    - eqiad
  kartotherian:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: maps
      service: kartotherian
    depool-threshold: '.5'
    description: Kartotherian, kartotherian.svc.codfw.wmnet
    ip: *id008
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 4000
    sites:
    - codfw
  mathoid:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: mathoid
    depool-threshold: '.5'
    description: Mathematical rendering service, mathoid.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!mathoid.svc.eqiad.wmnet!10042!/_info
      sites:
        eqiad:
          hostname: mathoid.svc.eqiad.wmnet
    ip: *id009
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://mathoid.svc.eqiad.wmnet/_info
    port: 10042
    sites:
    - eqiad
  misc_web:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: cache_misc
      service: varnish-fe
    depool-threshold: '.5'
    description: Miscellaneous web sites Varnish cluster
    icinga:
      sites:
        eqiad:
          hostname: misc-web-lb.eqiad.wikimedia.org
      uri: varnishcheck!/
    ip: *id010
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites:
    - eqiad
  misc_web-https:
    bgp: 'no'
    class: high-traffic2
    conftool:
      cluster: cache_misc
      service: nginx
    depool-threshold: '.5'
    description: Miscellaneous web sites Varnish cluster (HTTPS)
    ip: *id010
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 443
    scheduler: sh
    sites:
    - eqiad
  mobile:
    bgp: 'yes'
    class: high-traffic1
    conftool:
      cluster: cache_mobile
      service: varnish-fe
    depool-threshold: '.6'
    description: MediaWiki based mobile site
    icinga:
      sites:
        eqiad:
          hostname: mobile-lb.eqiad.wikimedia.org
        esams:
          hostname: mobile-lb.esams.wikimedia.org
        ulsfo:
          hostname: mobile-lb.ulsfo.wikimedia.org
      uri: en.m.wikipedia.org!/wiki/Main_Page
    ip: *id011
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  mobile-https:
    bgp: 'no'
    class: high-traffic1
    conftool:
      cluster: cache_mobile
      service: nginx
    depool-threshold: '.6'
    description: MediaWiki based mobile site
    ip: *id011
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - https://en.m.wikipedia.org/wiki/Angelsberg
    port: 443
    scheduler: sh
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  mobileapps:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: mobileapps
    depool-threshold: '.5'
    description: Mashup service used by the mobile apps
    icinga:
      check_command: check_http_zotero_lvs_on_port!zotero.svc.eqiad.wmnet!1969!/export?format=wikipedia
      sites:
        eqiad:
          hostname: mobileapps.svc.eqiad.wmnet
    ip: *id012
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: '7000'
    sites:
    - eqiad
  ocg:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: pdf
      service: ocg
    depool-threshold: '.5'
    description: Offline Content Generator (e.g. PDF), ocg.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!ocg.svc.eqiad.wmnet!8000!/?command=health
      sites:
        eqiad:
          hostname: ocg.svc.eqiad.wmnet
    ip: *id013
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://ocg.svc.eqiad.wmnet/?command=health
    port: 8000
    sites:
    - eqiad
  osm:
    bgp: 'yes'
    class: high-traffic2
    conftool: {}
    depool-threshold: '.5'
    description: OpenStreetMap tiles
    ip: *id014
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites: []
  parsoid:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: parsoid
      service: parsoid
    depool-threshold: '.5'
    description: Parsoid wikitext parser for VisualEditor
    icinga:
      check_command: check_http_on_port!8000
      contact_group: admins,parsoid
      sites:
        eqiad:
          hostname: parsoid.svc.eqiad.wmnet
    ip: *id015
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost:8000/
    port: 8000
    sites:
    - eqiad
  parsoidcache:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: cache_parsoid
      service: varnish-fe
    depool-threshold: '.5'
    description: Varnish caches in front of Parsoid
    icinga:
      check_command: check_http_on_port!80
      contact_group: admins,parsoid
      sites:
        eqiad:
          hostname: parsoid-lb.eqiad.wikimedia.org
    ip: *id016
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost
    port: 80
    sites:
    - eqiad
  parsoidcache-https:
    bgp: 'no'
    class: high-traffic2
    conftool:
      cluster: cache_parsoid
      service: nginx
    depool-threshold: '.5'
    description: nginx HTTPS terminators for Parsoid
    ip: *id016
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 443
    scheduler: sh
    sites:
    - eqiad
  rendering:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: imagescaler
      service: apache2
    depool-threshold: '.74'
    description: MediaWiki thumbnail rendering cluster, rendering.svc.%{::site}.wmnet
    icinga:
      check_command: check_http_lvs!en.wikipedia.org!/wiki/Main_Page
      sites:
        eqiad:
          hostname: rendering.svc.eqiad.wmnet
    ip: *id017
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://en.wikipedia.org/favicon.ico
      RunCommand:
        arguments: '[ ''/etc/pybal/runcommand/check-apache'', server.host ]'
        command: /bin/sh
        interval: 60
        timeout: 10
    sites:
    - eqiad
    - codfw
  restbase:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: restbase
      service: restbase
    depool-threshold: '.5'
    description: RESTBase, restbase.svc.eqiad.wmnet
    icinga:
      check_command: check_http_lvs_on_port!restbase.svc.eqiad.wmnet!7231!/
      sites:
        eqiad:
          hostname: restbase.svc.eqiad.wmnet
    ip: *id018
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://restbase.svc.eqiad.wmnet
    port: 7231
    sites:
    - eqiad
  search:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: elasticsearch
      service: elasticsearch
    depool-threshold: '.5'
    description: Elasticsearch search for MediaWiki
    icinga:
      check_command: check_http_on_port!9200
      sites:
        eqiad:
          hostname: search.svc.eqiad.wmnet
    ip: *id019
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost:9200/
    port: 9200
    sites:
    - eqiad
  stream:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: rcstream
      service: nginx
    depool-threshold: '.5'
    description: Websocket/streaming services
    ip: *id020
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost/rcstream_status
    port: 80
    scheduler: sh
    sites:
    - eqiad
  stream-https:
    bgp: 'no'
    class: high-traffic2
    conftool:
      cluster: rcstream
      service: nginx_ssl
    depool-threshold: '.5'
    description: Websocket/streaming services
    ip: *id020
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost/rcstream_status
    port: 443
    scheduler: sh
    sites:
    - eqiad
  swift:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: swift
      service: swift-fe
    depool-threshold: '.5'
    description: Swift/Ceph media storage
    icinga:
      check_command: check_http_lvs!ms-fe.eqiad.wmnet!/monitoring/backend
      sites:
        eqiad:
          hostname: ms-fe.eqiad.wmnet
    ip: *id021
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - http://localhost/monitoring/backend
    sites:
    - codfw
    - eqiad
  text:
    bgp: 'yes'
    class: high-traffic1
    conftool:
      cluster: cache_text
      service: varnish-fe
    depool-threshold: '.5'
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (Varnish)
    icinga:
      sites:
        eqiad:
          hostname: text-lb.eqiad.wikimedia.org
        esams:
          hostname: text-lb.esams.wikimedia.org
        ulsfo:
          hostname: text-lb.ulsfo.wikimedia.org
      uri: en.wikipedia.org!/wiki/Main_Page
    ip: *id022
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  text-https:
    bgp: 'no'
    class: high-traffic1
    conftool:
      cluster: cache_text
      service: nginx
    depool-threshold: '.5'
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (nginx)
    ip: *id022
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - https://en.wikipedia.org/wiki/Main_Page
    port: 443
    scheduler: sh
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  upload:
    bgp: 'yes'
    class: high-traffic2
    conftool:
      cluster: cache_upload
      service: varnish-fe
    depool-threshold: '.5'
    description: Images and other media, upload.%{::site}.wikimedia.org
    icinga:
      sites:
        eqiad:
          hostname: upload-lb.eqiad.wikimedia.org
        esams:
          hostname: upload-lb.esams.wikimedia.org
        ulsfo:
          hostname: upload-lb.ulsfo.wikimedia.org
      uri: upload.wikimedia.org!/monitoring/backend
    ip: *id023
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  upload-https:
    bgp: 'no'
    class: high-traffic2
    conftool:
      cluster: cache_upload
      service: nginx
    depool-threshold: '.5'
    description: Images and other media, upload.%{::site}.wikimedia.org
    ip: *id023
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
      ProxyFetch:
        url:
        - https://upload.wikimedia.org/monitoring/backend
    port: 443
    scheduler: sh
    sites:
    - codfw
    - eqiad
    - esams
    - ulsfo
  zotero:
    bgp: 'yes'
    class: low-traffic
    conftool:
      cluster: sca
      service: zotero
    depool-threshold: '.5'
    description: Zotero, zotero.svc.eqiad.wmnet
    icinga:
      check_command: check_http_zotero_lvs_on_port!zotero.svc.eqiad.wmnet!1969!/export?format=wikipedia
      sites:
        eqiad:
          hostname: zotero.svc.eqiad.wmnet
    ip: *id024
    monitors:
      IdleConnection:
        max-delay: 300
        timeout-clean-reconnect: 3
    port: 1969
    sites:
    - eqiad
