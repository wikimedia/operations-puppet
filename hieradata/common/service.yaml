# Service catalog.
# This entry includes all the information about the WMF internal and external services.
# Every entry in the hash must have a label (the service name) and its body must adhere to the
# Wmflib::Service type. Refer to the documentation of that type, and all the sub-types, for details.
#
# Please keep entries separated by an empty line to allow for easy navigation of the file.

service::catalog:
  apertium:
    description: Machine Translation service. apertium.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.11
      eqiad:
        default: 10.2.2.11
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /listPairs
    monitoring:
      check_command: check_https_lvs_on_port!apertium.discovery.wmnet!4737!/listPairs
      sites:
        codfw:
          hostname: apertium.svc.codfw.wmnet
        eqiad:
          hostname: apertium.svc.eqiad.wmnet
    port: 4737
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: apertium
        active_active: true

  api-https:
    description: MediaWiki API cluster, api.svc.%{::site}.wmnet
    encryption: true
    ip: &api_ips
      codfw:
        default: 10.2.1.22
      eqiad:
        default: 10.2.2.22
    lvs:
      class: low-traffic
      conftool:
        cluster: api_appserver
        service: nginx
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/w/api.php
      scheduler: wrr
    probes:
      - type: http
        path: /w/api.php?action=query&meta=siteinfo
        host: en.wikipedia.org
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/w/api.php?action=query&meta=siteinfo
      sites:
        codfw:
          hostname: api.svc.codfw.wmnet
        eqiad:
          hostname: api.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery: &api_discovery
      - dnsdisc: api-rw
        active_active: false
      - dnsdisc: api-ro
        active_active: true
    aliases:
      - "api"

  appservers-https:
    description:
      Main MediaWiki application server cluster, appservers.svc.%{::site}.wmnet
      (https)
    encryption: true
    ip:
      codfw:
        default: 10.2.1.1
      eqiad:
        default: 10.2.2.1
    lvs:
      class: low-traffic
      conftool:
        cluster: appserver
        service: nginx
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/wiki/Special:BlankPage
      scheduler: wrr
    probes:
      - type: http
        path: /wiki/Special:Blankpage
        host: en.wikipedia.org
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      sites:
        codfw:
          hostname: appservers.svc.codfw.wmnet
        eqiad:
          hostname: appservers.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery: &appservers-disc
      - dnsdisc: appservers-ro
        active_active: true
      - dnsdisc: appservers-rw
        active_active: false
    aliases:
      - "appservers"

  aqs:
    description: Analytics Query Service, aqs.svc.%{::site}.wmnet
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.12
    lvs:
      class: low-traffic
      conftool:
        cluster: aqs
        service: aqs
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_http_lvs_on_port!aqs.svc.eqiad.wmnet!7232!/
      sites:
        eqiad:
          hostname: aqs.svc.eqiad.wmnet
    port: 7232
    sites:
      - eqiad
    state: production

  blubberoid:
    description: Blubberoid, blubberoid.svc.%{::site}.wmnet (https)
    encryption: true
    ip:
      codfw:
        default: 10.2.1.31
      eqiad:
        default: 10.2.2.31
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /?spec
    monitoring:
      check_command: check_https_port_status!4666!200!/?spec
      sites:
        codfw:
          hostname: blubberoid.svc.codfw.wmnet
        eqiad:
          hostname: blubberoid.svc.eqiad.wmnet
    port: 4666
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: blubberoid
        active_active: true

  citoid:
    description: Citation lookup service, citoid.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.19
      eqiad:
        default: 10.2.2.19
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!citoid.discovery.wmnet!4003!/_info
      contact_group: admins,parsoid
      sites:
        codfw:
          hostname: citoid.svc.codfw.wmnet
        eqiad:
          hostname: citoid.svc.eqiad.wmnet
    port: 4003
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: citoid
        active_active: true

  cloudelastic-chi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: &id004
        cloudelasticlb: 208.80.154.241
        cloudelasticlb6: 2620:0:861:ed1a::3:241
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9243
    sites:
      - eqiad
    state: production

  cloudelastic-chi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8243
    sites:
      - eqiad
    state: production

  cloudelastic-omega-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9443
    sites:
      - eqiad
    state: production

  cloudelastic-omega-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Public
      Internet Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8443
    sites:
      - eqiad
    state: production

  cloudelastic-psi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9643
    sites:
      - eqiad
    state: production

  cloudelastic-psi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8643
    sites:
      - eqiad
    state: production

  cxserver:
    description: Content Translation service, cxserver.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.18
      eqiad:
        default: 10.2.2.18
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!cxserver.discovery.wmnet!4002!/_info
      sites:
        codfw:
          hostname: cxserver.svc.codfw.wmnet
        eqiad:
          hostname: cxserver.svc.eqiad.wmnet
    port: 4002
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: cxserver
        active_active: true

  datahubsearch:
    description: Search cluster serving DataHub
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.71
    lvs:
      class: low-traffic
      conftool:
        cluster: datahubsearch
        service: opensearch
      depool_threshold: ".5"
      enabled: false
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_http_url_for_regexp_on_port!datahubsearch.svc.eqiad.wmnet!9200!/_cluster/health!"status":"green"
      sites:
        eqiad:
          hostname: datahubsearch.svc.eqiad.wmnet
    port: 9200
    sites:
      - eqiad
    state: production
    page: false

  docker-registry:
    description: docker registry service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.44
      eqiad:
        default: 10.2.2.44
    lvs:
      class: low-traffic
      conftool:
        cluster: docker-registry
        service: docker-registry
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /v2/
    monitoring:
      check_command: check_https_url!docker-registry.discovery.wmnet!/v2/
      sites:
        codfw:
          hostname: docker-registry.svc.codfw.wmnet
        eqiad:
          hostname: docker-registry.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: docker-registry
        active_active: false

  druid-public-broker:
    description: Broker query service for the Druid Public Cluster
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.38
    lvs:
      class: low-traffic
      conftool:
        cluster: druid-public
        service: druid-public-broker
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/status
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /status
    monitoring:
      check_command: check_http_lvs_on_port!druid-public-broker.svc.eqiad.wmnet!8082!/status
      sites:
        eqiad:
          hostname: druid-public-broker.svc.eqiad.wmnet
    port: 8082
    sites:
      - eqiad
    state: production

  echostore:
    description: Echo store, echostore.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.49
      eqiad:
        default: 10.2.2.49
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_port_status!8082!200!/healthz
      sites:
        codfw:
          hostname: echostore.svc.codfw.wmnet
        eqiad:
          hostname: echostore.svc.eqiad.wmnet
    port: 8082
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: echostore
        active_active: true

  eventgate-analytics:
    description: EventGate Analytics endpoint, TLS enabled. https://eventgate-analytics.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.42
      eqiad:
        default: 10.2.2.42
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-analytics.discovery.wmnet!4592!/_info
      sites:
        codfw:
          hostname: eventgate-analytics.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-analytics.svc.eqiad.wmnet
    port: 4592
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics
        active_active: true

  eventgate-logging-external:
    description: EventGate logging endpoint, eventgate-logging-external.svc.%{::site}.wmnet and intake-logging.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.50
      eqiad:
        default: 10.2.2.50
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-logging-external.discovery.wmnet!4392!/_info
      sites:
        codfw:
          hostname: eventgate-logging-external.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-logging-external.svc.eqiad.wmnet
    port: 4392
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-logging-external
        active_active: true

  eventgate-analytics-external:
    description: EventGate analytics external endpoint, eventgate-analytics-external.svc.%{::site}.wmnet and intake-analytics.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.52
      eqiad:
        default: 10.2.2.52
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-analytics-external.discovery.wmnet!4692!/_info
      sites:
        codfw:
          hostname: eventgate-analytics-external.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-analytics-external.svc.eqiad.wmnet
    port: 4692
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics-external
        active_active: true

  eventgate-main:
    description: EventGate main endpoint, TLS enabled, https://eventgate-main.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.45
      eqiad:
        default: 10.2.2.45
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-main.discovery.wmnet!4492!/_info
      sites:
        codfw:
          hostname: eventgate-main.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-main.svc.eqiad.wmnet
    port: 4492
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-main
        active_active: true

  eventstreams:
    description: Public streams of events via HTTP + SSE, backed by Kafka. eventstreams.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.34
      eqiad:
        default: 10.2.2.34
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventstreams.discovery.wmnet!4892!/_info
      sites:
        codfw:
          hostname: eventstreams.svc.codfw.wmnet
        eqiad:
          hostname: eventstreams.svc.eqiad.wmnet
    port: 4892
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams
        active_active: true

  eventstreams-internal:
    description: Internal streams of events via HTTP + SSE, backed by Kafka. eventstreams-internal.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.35
      eqiad:
        default: 10.2.2.35
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!eventstreams-internal.discovery.wmnet!4992!/_info
      sites:
        codfw:
          hostname: eventstreams-internal.svc.codfw.wmnet
        eqiad:
          hostname: eventstreams-internal.svc.eqiad.wmnet
    port: 4992
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams-internal
        active_active: true

  git-ssh:
    description: Git - to Phabricator hosting, git-ssh.wikimedia.org
    encryption: true
    ip:
      codfw:
        git-ssh4: 208.80.153.250
        git-ssh6: 2620:0:860:ed1a::3:fa
      eqiad:
        git-ssh4: 208.80.154.250
        git-ssh6: 2620:0:861:ed1a::3:16
    lvs:
      class: high-traffic2
      conftool:
        cluster: phabricator
        service: git-ssh
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 22
    sites:
      - eqiad
      - codfw
    state: production

  jobrunner:
    description: JobRunner LVS interface (https). jobrunner.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.26
      eqiad:
        default: 10.2.2.26
    lvs:
      class: low-traffic
      conftool:
        cluster: jobrunner
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php
      scheduler: wrr
    probes:
      - type: http
        path: /w/health-check.php
    monitoring:
      check_command: check_https_url!jobrunner.discovery.wmnet!/w/health-check.php
      sites:
        codfw:
          hostname: jobrunner.svc.codfw.wmnet
        eqiad:
          hostname: jobrunner.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: jobrunner
        active_active: false

  k8s-ingress-staging:
    description: istio-ingresscontroller on kubernetes staging. k8s-ingress-staging.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.69
      eqiad:
        default: 10.2.2.69
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes-staging
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    monitoring:
      check_command: check_tcp!30443
      sites:
        eqiad:
          hostname: k8s-ingress-staging.svc.eqiad.wmnet
        codfw:
          hostname: k8s-ingress-staging.svc.codfw.wmnet
    port: 30443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-staging
        active_active: false

  k8s-ingress-wikikube:
    description: istio-ingresscontroller on kubernetes. k8s-ingress-wikikube.svc.%{::site}.wmnet
    encryption: true
    ip: &k8s-ingress-wikikube_ips
      codfw:
        default: 10.2.1.70
      eqiad:
        default: 10.2.2.70
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: true
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    monitoring:
      check_command: check_tcp!30443
      sites:
        eqiad:
          hostname: k8s-ingress-wikikube.svc.eqiad.wmnet
        codfw:
          hostname: k8s-ingress-wikikube.svc.codfw.wmnet
    port: &k8s-ingress-wikikube_port 30443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-wikikube-ro
        active_active: true
      - dnsdisc: k8s-ingress-wikikube-rw
        active_active: false

  kartotherian:
    description: Kartotherian, kartotherian.svc.%{::site}.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    monitoring:
      check_command: check_http_lvs_on_port!kartotherian.discovery.wmnet!6533!/osm-intl/6/23/24.png
      sites:
        codfw:
          hostname: kartotherian.svc.codfw.wmnet
        eqiad:
          hostname: kartotherian.svc.eqiad.wmnet
    port: 6533
    sites:
      - codfw
      - eqiad
    state: production

  kartotherian-ssl:
    description: Kartotherian, kartotherian.svc.%{::site}.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /osm-intl/6/23/24.png
    monitoring:
      check_command: check_https_url!kartotherian.discovery.wmnet!/osm-intl/6/23/24.png
      sites:
        codfw:
          hostname: kartotherian.svc.codfw.wmnet
        eqiad:
          hostname: kartotherian.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: kartotherian
        active_active: true

  kibana7:
    description: Kibana v7 env - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.48
      eqiad:
        default: 10.2.2.48
    lvs:
      class: low-traffic
      conftool:
        cluster: kibana7
        service: kibana7
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/api/status
      scheduler: sh
    probes:
      - type: http
        path: /api/status
        host: logstash.wikimedia.org
    monitoring:
      check_command: check_https_url!logstash.wikimedia.org!/api/status
      sites:
        codfw:
          hostname: kibana7.svc.codfw.wmnet
        eqiad:
          hostname: kibana7.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    role: "logstash7"
    public_endpoint: "logstash"

  kubemaster:
    description: Kubernetes master service. kubemaster.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.8
      eqiad:
        default: 10.2.2.8
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    state: production

  labweb:
    description: "lvs for labweb services: horizon, striker, wikitech"
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.40
    lvs:
      class: low-traffic
      conftool:
        cluster: labweb
        service: labweb
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 301
          url:
            - http://localhost
      scheduler: wrr
    page: false
    monitoring:
      check_command: check_http_on_port!80
      sites:
        eqiad:
          hostname: labweb.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
    state: production

  labweb-ssl:
    description: "lvs for labweb services: horizon, striker, wikitech - HTTPS"
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.40
    lvs:
      class: low-traffic
      conftool:
        cluster: labweb
        service: labweb-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 301
          url:
            - https://wikitech.wikimedia.org:7443
      scheduler: wrr
    probes:
      - type: http
        expect_redirect: true
    port: 7443
    sites:
      - eqiad
    state: production
    aliases:
      - "labweb"

  ldap-ro:
    description: Ldap for cloud and developer accounts
    encryption: false
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 389
    probes:
      - type: tcp
    sites:
      - codfw
      - eqiad
    state: production

  ldap-ro-ssl:
    description: Ldap for cloud and developer accounts (ssl access)
    encryption: true
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 636
    probes:
      - type: tcp
    sites:
      - codfw
      - eqiad
    state: production

  mathoid:
    description: Mathematical rendering service, mathoid.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.20
      eqiad:
        default: 10.2.2.20
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!mathoid.discovery.wmnet!4001!/_info
      sites:
        codfw:
          hostname: mathoid.svc.codfw.wmnet
        eqiad:
          hostname: mathoid.svc.eqiad.wmnet
    port: 4001
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mathoid
        active_active: true

  miscweb:
    description: Misc static sites, miscweb.svc.%{::site}.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  ml-ctrl:
    description: Kubernetes master service for ML cluster. ml-ctrl.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.39
      eqiad:
        default: 10.2.2.39
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    state: lvs_setup

  ml-staging-ctrl:
    description: Kubernetes master service for ML staging cluster. ml-staging-ctrl.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.72
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_staging
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - codfw
    state: lvs_setup

  mobileapps:
    description:
      A service for use by mobile apps. Provides DOM manipulation, aggregation,
      JSON flattening. mobileapps.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.14
      eqiad:
        default: 10.2.2.14
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!mobileapps.discovery.wmnet!4102!/_info
      contact_group: mobileapps
      sites:
        codfw:
          hostname: mobileapps.svc.codfw.wmnet
        eqiad:
          hostname: mobileapps.svc.eqiad.wmnet
    port: 4102
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mobileapps
        active_active: true

  mwdebug:
    description: mwdebug, mwdebug.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.59
      eqiad:
        default: 10.2.2.59
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    monitoring:
      check_command: check_https_lvs_on_port!en.wikipedia.org!4444!/wiki/Special:BlankPage
      sites:
        codfw:
          hostname: mwdebug.svc.codfw.wmnet
        eqiad:
          hostname: mwdebug.svc.eqiad.wmnet
    port: 4444
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mwdebug
        active_active: true

  ncredir:
    description: Non canonical domains redirect service
    encryption: false
    ip: &id005
      codfw:
        ncredirlb: 208.80.153.232
        ncredirlb6: 2620:0:860:ed1a::9
      eqiad:
        ncredirlb: 208.80.154.232
        ncredirlb6: 2620:0:861:ed1a::9
      esams:
        ncredirlb: 91.198.174.194
        ncredirlb6: 2620:0:862:ed1a::3
      ulsfo:
        ncredirlb: 198.35.26.98
        ncredirlb6: 2620:0:863:ed1a::3
      eqsin:
        ncredirlb: 103.102.166.226
        ncredirlb6: 2001:df2:e500:ed1a::3
      drmrs:
        ncredirlb: 185.15.58.226
        ncredirlb6: 2a02:ec80:600:ed1a::3
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - http://en.wikipedia.com/_status
      scheduler: wrr
    page: false
    probes:
      - type: http
        host: en.wikipedia.com
        path: /_status
    monitoring:
      check_command: check_http_lvs!en.wikipedia.com!/_status
      sites:
        codfw:
          hostname: ncredir-lb.codfw.wikimedia.org
        eqiad:
          hostname: ncredir-lb.eqiad.wikimedia.org
        esams:
          hostname: ncredir-lb.esams.wikimedia.org
        eqsin:
          hostname: ncredir-lb.eqsin.wikimedia.org
        ulsfo:
          hostname: ncredir-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: ncredir-lb.drmrs.wikimedia.org
    port: 80
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  ncredir-https:
    description: Non canonical redirect service
    encryption: true
    ip: *id005
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - https://en.wikipedia.com/_status
      scheduler: wrr
    probes:
      - type: http
        host: en.wikipedia.com
        path: /_status
    monitoring:
      check_command: check_https_url!en.wikipedia.com!/_status
      sites:
        codfw:
          hostname: ncredir-lb.codfw.wikimedia.org
        eqiad:
          hostname: ncredir-lb.eqiad.wikimedia.org
        esams:
          hostname: ncredir-lb.esams.wikimedia.org
        eqsin:
          hostname: ncredir-lb.eqsin.wikimedia.org
        ulsfo:
          hostname: ncredir-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: ncredir-lb.drmrs.wikimedia.org
    port: 443
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  ores:
    description: Objective Revision Evaluation Service. ores.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.10
      eqiad:
        default: 10.2.2.10
    lvs:
      class: low-traffic
      conftool:
        cluster: ores
        service: ores
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/v2/scores/
      scheduler: wrr
    probes:
      - type: http
        path: /v2/scores/
    monitoring:
      check_command: check_https_url!ores.discovery.wmnet!/v2/scores/
      sites:
        codfw:
          hostname: ores.svc.codfw.wmnet
        eqiad:
          hostname: ores.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: ores
        active_active: true

  parsoid-php:
    description: Parsoid/PHP wikitext parser for VisualEditor (%{::site})
    encryption: true
    ip:
      codfw:
        default: 10.2.1.28
      eqiad:
        default: 10.2.2.28
    lvs:
      class: low-traffic
      conftool:
        cluster: parsoid
        service: parsoid-php
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/wiki/Special:BlankPage
      scheduler: wrr
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      sites:
        codfw:
          hostname: parsoid.svc.codfw.wmnet
        eqiad:
          hostname: parsoid.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: parsoid-php
        active_active: false
    aliases:
      - "parsoid"

  prometheus:
    description: Prometheus monitoring
    encryption: false
    ip:
      codfw:
        default: 10.2.1.25
      eqiad:
        default: 10.2.2.25
    lvs:
      class: low-traffic
      conftool:
        cluster: prometheus
        service: prometheus
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://prometheus/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_http_lvs_on_port!prometheus!80!/
      sites:
        codfw:
          hostname: prometheus.svc.codfw.wmnet
        eqiad:
          hostname: prometheus.svc.eqiad.wmnet
    port: 80
    # note: PoPs run prometheus::pop role, but not a problem in this case
    role: "prometheus"
    sites:
      - eqiad
      - codfw
    state: production

  proton:
    description: Proton PDF rendering service. proton.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.21
      eqiad:
        default: 10.2.2.21
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!proton.discovery.wmnet!4030!/_info
      sites:
        codfw:
          hostname: proton.svc.codfw.wmnet
        eqiad:
          hostname: proton.svc.eqiad.wmnet
    port: 4030
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: proton
        active_active: true

  push-notifications:
    description: Push-notifications service push-notifications.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.56
      eqiad:
        default: 10.2.2.56
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!push-notifications.discovery.wmnet!4104!/_info
      sites:
        codfw:
          hostname: push-notifications.svc.codfw.wmnet
        eqiad:
          hostname: push-notifications.svc.eqiad.wmnet
    port: 4104
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: push-notifications
        active_active: true

  recommendation-api:
    description: Service for recommendation API. recommendation-api.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.37
      eqiad:
        default: 10.2.2.37
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /robots.txt
    monitoring:
      check_command: check_https_lvs_on_port!recommendation-api.discovery.wmnet!4632!/robots.txt
      sites:
        codfw:
          hostname: recommendation-api.svc.codfw.wmnet
        eqiad:
          hostname: recommendation-api.svc.eqiad.wmnet
    port: 4632
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: recommendation-api
        active_active: true

  restbase-backend:
    description: RESTBase backend, restbase.svc.%{::site}.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-backend
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    port: 7233
    sites:
      - eqiad
      - codfw
    state: production

  restbase-https:
    description: RESTBase, restbase.svc.%{::site}.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_https_lvs_on_port!restbase.discovery.wmnet!7443!/
      sites:
        codfw:
          hostname: restbase.svc.codfw.wmnet
        eqiad:
          hostname: restbase.svc.eqiad.wmnet
    port: 7443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: restbase
        active_active: true
      - dnsdisc: restbase-async
        active_active: true

  schema:
    description: Event Schema HTTP service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.43
      eqiad:
        default: 10.2.2.43
    lvs:
      class: low-traffic
      conftool:
        cluster: eventschemas
        service: eventschemas
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/repositories/
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /repositories/
    monitoring:
      check_command: check_https_lvs_on_port!schema.discovery.wmnet!443!/repositories/
      sites:
        codfw:
          hostname: schema.svc.codfw.wmnet
        eqiad:
          hostname: schema.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: schema
        active_active: true

  search:
    description: Elasticsearch search for MediaWiki
    encryption: false
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_http_on_port!9200
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9200
    sites:
      - eqiad
      - codfw
    state: production

  search-https:
    description: Elasticsearch search for MediaWiki - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_https_on_port!9243
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9243
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: search
        active_active: true

  search-omega-https:
    description: Elasticsearch search for MediaWiki (Omega cluster) - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_https_on_port!9443
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9443
    sites:
      - eqiad
      - codfw
    state: production
    aliases:
      - "search"

  search-psi-https:
    description: Elasticsearch search for MediaWiki (Psi cluster) - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    monitoring:
      check_command: check_https_on_port!9643
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9643
    sites:
      - eqiad
      - codfw
    state: production
    aliases:
      - "search"

  sessionstore:
    description: Session store, sessionstore.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.29
      eqiad:
        default: 10.2.2.29
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_port_status!8081!200!/healthz
      sites:
        codfw:
          hostname: sessionstore.svc.codfw.wmnet
        eqiad:
          hostname: sessionstore.svc.eqiad.wmnet
    port: 8081
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: sessionstore
        active_active: true

  shellbox:
    description: Shellbox, shellbox.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.51
      eqiad:
        default: 10.2.2.51
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!shellbox.discovery.wmnet!4008!/healthz
      sites:
        codfw:
          hostname: shellbox.svc.codfw.wmnet
        eqiad:
          hostname: shellbox.svc.eqiad.wmnet
    port: 4008
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox
        active_active: true

  shellbox-constraints:
    description: Shellbox Constraints, shellbox-constraints.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.61
      eqiad:
        default: 10.2.2.61
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!shellbox-constraints.discovery.wmnet!4010!/healthz
      sites:
        codfw:
          hostname: shellbox-constraints.svc.codfw.wmnet
        eqiad:
          hostname: shellbox-constraints.svc.eqiad.wmnet
    port: 4010
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-constraints
        active_active: true

  shellbox-media:
    description: Shellbox Media, shellbox-media.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.64
      eqiad:
        default: 10.2.2.64
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!shellbox-media.discovery.wmnet!4015!/healthz
      sites:
        codfw:
          hostname: shellbox-media.svc.codfw.wmnet
        eqiad:
          hostname: shellbox-media.svc.eqiad.wmnet
    port: 4015
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-media
        active_active: true

  shellbox-syntaxhighlight:
    description: Shellbox SyntaxHighlight, shellbox-syntaxhighlight.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.65
      eqiad:
        default: 10.2.2.65
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!shellbox-syntaxhighlight.discovery.wmnet!4014!/healthz
      sites:
        codfw:
          hostname: shellbox-syntaxhighlight.svc.codfw.wmnet
        eqiad:
          hostname: shellbox-syntaxhighlight.svc.eqiad.wmnet
    port: 4014
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-syntaxhighlight
        active_active: true

  shellbox-timeline:
    description: Shellbox Timeline, shellbox-timeline.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.66
      eqiad:
        default: 10.2.2.66
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!shellbox-timeline.discovery.wmnet!4012!/healthz
      sites:
        codfw:
          hostname: shellbox-timeline.svc.codfw.wmnet
        eqiad:
          hostname: shellbox-timeline.svc.eqiad.wmnet
    port: 4012
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-timeline
        active_active: true

  swift:
    description: Swift media storage
    encryption: false
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: swift-fe
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/monitoring/frontend
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs!localhost!/monitoring/frontend
      sites:
        codfw:
          hostname: ms-fe.svc.codfw.wmnet
        eqiad:
          hostname: ms-fe.svc.eqiad.wmnet
    port: 80
    sites:
      - codfw
      - eqiad
    state: production

  swift-https:
    description: Swift media storage
    encryption: true
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/monitoring/frontend
      scheduler: wrr
    probes:
      - type: http
        path: /monitoring/frontend
    monitoring:
      check_command: check_https_url!localhost!/monitoring/frontend
      sites:
        codfw:
          hostname: ms-fe.svc.codfw.wmnet
        eqiad:
          hostname: ms-fe.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: swift
        active_active: true
      - dnsdisc: swift-rw # TODO: remove this from DNS!
        active_active: false
      - dnsdisc: swift-ro # TODO: remove this from DNS!
        active_active: true
    aliases:
      - "ms-fe"

  tegola-vector-tiles:
    description: Tegola Vector Tiles, tegola-vector-tiles.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.60
      eqiad:
        default: 10.2.2.60
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /capabilities
    monitoring:
      check_command: check_https_lvs_on_port!tegola-vector-tiles.discovery.wmnet!4105!/capabilities
      sites:
        codfw:
          hostname: tegola-vector-tiles.svc.codfw.wmnet
        eqiad:
          hostname: tegola-vector-tiles.svc.eqiad.wmnet
    port: 4105
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: tegola-vector-tiles
        active_active: true

  thanos-query:
    description: Prometheus long-term storage, query service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.53
      eqiad:
        default: 10.2.2.53
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-query
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-query.discovery.wmnet/-/ready
      scheduler: wrr
    probes:
      - type: http
        path: /-/ready
    monitoring:
      check_command: check_https_url!thanos-query.discovery.wmnet!/-/ready
      sites:
        codfw:
          hostname: thanos-query.svc.codfw.wmnet
        eqiad:
          hostname: thanos-query.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-query
        active_active: true
    role: "thanos::frontend"
    public_endpoint: "thanos"

  thanos-swift:
    description: Prometheus long-term storage, object storage (swift) access
    encryption: true
    ip:
      codfw:
        default: 10.2.1.54
      eqiad:
        default: 10.2.2.54
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-swift
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-swift.discovery.wmnet/healthcheck
      scheduler: wrr
    probes:
      - type: http
        path: /healthcheck
        # Force Host: header to not include the port.
        # See also https://phabricator.wikimedia.org/T300119
        host: thanos-swift.discovery.wmnet
    monitoring:
      check_command: check_https_url!thanos-swift.discovery.wmnet!/healthcheck
      sites:
        codfw:
          hostname: thanos-swift.svc.codfw.wmnet
        eqiad:
          hostname: thanos-swift.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-swift
        active_active: true
    role: "thanos::frontend"

  termbox:
    description: Wikidata Termbox SSR termbox.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.46
      eqiad:
        default: 10.2.2.46
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!termbox.discovery.wmnet!4004!/_info
      sites:
        codfw:
          hostname: termbox.svc.codfw.wmnet
        eqiad:
          hostname: termbox.svc.eqiad.wmnet
    port: 4004
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: termbox
        active_active: true

  text:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (Varnish)
    encryption: false
    ip:
      codfw: &id006
        testlb: 208.80.153.225
        testlb6: 2620:0:860:ed1a::2
        textlb: 208.80.153.224
        textlb6: 2620:0:860:ed1a::1
      eqiad: &id007
        testlb: 208.80.154.225
        testlb6: 2620:0:861:ed1a::2
        textlb: 208.80.154.224
        textlb6: 2620:0:861:ed1a::1
      eqsin: &id008
        testlb: 103.102.166.225
        testlb6: 2001:df2:e500:ed1a::2
        textlb: 103.102.166.224
        textlb6: 2001:df2:e500:ed1a::1
      esams: &id009
        testlb: 91.198.174.193
        testlb6: 2620:0:862:ed1a::2
        textlb: 91.198.174.192
        textlb6: 2620:0:862:ed1a::1
      ulsfo: &id010
        testlb: 198.35.26.97
        testlb6: 2620:0:863:ed1a::2
        textlb: 198.35.26.96
        textlb6: 2620:0:863:ed1a::1
      drmrs: &id016
        testlb: 185.15.58.225
        testlb6: 2a02:ec80:600:ed1a::2
        textlb: 185.15.58.224
        textlb6: 2a02:ec80:600:ed1a::1
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: varnish-fe
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: sh
    probes:
      - type: http
        host: en.wikipedia.org
        path: /wiki/Special:BlankPage
        expect_redirect: true
    monitoring:
      check_command: check_http_lvs!en.wikipedia.org!/wiki/Special:BlankPage
      sites:
        codfw:
          hostname: text-lb.codfw.wikimedia.org
        eqiad:
          hostname: text-lb.eqiad.wikimedia.org
        eqsin:
          hostname: text-lb.eqsin.wikimedia.org
        esams:
          hostname: text-lb.esams.wikimedia.org
        ulsfo:
          hostname: text-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: text-lb.drmrs.wikimedia.org
    port: 80
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  text-https:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (nginx)
    encryption: true
    ip:
      codfw: *id006
      eqiad: *id007
      eqsin: *id008
      esams: *id009
      ulsfo: *id010
      drmrs: *id016
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: ats-tls
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: sh
    probes:
      - type: http
        host: en.wikipedia.org
        path: /wiki/Special:BlankPage
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      sites:
        codfw:
          hostname: text-lb.codfw.wikimedia.org
        eqiad:
          hostname: text-lb.eqiad.wikimedia.org
        eqsin:
          hostname: text-lb.eqsin.wikimedia.org
        esams:
          hostname: text-lb.esams.wikimedia.org
        ulsfo:
          hostname: text-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: text-lb.drmrs.wikimedia.org
    port: 443
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  thumbor:
    description: Thumbor image scaling
    encryption: false
    ip:
      codfw:
        default: 10.2.1.24
      eqiad:
        default: 10.2.2.24
    lvs:
      class: low-traffic
      conftool:
        cluster: thumbor
        service: thumbor
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          timeout: 10
          url:
            - http://localhost/healthcheck
      scheduler: wrr
    probes:
      - type: http
        path: /healthcheck
        timeout: 15s # max value, cannot be higher than Prometheus' scrape_interval (15s)
    monitoring:
      check_command: check_http_lvs_on_port_timeout!thumbor.discovery.wmnet!8800!/healthcheck!20
      sites:
        codfw:
          hostname: thumbor.svc.codfw.wmnet
        eqiad:
          hostname: thumbor.svc.eqiad.wmnet
    port: 8800
    sites:
      - eqiad
      - codfw
    state: production

  toolhub:
    description: Toolhub, toolhub.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.62
      eqiad:
        default: 10.2.2.62
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!toolhub.discovery.wmnet!4011!/healthz
      sites:
        codfw:
          hostname: toolhub.svc.codfw.wmnet
        eqiad:
          hostname: toolhub.svc.eqiad.wmnet
    port: 4011
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: toolhub
        active_active: false

  upload:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: false
    ip:
      codfw: &id011
        uploadlb: 208.80.153.240
        uploadlb6: 2620:0:860:ed1a::2:b
      eqiad: &id012
        uploadlb: 208.80.154.240
        uploadlb6: 2620:0:861:ed1a::2:b
      eqsin: &id013
        uploadlb: 103.102.166.240
        uploadlb6: 2001:df2:e500:ed1a::2:b
      esams: &id014
        uploadlb: 91.198.174.208
        uploadlb6: 2620:0:862:ed1a::2:b
      ulsfo: &id015
        uploadlb: 198.35.26.112
        uploadlb6: 2620:0:863:ed1a::2:b
      drmrs: &id017
        uploadlb: 185.15.58.240
        uploadlb6: 2a02:ec80:600:ed1a::2:b
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: varnish-fe
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: sh
    probes:
      - type: http
        host: upload.wikimedia.org
        path: /monitoring/backend
        expect_redirect: true
    monitoring:
      check_command: check_http_lvs!upload.wikimedia.org!/monitoring/backend
      sites:
        codfw:
          hostname: upload-lb.codfw.wikimedia.org
        eqiad:
          hostname: upload-lb.eqiad.wikimedia.org
        eqsin:
          hostname: upload-lb.eqsin.wikimedia.org
        esams:
          hostname: upload-lb.esams.wikimedia.org
        ulsfo:
          hostname: upload-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: upload-lb.drmrs.wikimedia.org
    port: 80
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  upload-https:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: true
    ip:
      codfw: *id011
      eqiad: *id012
      eqsin: *id013
      esams: *id014
      ulsfo: *id015
      drmrs: *id017
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: ats-tls
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: sh
    probes:
      - type: http
        host: upload.wikimedia.org
        path: /monitoring/backend
    monitoring:
      check_command: check_https_url!upload.wikimedia.org!/monitoring/backend
      sites:
        codfw:
          hostname: upload-lb.codfw.wikimedia.org
        eqiad:
          hostname: upload-lb.eqiad.wikimedia.org
        eqsin:
          hostname: upload-lb.eqsin.wikimedia.org
        esams:
          hostname: upload-lb.esams.wikimedia.org
        ulsfo:
          hostname: upload-lb.ulsfo.wikimedia.org
        drmrs:
          hostname: upload-lb.drmrs.wikimedia.org
    port: 443
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
    state: production

  videoscaler:
    description: Videoscaler LVS interface (https). videoscaler.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.5
      eqiad:
        default: 10.2.2.5
    lvs:
      class: low-traffic
      conftool:
        cluster: videoscaler
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php
      scheduler: wrr
    probes:
      - type: http
        path: /w/health-check.php
    monitoring:
      check_command: check_https_url!videoscaler.discovery.wmnet!/w/health-check.php
      sites:
        codfw:
          hostname: videoscaler.svc.codfw.wmnet
        eqiad:
          hostname: videoscaler.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: videoscaler
        active_active: false

  wcqs:
    description: Wikimedia Commons Query Service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.67
      eqiad:
        default: 10.2.2.67
    lvs:
      class: low-traffic
      conftool:
        cluster: wcqs
        service: wcqs
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/readiness-probe
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /readiness-probe
    monitoring:
      check_command: check_https_url!wcqs.discovery.wmnet!/readiness-probe
      sites:
        codfw:
          hostname: wcqs.svc.codfw.wmnet
        eqiad:
          hostname: wcqs.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wcqs
        active_active: true

  wdqs:
    description: Wikidata Query Service
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!wdqs.discovery.wmnet!80!/readiness-probe
      sites:
        codfw:
          hostname: wdqs.svc.codfw.wmnet
        eqiad:
          hostname: wdqs.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production

  wdqs-heavy-queries:
    description: Wikidata Query Service for heavy queries
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-heavy-queries
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    port: 8888
    sites:
      - eqiad
      - codfw
    state: production

  wdqs-internal:
    description: Wikidata Query Service - internal
    encryption: false
    ip:
      codfw:
        default: 10.2.1.41
      eqiad:
        default: 10.2.2.41
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs-internal
        service: wdqs
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    probes:
      - type: http
        path: /readiness-probe
    monitoring:
      check_command: check_http_lvs_on_port!wdqs-internal.discovery.wmnet!80!/readiness-probe
      sites:
        codfw:
          hostname: wdqs-internal.svc.codfw.wmnet
        eqiad:
          hostname: wdqs-internal.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs-internal
        active_active: true

  wdqs-ssl:
    description: Wikidata Query Service - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/readiness-probe
      scheduler: wrr
    probes:
      - type: http
        path: /readiness-probe
    monitoring:
      check_command: check_https_url!wdqs.discovery.wmnet!/readiness-probe
      sites:
        codfw:
          hostname: wdqs.svc.codfw.wmnet
        eqiad:
          hostname: wdqs.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs
        active_active: true

  wikifeeds:
    description: A node webservice supporting featured wiki content feeds. wikifeeds.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.47
      eqiad:
        default: 10.2.2.47
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
    monitoring:
      check_command: check_https_lvs_on_port!wikifeeds.discovery.wmnet!4101!/_info
      sites:
        codfw:
          hostname: wikifeeds.svc.codfw.wmnet
        eqiad:
          hostname: wikifeeds.svc.eqiad.wmnet
    port: 4101
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wikifeeds
        active_active: true

  zotero:
    description: Zotero, zotero.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.16
      eqiad:
        default: 10.2.2.16
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        post_json: '[{"itemType":"journalArticle"}]'
        path: /export?format=wikipedia
    monitoring:
      check_command: check_https_zotero_lvs_on_port!zotero.discovery.wmnet!4969!/export?format=wikipedia
      sites:
        codfw:
          hostname: zotero.svc.codfw.wmnet
        eqiad:
          hostname: zotero.svc.eqiad.wmnet
    port: 4969
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: zotero
        active_active: true

  # Chartmuseum is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  helm-charts:
    description: helm-charts
    encryption: true
    ip:
      codfw:
        default: 10.192.48.159
      eqiad:
        default: 10.64.48.26
    page: false
    probes:
      - type: http
        path: /health
        must_contain_regexp: '"healthy".*:.*true'
    monitoring:
      check_command: check_https_url_for_string!helm-charts.discovery.wmnet!/health!true
      notes_url: "https://wikitech.wikimedia.org/wiki/ChartMuseum"
      sites:
        codfw:
          hostname: chartmuseum2001
        eqiad:
          hostname: chartmuseum1001
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: helm-charts
        active_active: true

  # Releases is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  releases:
    description: MediaWiki, Parsoid, MobileApps and other Wikimedia realease files (https://releases.wikimedia.org)
    encryption: true
    ip:
      codfw:
        default: 10.192.16.180
      eqiad:
        default: 10.64.48.17
    page: false
    probes:
      - type: http
        path: /mediawiki
        host: releases.wikimedia.org
        must_contain_regexp: MediaWiki
    monitoring:
      check_command: check_https_url_for_string!releases.wikimedia.org!/mediawiki/!MediaWiki
      notes_url: "https://wikitech.wikimedia.org/wiki/Releases.wikimedia.org"
      sites:
        codfw:
          hostname: releases2002
        eqiad:
          hostname: releases1002
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: releases
        active_active: true

  api-gateway:
    description: API gateway, api-gateway.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.55
      eqiad:
        default: 10.2.2.55
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!api-gateway.discovery.wmnet!8087!/healthz
      sites:
        codfw:
          hostname: api-gateway.svc.codfw.wmnet
        eqiad:
          hostname: api-gateway.svc.eqiad.wmnet
    port: 8087
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: api-gateway
        active_active: true

  similar-users:
    description: Similar-users/sockpuppet, similar-users.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.57
      eqiad:
        default: 10.2.2.57
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!similar-users.discovery.wmnet!4110!/healthz
      sites:
        codfw:
          hostname: similar-users.svc.codfw.wmnet
        eqiad:
          hostname: similar-users.svc.eqiad.wmnet
    port: 4110
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: similar-users
        active_active: true

  linkrecommendation:
    description: Link Recommendation, linkrecommendation.svc.%{::site}.wmnet
    encryption: true
    ip: &linkrecommendation_ips
      codfw:
        default: 10.2.1.23
      eqiad:
        default: 10.2.2.23
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!linkrecommendation.discovery.wmnet!4005!/healthz
      sites:
        codfw:
          hostname: linkrecommendation.svc.codfw.wmnet
        eqiad:
          hostname: linkrecommendation.svc.eqiad.wmnet
    port: 4005
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true

  linkrecommendation-external:
    description: Link Recommendation, public release, linkrecommendation.svc.%{::site}.wmnet
    encryption: true
    ip: *linkrecommendation_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!linkrecommendation.discovery.wmnet!4006!/healthz
      sites:
        codfw:
          hostname: linkrecommendation.svc.codfw.wmnet
        eqiad:
          hostname: linkrecommendation.svc.eqiad.wmnet
    port: 4006
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true

  apple-search:
    description: Apple search service, apple-search.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.68
      eqiad:
        default: 10.2.2.68
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    monitoring:
      check_command: check_https_lvs_on_port!apple-search.discovery.wmnet!4013!/healthz
      sites:
        codfw:
          hostname: apple-search.svc.codfw.wmnet
        eqiad:
          hostname: apple-search.svc.eqiad.wmnet
    port: 4013
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: apple-search
        active_active: true

## WIKIREPLICAS sections.
  wikireplicas-a-s1: &wikireplica_a_default
    description: "lvs for a-side wikireplicas section s1"
    encryption: false
    ip:
      eqiad:
        default: 208.80.154.242
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3311
    sites:
      - eqiad
    state: production

  wikireplicas-a-s2:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s2"
    port: 3312

  wikireplicas-a-s3:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s3"
    port: 3313

  wikireplicas-a-s4:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s4"
    port: 3314

  wikireplicas-a-s5:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s5"
    port: 3315

  wikireplicas-a-s6:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s6"
    port: 3316

  wikireplicas-a-s7:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s7"
    port: 3317

  wikireplicas-a-s8:
    <<: *wikireplica_a_default
    description: "lvs for a-side wikireplicas section s8"
    port: 3318

  wikireplicas-b-s1: &wikireplica_b_default
    description: "lvs for b-side wikireplicas section s1"
    encryption: false
    ip:
      eqiad:
        default: 208.80.154.243
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3311
    sites:
      - eqiad
    state: production

  wikireplicas-b-s2:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s2"
    port: 3312

  wikireplicas-b-s3:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s3"
    port: 3313

  wikireplicas-b-s4:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s4"
    port: 3314

  wikireplicas-b-s5:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s5"
    port: 3315

  wikireplicas-b-s6:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s6"
    port: 3316

  wikireplicas-b-s7:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s7"
    port: 3317

  wikireplicas-b-s8:
    <<: *wikireplica_b_default
    description: "lvs for b-side wikireplicas section s8"
    port: 3318

  # puppetdb-api is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  puppetdb-api:
    description: Puppetdb api microservice
    encryption: true
    ip:
      codfw:
        default: 10.192.0.147
      eqiad:
        default: 10.64.32.80
    page: false
    probes:
      - type: http
    monitoring:
      check_command: "check_https_on_port!8090"
      notes_url: "https://wikitech.wikimedia.org/wiki/Puppet#Micro_Service"
      sites:
        codfw:
          hostname: puppetdb1002
        eqiad:
          hostname: puppetdb2002
    sites:
      - eqiad
      - codfw
    port: 8090
    state: production
    discovery:
      - dnsdisc: puppetdb-api
        active_active: true

  # Observability services (non-lvs)
  alertmanager:
    encryption: true
    role: "alerting_host"
    public_endpoint: "alerts"
    port: 443
    description: Alertmanager service
    # No 'monitoring' section, covered by metamonitoring.
    # Also icinga doesn't know about the "other site" alerting host.
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 208.80.153.84
      eqiad:
        default: 208.80.154.88
    state: production

  graphite:
    encryption: true
    role: "graphite::production"
    public_endpoint: "graphite"
    port: 443
    description: Graphite metrics platform
    page: false
    probes:
      - type: http
        host: graphite.wikimedia.org
        expect_sso: true
    monitoring:
      check_command: "check_https_on_port!443"
      notes_url: "https://wikitech.wikimedia.org/wiki/Graphite"
      sites:
        codfw:
          hostname: graphite2003
        eqiad:
          hostname: graphite1004
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 10.192.0.102
      eqiad:
        default: 10.64.16.149
    state: production

  grafana:
    encryption: true
    role: "grafana"
    public_endpoint: "grafana"
    public_aliases:
      - "grafana-rw"
      - "grafana-next"
      - "grafana-next-rw"
    port: 443
    description: Graphing and dashboarding
    page: false
    probes:
      - type: http
        host: grafana.wikimedia.org
    monitoring:
      check_command: "check_https_on_port!443"
      notes_url: "https://wikitech.wikimedia.org/wiki/Grafana.wikimedia.org"
      sites:
        codfw:
          hostname: grafana2001
        eqiad:
          hostname: grafana1002
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 10.192.0.160
      eqiad:
        default: 10.64.0.119
    state: production

  librenms:
    encryption: true
    role: "netmon"
    public_endpoint: "librenms"
    port: 443
    description: Network device observability
    page: false
    probes:
      - type: http
        host: librenms.wikimedia.org
        expect_sso: true
    monitoring:
      check_command: "check_https_on_port!443"
      notes_url: "https://wikitech.wikimedia.org/wiki/LibreNMS"
      sites:
        codfw:
          hostname: netmon2001
        eqiad:
          hostname: netmon1002
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 208.80.153.110
      eqiad:
        default: 208.80.154.5
    state: production

  # This service points to an Istio Ingress Gateway,
  # that acts as L7 load balancer. It monitors backends
  # by itself, and by default it exposes a separate port
  # to check the status of its pods (not the backend services).
  # Pybal doesn't support health checks on different ports than
  # the service one. To keep this simple, we are not adding any
  # L7 check for LVS, but we are simply relying on checking that
  # a TCP conn can be established. This may change in the future
  # as we get more experience with Istio.
  inference:
    description: Inference ML service
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.63
      codfw:
        default: 10.2.1.63
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        valid_status_codes:
          - 404
    monitoring:
      check_command: check_tcp_ssl!inference.discovery.wmnet!30443
      sites:
        eqiad:
          hostname: inference.svc.eqiad.wmnet
        codfw:
          hostname: inference.svc.codfw.wmnet
    port: 30443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: inference
        active_active: true

  # apt is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  apt:
    description: Internal apt package repository
    encryption: false
    ip:
      codfw:
        default: 208.80.153.42
      eqiad:
        default: 208.80.154.30
    page: false
    probes:
      - type: http
        host: apt.wikimedia.org
        path: /wikimedia/
    monitoring:
      check_command: "check_http_url!apt.wikimedia.org!/wikimedia/"
      notes_url: "https://wikitech.wikimedia.org/wiki/APT_repository"
      sites:
        codfw:
          hostname: apt2001
        eqiad:
          hostname: apt1001
    sites:
      - eqiad
      - codfw
    port: 80
    state: production
    discovery:
      - dnsdisc: apt
        active_active: false

  # puppetboard is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  puppetboard:
    description: Internal production Puppetboard interface
    encryption: true
    ip:
      codfw:
        default: 10.192.32.30
      eqiad:
        default: 10.64.48.59
    page: false
    probes:
      - type: http
        host: puppetboard.wikimedia.org
        expect_sso: true
    monitoring:
      check_command: "check_https_sso_redirect!puppetboard.wikimedia.org!/"
      notes_url: "https://wikitech.wikimedia.org/wiki/Puppet"
      sites:
        codfw:
          hostname: puppetboard2002
        eqiad:
          hostname: puppetboard1002
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: puppetboard
        active_active: true

  image-suggestion:
    description: image suggestion service, image-suggestion.svc.%{::site}.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  developer-portal:
    description: Static documentation site, developer-portal.svc.%{::site}.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: service_setup

  # Netbox is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  netbox:
    description: Netbox Frontend
    encryption: true
    ip:
      codfw:
        default: 10.192.0.96
      eqiad:
        default: 10.64.0.186
    page: true
    probes:
      - type: http
        host: netbox.wikimedia.org
        expect_sso: true
    monitoring:
      check_command: "check_https_sso_redirect!netbox.wikimedia.org!/"
      notes_url: "https://wikitech.wikimedia.org/wiki/Netbox"
      sites:
        codfw:
          hostname: netbox2002
        eqiad:
          hostname: netbox1002
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    page: false
    discovery:
      - dnsdisc: netbox
        active_active: false
