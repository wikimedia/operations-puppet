# Service catalog.
# This entry includes all the information about the WMF internal and external services.
# Every entry in the hash must have a label (the service name) and its body must adhere to the
# Wmflib::Service type. Refer to the documentation of that type, and all the sub-types, for details.
#
# When adding a new field, it needs to be added to spicerack as well, see for example
# https://gerrit.wikimedia.org/r/c/operations/software/spicerack/+/909299
#
# Please keep entries separated by an empty line to allow for easy navigation of the file.

service::catalog:
  apertium:
    description: Machine Translation service. apertium.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.11
      eqiad:
        default: 10.2.2.11
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /listPairs
    port: 4737
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: apertium
        active_active: true

  apus:
    description: 'Ceph-backed async-replicated S3 cluster'
    discovery:
      - dnsdisc: apus
        active_active: true
    encryption: true
    ip:
      codfw:
        default: 10.2.1.10
      eqiad:
        default: 10.2.2.10
    lvs:
      class: low-traffic
      conftool:
        cluster: apus
        service: apus
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://apus.discovery.wmnet/
    page: false
    port: 443
    probes:
      - type: http
        path: /
        host: apus.discovery.wmnet
    sites:
      - codfw
      - eqiad
    state: production

  aux-k8s-ctrl:
    description: 'Kubernetes API service for aux cluster'
    encryption: true
    ip:
      eqiad:
        default: '10.2.2.74'
    lvs:
      class: 'low-traffic'
      conftool:
        cluster: 'aux-k8s'
        service: 'kubemaster'
      depool_threshold: '.5'
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: 'wrr'
    port: 6443
    sites:
      - 'eqiad'
    state: 'production'

  k8s-ingress-aux:
    description: "istio-ingresscontroller on aux-k8s. k8s-ingress-aux.discovery.wmnet"
    encryption: true
    ip: &k8s-ingress-aux_ips
      eqiad:
        default: 10.2.2.78
    lvs:
      class: low-traffic
      conftool:
        cluster: aux-k8s
        service: kubesvc
      depool_threshold: '.5'
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: &k8s-ingress-aux_port 30443
    sites:
      - eqiad
    state: production
    page: false
    discovery:
      - dnsdisc: k8s-ingress-aux
        active_active: false

  jaeger-collector-http:
    description: Jaeger tracing, collector (HTTP)
    encryption: true
    ip: *k8s-ingress-aux_ips
    page: false
    probes:
      - type: tcp
    port: *k8s-ingress-aux_port
    sites:
      - eqiad
    state: production

  jaeger-collector-grpc:
    description: Jaeger tracing, collector (GRPC)
    encryption: true
    ip: *k8s-ingress-aux_ips
    page: false
    probes:
      - type: tcp
    port: *k8s-ingress-aux_port
    sites:
      - eqiad
    state: production

  jaeger-query:
    description: Jaeger tracing, query UI
    encryption: true
    ip: *k8s-ingress-aux_ips
    page: false
    probes:
      - type: tcp
    port: *k8s-ingress-aux_port
    sites:
      - eqiad
    state: production

  citoid:
    description: Citation lookup service, citoid.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.19
      eqiad:
        default: 10.2.2.19
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4003
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: citoid
        active_active: true

  cloudelastic-chi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: &id004
        cloudelasticlb: 208.80.154.241
        cloudelasticlb6: 2620:0:861:ed1a::3:241
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 9243
    sites:
      - eqiad
    state: production

  cloudelastic-chi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 8243
    sites:
      - eqiad
    state: production

  cloudelastic-omega-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 9443
    sites:
      - eqiad
    state: production

  cloudelastic-omega-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Public
      Internet Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 8443
    sites:
      - eqiad
    state: production

  cloudelastic-psi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 9643
    sites:
      - eqiad
    state: production

  cloudelastic-psi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: mh
      ipip_encapsulation:
        - eqiad
    port: 8643
    sites:
      - eqiad
    state: production

  cxserver:
    description: Content Translation service, cxserver.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.18
      eqiad:
        default: 10.2.2.18
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4002
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: cxserver
        active_active: true

  datahubsearch:
    description: Search cluster serving DataHub
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.71
    lvs:
      class: low-traffic
      conftool:
        cluster: datahubsearch
        service: opensearch
      depool_threshold: ".5"
      enabled: false
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
    port: 9200
    sites:
      - eqiad
    state: production
    page: false

  docker-registry:
    description: docker registry service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.44
      eqiad:
        default: 10.2.2.44
    lvs:
      class: low-traffic
      conftool:
        cluster: docker-registry
        service: docker-registry
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /v2/
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: docker-registry
        active_active: false

  druid-public-broker:
    description: Broker query service for the Druid Public Cluster
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.38
    lvs:
      class: low-traffic
      conftool:
        cluster: druid-public
        service: druid-public-broker
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/status
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /status
    port: 8082
    sites:
      - eqiad
    state: production

  echostore:
    description: Echo store, echostore.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.49
      eqiad:
        default: 10.2.2.49
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /healthz
      - type: swagger
        params:
          spec_segment: '/openapi'
    port: 8082
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: echostore
        active_active: true

  eventgate-analytics:
    description: EventGate Analytics endpoint, TLS enabled. https://eventgate-analytics.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.42
      eqiad:
        default: 10.2.2.42
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4592
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics
        active_active: true

  eventgate-logging-external:
    description: EventGate logging endpoint, eventgate-logging-external.discovery.wmnet and intake-logging.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.50
      eqiad:
        default: 10.2.2.50
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4392
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-logging-external
        active_active: true

  eventgate-analytics-external:
    description: EventGate analytics external endpoint, eventgate-analytics-external.discovery.wmnet and intake-analytics.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.52
      eqiad:
        default: 10.2.2.52
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4692
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics-external
        active_active: true

  eventgate-main:
    description: EventGate main endpoint, TLS enabled, https://eventgate-main.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.45
      eqiad:
        default: 10.2.2.45
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4492
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-main
        active_active: true

  eventstreams:
    description: Public streams of events via HTTP + SSE, backed by Kafka. eventstreams.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.34
      eqiad:
        default: 10.2.2.34
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4892
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams
        active_active: true

  eventstreams-internal:
    description: Internal streams of events via HTTP + SSE, backed by Kafka. eventstreams-internal.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.35
      eqiad:
        default: 10.2.2.35
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4992
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams-internal
        active_active: true

  jobrunner:
    description: JobRunner LVS interface (https). jobrunner.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.26
      eqiad:
        default: 10.2.2.26
    lvs:
      class: low-traffic
      conftool:
        cluster: jobrunner
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php?force_php72=1
            - https://localhost/w/health-check.php?force_php74=1
          check_all: true
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /w/health-check.php
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: jobrunner
        active_active: false

  k8s-ingress-staging:
    description: istio-ingresscontroller on kubernetes staging. k8s-ingress-staging.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.69
      eqiad:
        default: 10.2.2.69
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes-staging
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: 30443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-staging
        active_active: false

  k8s-ingress-wikikube:
    description: istio-ingresscontroller on kubernetes. k8s-ingress-wikikube.discovery.wmnet
    encryption: true
    ip: &k8s-ingress-wikikube_ips
      codfw:
        default: 10.2.1.70
      eqiad:
        default: 10.2.2.70
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: true
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: &k8s-ingress-wikikube_port 30443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-wikikube-ro
        active_active: true
      - dnsdisc: k8s-ingress-wikikube-rw
        active_active: false

  k8s-ingress-ml-staging:
    description: istio-ingresscontroller on kubernetes ML staging. k8s-ingress-ml-staging.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.83
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_staging
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    # The ingressgateway does not accept connections on 31443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: 31443
    sites:
      - codfw
    state: production
    discovery:
      - dnsdisc: k8s-ingress-ml-staging
        active_active: false

  k8s-ingress-ml-serve:
    description: istio-ingresscontroller on kubernetes. k8s-ingress-ml-serve.discovery.wmnet
    encryption: true
    ip: &k8s-ingress-ml-serve_ips
      codfw:
        default: 10.2.1.84
      eqiad:
        default: 10.2.2.84
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: &k8s-ingress-ml-serve_port 31443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-ml-serve
        active_active: true


  k8s-ingress-dse:
    description: istio-ingresscontroller on kubernetes. k8s-ingress-dse.discovery.wmnet
    encryption: true
    ip: &k8s-ingress-dse_ips
      eqiad:
        default: 10.2.2.91
    lvs:
      class: low-traffic
      conftool:
        cluster: dse-k8s
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    # The ingressgateway does not accept connections on 30443 if no backend is
    # configured (which is fine from ingressgateways POV). That means PyBal might
    # see all hosts as down during initial setup of ingressgateway.
    # Also there is no TLS certificate or route for the discovery FQDN configured
    # in ingressgateway and it is not possible to do so just within it's envoy
    # instance (e.g. without adding another service).
    # Because of all that, just check the tcp connection here as well.
    #
    # Kubernetes will internally check the ingressgateways dedicated health check
    # port and will pull the iptables rules used to forward traffic to ingressgateway
    # in case health check fails. That in turn means tcp connections will be rejected
    # leading this check and PyBal monitor to fail.
    probes:
      - type: tcp-notls
    port: &k8s-ingress-dse_port 30443
    sites:
      - eqiad
    state: production
    discovery:
      - dnsdisc: k8s-ingress-dse
        active_active: false

  kartotherian:
    description: Kartotherian, kartotherian.discovery.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    port: 6533
    probes:
      - type: swagger
    sites:
      - codfw
      - eqiad
    state: production

  kartotherian-ssl:
    description: Kartotherian, kartotherian.discovery.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /osm-intl/6/23/24.png
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: kartotherian
        active_active: true

  kibana7:
    description: Kibana v7 env - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.48
      eqiad:
        default: 10.2.2.48
    lvs:
      class: low-traffic
      conftool:
        cluster: kibana7
        service: kibana7
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://logstash.wikimedia.org/api/status
      scheduler: mh
    probes:
      - type: http
        path: /api/status
        host: logstash.wikimedia.org
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: logstash
        active_active: false
    role: "opensearch::collector"
    public_endpoint: "logstash"

  kubemaster:
    description: Kubernetes master service. kubemaster.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.8
      eqiad:
        default: 10.2.2.8
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    role: "kubernetes::master"
    state: production

  kubestagemaster:
    description: Kubernetes staging master service. kubestagemaster.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.86
      eqiad:
        default: 10.2.2.86
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes-staging
        service: kubemaster
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    role: "kubernetes::staging::master_stacked"
    state: production

  labweb-ssl:
    description: "lvs for cloudweb services: horizon, striker, wikitech - HTTPS"
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.40
    lvs:
      class: low-traffic
      conftool:
        cluster: cloudweb
        service: cloudweb-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 301
          url:
            - https://wikitech.wikimedia.org:7443
      scheduler: wrr
    probes:
      - type: http
        expect_redirect: true
        host: wikitech.wikimedia.org
    page: false
    port: 7443
    sites:
      - eqiad
    state: production
    aliases:
      - "labweb"

  ldap-ro:
    description: Ldap for cloud and developer accounts
    encryption: false
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
    port: 389
    probes:
      - type: tcp
    sites:
      - codfw
      - eqiad
    state: production

  ldap-ro-ssl:
    description: Ldap for cloud and developer accounts (ssl access)
    encryption: true
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
    port: 636
    probes:
      - type: tcp
        host: ldap-ro.eqiad.wikimedia.org # SNI to send, all LDAP certs have this
    sites:
      - codfw
      - eqiad
    state: production

  mathoid:
    description: Mathematical rendering service, mathoid.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.20
      eqiad:
        default: 10.2.2.20
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4001
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mathoid
        active_active: true

  miscweb:
    description: Misc static sites, miscweb.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
        host: static-bugzilla.wikimedia.org
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  dse-k8s-ctrl:
    description: Kubernetes master service for DSE cluster. dse-k8s-ctrl.discovery.wmnet
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.73
    lvs:
      class: low-traffic
      conftool:
        cluster: dse-k8s
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
    state: lvs_setup

  ml-ctrl:
    description: Kubernetes master service for ML cluster. ml-ctrl.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.39
      eqiad:
        default: 10.2.2.39
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    state: lvs_setup

  ml-staging-ctrl:
    description: Kubernetes master service for ML staging cluster. ml-staging-ctrl.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.72
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_staging
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - codfw
    state: lvs_setup

  mobileapps:
    description:
      A service for use by mobile apps. Provides DOM manipulation, aggregation,
      JSON flattening. mobileapps.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.14
      eqiad:
        default: 10.2.2.14
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4102
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mobileapps
        active_active: true

  mwdebug:
    description: mwdebug, mwdebug.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.59
      eqiad:
        default: 10.2.2.59
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 4444
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mwdebug
        active_active: true

  mw-web:
    description: mw-web, mw-web.svc.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.75
      eqiad:
        default: 10.2.2.75
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: appserver
    page: true
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 4450
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-web
        active_active: false
      - dnsdisc: mw-web-ro
        active_active: true

  mw-api-ext:
    description: mw-api-ext, mw-api-ext.svc.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.76
      eqiad:
        default: 10.2.2.76
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: appserver
    page: true
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 4447
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-api-ext
        active_active: false
      - dnsdisc: mw-api-ext-ro
        active_active: true

  mw-api-int:
    description: mw-api-int, mw-api-int.svc.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.81
      eqiad:
        default: 10.2.2.81
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: appserver
    page: true
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 4446
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-api-int
        active_active: false
      - dnsdisc: mw-api-int-ro
        active_active: true

  mw-misc:
    description: Miscellaneous mediawiki installs, mw-misc.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes: # monitoring for this service
      - type: http
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: service_setup

  mw-jobrunner:
    description: mw-jobrunner, mw-jobrunner.svc.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.90
      eqiad:
        default: 10.2.2.90
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: jobrunner
    page: false  # TODO change this to true
    probes:
      - type: http
        path: /w/health-check.php
        host: mw-jobrunner.discovery.wmnet
    port: 4448
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-jobrunner
        active_active: false

  mw-parsoid:
    description: mw-parsoid, mw-parsoid.discovery.wmnet. Parsoid/PHP wikitext parser
    encryption: true
    ip:
      codfw:
        default: 10.2.1.92
      eqiad:
        default: 10.2.2.92
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: appserver
    page: true
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 4452
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-parsoid
        active_active: false

  mw-wikifunctions:
    description: mw-wikifunctions, mw-wikifunctions.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.88
      eqiad:
        default: 10.2.2.88
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    httpbb_dir: appserver
    page: true
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: www.wikifunctions.org
    port: 4451
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mw-wikifunctions
        active_active: false
      - dnsdisc: mw-wikifunctions-ro
        active_active: true

  ncredir:
    description: Non canonical domains redirect service
    encryption: false
    ip: &id005
      codfw:
        ncredirlb: 208.80.153.232
        ncredirlb6: 2620:0:860:ed1a::9
      eqiad:
        ncredirlb: 208.80.154.232
        ncredirlb6: 2620:0:861:ed1a::9
      esams:
        ncredirlb: 185.15.59.226
        ncredirlb6: 2a02:ec80:300:ed1a::3
      ulsfo:
        ncredirlb: 198.35.26.98
        ncredirlb6: 2620:0:863:ed1a::3
      eqsin:
        ncredirlb: 103.102.166.226
        ncredirlb6: 2001:df2:e500:ed1a::3
      drmrs:
        ncredirlb: 185.15.58.226
        ncredirlb6: 2a02:ec80:600:ed1a::3
      magru:
        ncredirlb: 195.200.68.226
        ncredirlb6: 2a02:ec80:700:ed1a::3
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - http://en.wikipedia.com/_status
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    page: false
    probes:
      - type: http
        host: en.wikipedia.com
        path: /_status
    port: 80
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  ncredir-https:
    description: Non canonical redirect service
    encryption: true
    ip: *id005
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - https://en.wikipedia.com/_status
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    probes:
      - type: http
        host: en.wikipedia.com
        path: /_status
    port: 443
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  parsoid-php:
    description: Parsoid/PHP wikitext parser for VisualEditor
    encryption: true
    ip:
      codfw:
        default: 10.2.1.28
      eqiad:
        default: 10.2.2.28
    lvs:
      class: low-traffic
      conftool:
        cluster: parsoid
        service: parsoid-php
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/wiki/Special:BlankPage
            - https://en.wikipedia.org/wiki/Special:BlankPage?force_php74=1
          check_all: true
      scheduler: wrr
    probes:
      - type: http
        path: /wiki/Special:BlankPage
        host: en.wikipedia.org
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: parsoid-php
        active_active: false
    aliases:
      - "parsoid"

  prometheus: &prometheus_default
    description: Prometheus monitoring
    encryption: false
    ip:
      codfw:
        default: 10.2.1.25
      eqiad:
        default: 10.2.2.25
    lvs:
      class: low-traffic
      conftool:
        cluster: prometheus
        service: prometheus
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://prometheus/
      scheduler: wrr
    probes:
      - type: http
    port: 80
    # note: PoPs run prometheus::pop role, but not a problem in this case
    role: "prometheus"
    sites:
      - eqiad
      - codfw
    state: production

  prometheus-https:
    <<: *prometheus_default
    description: "prometheus monitoring https"
    encryption: true
    lvs:
      class: low-traffic
      conftool:
        cluster: prometheus
        service: prometheus
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 302
          url:
            - https://prometheus-%{::site}.wikimedia.org/
      scheduler: wrr
    port: 443
    state: lvs_setup

  proton:
    description: Proton PDF rendering service. proton.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.21
      eqiad:
        default: 10.2.2.21
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4030
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: proton
        active_active: true

  push-notifications:
    description: Push-notifications service push-notifications.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.56
      eqiad:
        default: 10.2.2.56
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /_info
    port: 4104
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: push-notifications
        active_active: true

  recommendation-api:
    description: Service for recommendation API. recommendation-api.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.37
      eqiad:
        default: 10.2.2.37
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    # This used to have probes until we discovered it was failing them for ~20%
    # of the time. Since 2024-07-29, they are disabled. T338471
    #probes:
    #  - type: http
    #    path: /robots.txt
    port: 4632
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: recommendation-api
        active_active: true

  restbase-backend:
    description: RESTBase backend, restbase.discovery.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-backend
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    port: 7233
    sites:
      - eqiad
      - codfw
    state: production

  restbase-https:
    description: RESTBase, restbase.discovery.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
      - type: swagger
    port: 7443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: restbase
        active_active: true
      - dnsdisc: restbase-async
        active_active: true
    aliases:
      - restbase

  schema:
    description: Event Schema HTTP service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.43
      eqiad:
        default: 10.2.2.43
    lvs:
      class: low-traffic
      conftool:
        cluster: eventschemas
        service: eventschemas
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/repositories/
      scheduler: wrr
    page: true
    probes:
      - type: http
        path: /repositories/
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: schema
        active_active: true

  search:
    description: Elasticsearch search for MediaWiki
    encryption: false
    ip: &search_ips
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    port: 9200
    sites:
      - eqiad
      - codfw
    state: production

  search-https:
    description: Elasticsearch search for MediaWiki - HTTPS
    encryption: true
    ip: *search_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    port: 9243
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: search
        active_active: true

  search-omega-https:
    description: Elasticsearch search for MediaWiki (Omega cluster) - HTTPS
    encryption: true
    ip: *search_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    port: 9443
    sites:
      - eqiad
      - codfw
    state: production
    aliases:
      - "search"

  search-psi-https:
    description: Elasticsearch search for MediaWiki (Psi cluster) - HTTPS
    encryption: true
    ip: *search_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    probes:
      - type: http
    port: 9643
    sites:
      - eqiad
      - codfw
    state: production
    aliases:
      - "search"

  sessionstore:
    description: Session store, sessionstore.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.29
      eqiad:
        default: 10.2.2.29
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /healthz
      - type: swagger
        params:
          spec_segment: '/openapi'
    port: 8081
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: sessionstore
        active_active: true

  shellbox:
    description: Shellbox, shellbox.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.51
      eqiad:
        default: 10.2.2.51
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4008
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox
        active_active: true

  shellbox-constraints:
    description: Shellbox Constraints, shellbox-constraints.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.61
      eqiad:
        default: 10.2.2.61
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4010
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-constraints
        active_active: true

  shellbox-media:
    description: Shellbox Media, shellbox-media.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.64
      eqiad:
        default: 10.2.2.64
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4015
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-media
        active_active: true

  shellbox-syntaxhighlight:
    description: Shellbox SyntaxHighlight, shellbox-syntaxhighlight.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.65
      eqiad:
        default: 10.2.2.65
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4014
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-syntaxhighlight
        active_active: true

  shellbox-timeline:
    description: Shellbox Timeline, shellbox-timeline.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.66
      eqiad:
        default: 10.2.2.66
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4012
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-timeline
        active_active: true

  shellbox-video:
    description: Shellbox Video, shellbox-video.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.68
      eqiad:
        default: 10.2.2.68
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    probes:
      - type: http
        path: /healthz
    port: 4080
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox-video
        active_active: true

  swift:
    description: Swift media storage
    encryption: false
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: swift-fe
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/monitoring/frontend
      scheduler: wrr
    port: 80
    sites:
      - codfw
      - eqiad
    state: production
    aliases:
      - ms-fe

  swift-https:
    description: Swift media storage
    encryption: true
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/monitoring/frontend
      scheduler: wrr
    probes:
      - type: http
        path: /monitoring/frontend
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: swift
        active_active: true
      - dnsdisc: swift-rw # TODO: remove this from DNS!
        active_active: false
      - dnsdisc: swift-ro # TODO: remove this from DNS!
        active_active: true
    aliases:
      - "ms-fe"

  tegola-vector-tiles:
    description: Tegola Vector Tiles, tegola-vector-tiles.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.60
      eqiad:
        default: 10.2.2.60
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /capabilities
    port: 4105
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: tegola-vector-tiles
        active_active: true

  thanos-query:
    description: Prometheus long-term storage, query service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.53
      eqiad:
        default: 10.2.2.53
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-query
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-query.discovery.wmnet/-/ready
      scheduler: wrr
    probes:
      - type: http
        path: /-/ready
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-query
        active_active: true
    role: "titan"

  thanos-web:
    description: Prometheus long-term storage, web interface
    encryption: true
    ip:
      codfw:
        default: 10.2.1.77
      eqiad:
        default: 10.2.2.77
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-web
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-query.discovery.wmnet/-/ready
      # Needed for SSO sessions to stick. As of Dec 2022 backend
      # selection from varnish -> ATS is always random for pass traffic
      # therefore even with this we need at most one thanos-fe host
      # pooled at a time (per site).
      scheduler: mh
    # Skip paging for thanos-web for the following reasons:
    # - only one host pooled at a time per site (see above)
    # - not a huge deal if thanos.w.o is down temporarily
    # - service is behind geodns anyways, so a failure is likely to be
    # partial
    page: false
    probes:
      - type: http
        path: /-/ready
        # thanos-web.discovery.wmnet is used only for internal routing
        # vhost selection is done via thanos-query
        host: thanos-query.discovery.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-web
        active_active: true
    role: "titan"
    public_endpoint: "thanos"

  thanos-swift:
    description: Prometheus long-term storage, object storage (swift) access
    encryption: true
    ip:
      codfw:
        default: 10.2.1.54
      eqiad:
        default: 10.2.2.54
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-swift
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-swift.discovery.wmnet/healthcheck
      scheduler: wrr
    probes:
      - type: http
        path: /healthcheck
        # Force Host: header to not include the port.
        # See also https://phabricator.wikimedia.org/T300119
        host: thanos-swift.discovery.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-swift
        active_active: true
    role: "thanos::frontend"

  termbox:
    description: Wikidata Termbox SSR termbox.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.46
      eqiad:
        default: 10.2.2.46
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4004
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: termbox
        active_active: true

  text:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (Varnish)
    encryption: false
    ip:
      codfw: &id006
        testlb: 208.80.153.225
        testlb6: 2620:0:860:ed1a::2
        textlb: 208.80.153.224
        textlb6: 2620:0:860:ed1a::1
      eqiad: &id007
        testlb: 208.80.154.225
        testlb6: 2620:0:861:ed1a::2
        textlb: 208.80.154.224
        textlb6: 2620:0:861:ed1a::1
      eqsin: &id008
        testlb: 103.102.166.225
        testlb6: 2001:df2:e500:ed1a::2
        textlb: 103.102.166.224
        textlb6: 2001:df2:e500:ed1a::1
      esams: &id009
        testlb: 185.15.59.225
        testlb6: 2a02:ec80:300:ed1a::2
        textlb: 185.15.59.224
        textlb6: 2a02:ec80:300:ed1a::1
      ulsfo: &id010
        testlb: 198.35.26.97
        testlb6: 2620:0:863:ed1a::2
        textlb: 198.35.26.96
        textlb6: 2620:0:863:ed1a::1
      drmrs: &id016
        testlb: 185.15.58.225
        testlb6: 2a02:ec80:600:ed1a::2
        textlb: 185.15.58.224
        textlb6: 2a02:ec80:600:ed1a::1
      magru: &id018 # next site should be 20
        testlb: 195.200.68.225
        testlb6: 2a02:ec80:700:ed1a::2
        textlb: 195.200.68.224
        textlb6: 2a02:ec80:700:ed1a::1
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: cdn
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    probes:
      - type: http
        host: en.wikipedia.org
        path: /wiki/Special:BlankPage
        expect_redirect: true
    port: 80
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  text-https:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (nginx)
    encryption: true
    ip:
      codfw: *id006
      eqiad: *id007
      eqsin: *id008
      esams: *id009
      ulsfo: *id010
      drmrs: *id016
      magru: *id018
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: cdn
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    probes:
      - type: http
        host: en.wikipedia.org
        path: /wiki/Special:BlankPage
    port: 443
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  thumbor:
    description: Thumbor image scaling
    encryption: false
    ip:
      codfw:
        default: 10.2.1.24
      eqiad:
        default: 10.2.2.24
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          timeout: 10
          url:
            - http://localhost/healthz
      scheduler: wrr
    probes:
      - type: http
        path: /healthcheck
        timeout: 15s # max value, cannot be higher than Prometheus' scrape_interval (15s)
    port: 8800
    sites:
      - eqiad
      - codfw
    state: production

  toolhub:
    description: Toolhub, toolhub.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.62
      eqiad:
        default: 10.2.2.62
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 4011
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: toolhub
        active_active: false

  upload:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: false
    ip:
      codfw: &id011
        uploadlb: 208.80.153.240
        uploadlb6: 2620:0:860:ed1a::2:b
      eqiad: &id012
        uploadlb: 208.80.154.240
        uploadlb6: 2620:0:861:ed1a::2:b
      eqsin: &id013
        uploadlb: 103.102.166.240
        uploadlb6: 2001:df2:e500:ed1a::2:b
      esams: &id014
        uploadlb: 185.15.59.240
        uploadlb6: 2a02:ec80:300:ed1a::2:b
      ulsfo: &id015
        uploadlb: 198.35.26.112
        uploadlb6: 2620:0:863:ed1a::2:b
      drmrs: &id017
        uploadlb: 185.15.58.240
        uploadlb6: 2a02:ec80:600:ed1a::2:b
      magru: &id019 # next site should be 21
        uploadlb: 195.200.68.240
        uploadlb6: 2a02:ec80:700:ed1a::2:b
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: cdn
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    probes:
      - type: http
        host: upload.wikimedia.org
        path: /monitoring/backend
        expect_redirect: true
    port: 80
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  upload-https:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: true
    ip:
      codfw: *id011
      eqiad: *id012
      eqsin: *id013
      esams: *id014
      ulsfo: *id015
      drmrs: *id017
      magru: *id019 # next site should be 21
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: cdn
      depool_threshold: ".66"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: mh
      ipip_encapsulation:
        - eqiad
        - codfw
        - esams
        - ulsfo
        - eqsin
        - drmrs
        - magru
    probes:
      - type: http
        host: upload.wikimedia.org
        path: /monitoring/backend
    port: 443
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
      - drmrs
      - magru
    state: production

  videoscaler:
    description: Videoscaler LVS interface (https). videoscaler.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.5
      eqiad:
        default: 10.2.2.5
    lvs:
      class: low-traffic
      conftool:
        cluster: videoscaler
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /w/health-check.php
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: videoscaler
        active_active: false

  wcqs:
    description: Wikimedia Commons Query Service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.67
      eqiad:
        default: 10.2.2.67
    lvs:
      class: low-traffic
      conftool:
        cluster: wcqs
        service: wcqs
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/readiness-probe
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /readiness-probe
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wcqs
        active_active: true

  wdqs:
    description: Wikidata Query Service
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    page: false
    port: 80
    sites:
      - eqiad
      - codfw
    state: production

  wdqs-heavy-queries:
    description: Wikidata Query Service for heavy queries
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-heavy-queries
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    page: false
    port: 8888
    sites:
      - eqiad
      - codfw
    state: production

  wdqs-internal:
    description: Wikidata Query Service - internal
    encryption: false
    ip:
      codfw:
        default: 10.2.1.41
      eqiad:
        default: 10.2.2.41
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs-internal
        service: wdqs
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    probes:
      - type: http
        path: /readiness-probe
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs-internal
        active_active: true

  wdqs-ssl:
    description: Wikidata Query Service - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/readiness-probe
      scheduler: wrr
    page: false
    probes:
      - type: http
        path: /readiness-probe
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs
        active_active: true

  wikifeeds:
    description: A node webservice supporting featured wiki content feeds. wikifeeds.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.47
      eqiad:
        default: 10.2.2.47
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        path: /_info
      - type: swagger
    port: 4101
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wikifeeds
        active_active: true

  zotero:
    description: Zotero, zotero.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.16
      eqiad:
        default: 10.2.2.16
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    probes:
      - type: http
        post_json: '[{"itemType":"journalArticle"}]'
        path: /export?format=wikipedia
    port: 4969
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: zotero
        active_active: true

  # Chartmuseum is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  helm-charts:
    description: helm-charts
    encryption: true
    ip:
      codfw:
        default: 10.192.48.159
      eqiad:
        default: 10.64.48.26
    page: false
    probes:
      - type: http
        path: /health
        must_contain_regexp: '"healthy".*:.*true'
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: helm-charts
        active_active: true

  # Releases is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  releases:
    description: MediaWiki, Parsoid, MobileApps and other Wikimedia release files (https://releases.wikimedia.org)
    encryption: true
    ip:
      codfw:
        default: 10.192.16.72
      eqiad:
        default: 10.64.48.34
    page: false
    probes:
      - type: http
        path: /mediawiki
        host: releases.wikimedia.org
        must_contain_regexp: MediaWiki
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: releases
        active_active: true

  api-gateway:
    description: API gateway, api-gateway.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.55
      eqiad:
        default: 10.2.2.55
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 8087
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: api-gateway
        active_active: true

  linkrecommendation:
    description: Link Recommendation, linkrecommendation.discovery.wmnet
    encryption: true
    ip: &linkrecommendation_ips
      codfw:
        default: 10.2.1.23
      eqiad:
        default: 10.2.2.23
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 4005
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true

  linkrecommendation-external:
    description: Link Recommendation, public release, linkrecommendation.discovery.wmnet
    encryption: true
    ip: *linkrecommendation_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 4006
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true
    aliases:
      - linkrecommendation

  # puppetdb-api is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  puppetdb-api:
    description: Puppetdb api microservice
    encryption: true
    ip:
      codfw:
        default: 10.192.48.75
      eqiad:
        default: 10.64.16.87
    page: false
    probes:
      - type: http
    sites:
      - eqiad
      - codfw
    port: 8090
    state: production
    discovery:
      - dnsdisc: puppetdb-api
        active_active: true
        #
  # Observability services (non-lvs)
  alertmanager:
    encryption: true
    role: "alerting_host"
    public_endpoint: "alerts"
    port: 443
    description: Alertmanager service
    # No 'monitoring' section, covered by metamonitoring.
    # Also icinga doesn't know about the "other site" alerting host.
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 208.80.153.84
      eqiad:
        default: 208.80.154.88
    state: production

  graphite:
    encryption: true
    role: "graphite::production"
    public_endpoint: "graphite"
    port: 443
    description: Graphite metrics platform
    page: false
    probes:
      - type: http
        host: graphite.wikimedia.org
        expect_sso: true
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 10.192.16.37 # graphite2004
      eqiad:
        default: 10.64.16.81 # graphite1005
    state: production

  grafana:
    encryption: true
    role: "grafana"
    public_endpoint: "grafana"
    public_aliases:
      - "grafana-rw"
      - "grafana-next"
      - "grafana-next-rw"
    port: 443
    description: Graphing and dashboarding
    page: false
    probes:
      - type: http
        host: grafana.wikimedia.org
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 10.192.0.160
      eqiad:
        default: 10.64.0.119
    state: production

  librenms:
    encryption: true
    role: "netmon"
    public_endpoint: "librenms"
    port: 443
    description: Network device observability
    page: false
    probes:
      - type: http
        host: librenms.wikimedia.org
        expect_sso: true
    sites:
      - codfw
      - eqiad
    ip:
      codfw:
        default: 208.80.153.9
      eqiad:
        default: 208.80.154.141
    state: production

  # This service points to an Istio Ingress Gateway,
  # that acts as L7 load balancer. It monitors backends
  # by itself, and by default it exposes a separate port
  # to check the status of its pods (not the backend services).
  # Pybal doesn't support health checks on different ports than
  # the service one. To keep this simple, we are not adding any
  # L7 check for LVS, but we are simply relying on checking that
  # a TCP conn can be established. This may change in the future
  # as we get more experience with Istio.
  inference:
    description: Inference ML service
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.63
      codfw:
        default: 10.2.1.63
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: http
        valid_status_codes:
          - 404
    port: 30443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: inference
        active_active: true

  inference-staging:
    description: Inference ML service (staging)
    encryption: true
    ip:
      codfw:
        default: 10.2.1.58
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_staging
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    page: false
    probes:
      - type: tcp-notls
    port: 30443
    sites:
      - codfw
    state: lvs_setup

  # apt is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  apt:
    description: Internal apt package repository
    encryption: false
    ip:
      codfw:
        default: 208.80.153.11
      eqiad:
        default: 208.80.154.10
    page: false
    probes:
      - type: http
        host: apt.wikimedia.org
        path: /wikimedia/
    sites:
      - eqiad
      - codfw
    port: 80
    state: production
    discovery:
      - dnsdisc: apt
        active_active: false

  # puppetboard is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  puppetboard:
    description: Internal production Puppetboard interface
    encryption: true
    ip:
      codfw:
        default: 10.192.0.8
      eqiad:
        default: 10.64.32.38
    page: false
    probes:
      - type: http
        host: puppetboard.wikimedia.org
        expect_sso: true
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    discovery:
      - dnsdisc: puppetboard
        active_active: true

  image-suggestion:
    description: image suggestion service, image-suggestion.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  data-gateway:
    description: data gateway service, data-gateway.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  developer-portal:
    description: Static documentation site, developer-portal.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  # Netbox is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  netbox:
    description: Netbox Frontend
    encryption: true
    ip:
      codfw:
        default: 10.192.0.96
      eqiad:
        default: 10.64.0.186
    page: true
    probes:
      - type: http
        host: netbox.wikimedia.org
        expect_sso: true
    sites:
      - eqiad
      - codfw
    port: 443
    state: production
    page: false
    discovery:
      - dnsdisc: netbox
        active_active: false

  logs-api:
    description: API access to opensearch for logs
    encryption: true
    ip:
      codfw:
        default: 10.2.1.79
      eqiad:
        default: 10.2.2.79
    lvs:
      class: low-traffic
      conftool:
        cluster: kibana7
        service: logs-api
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://logs-api.svc.eqiad.wmnet
      scheduler: mh
    probes:
      - type: http
        # The 'host' here can be handled by codfw and eqiad all the same
        host: logs-api.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production

  commons-impact-analytics:
    description: commons-impact-analytics AQS2 service, commons-impact-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  device-analytics:
    description: device-analytics AQS2 service, device-analytics.discovery.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.80
      eqiad:
        default: 10.2.2.80
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 4972
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: device-analytics
        active_active: true

  geo-analytics:
    description: geo-analytics AQS2 service, geo-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  media-analytics:
    description: media-analytics AQS2 service, media-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  page-analytics:
    description: page-analytics AQS2 service, page-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  editor-analytics:
    description: editor-analytics AQS2 service, editor-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  edit-analytics:
    description: edit-analytics AQS2 service, edit-analytics.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    port: *k8s-ingress-wikikube_port
    probes:
      - type: http
        path: /healthz
    sites:
      - eqiad
      - codfw
    state: production

  # Services has no LVS
  pki:
    description: PKI service
    # This service does have encryption with mutual auth.
    # however the probe is over http (T332149)
    encryption: false
    ip:
      codfw:
        # pki2002
        default: 10.192.16.172
      eqiad:
        # pki1001
        default: 10.64.0.10
    probes:
      - type: http
        path: /metrics
        must_contain_regexp: 'signer="discovery"'
    sites:
      - eqiad
      - codfw
    # This service uses 443. however the probe is over port 80 (T332149)
    port: 80
    state: production
    page: false
    discovery:
      - dnsdisc: pki
        active_active: true

  rest-gateway:
    description: REST API gateway, rest-gateway.discovery.wmnet. See REST Gateway page on wikitech for URLs proxied
    encryption: true
    ip:
      codfw:
        default: 10.2.1.82
      eqiad:
        default: 10.2.2.82
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    page: false
    probes:
      - type: http
        path: /healthz
    port: 4113
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: rest-gateway
        active_active: true

  machinetranslation:
    description: MinT, machinetranslation service backend. Use by cxserver.
      machinetranslation.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
        path: /healthz
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  wikifunctions:
    description: Wikifunctions orchestrator, wikifunctions.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
        path: /_info
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  config-master:
    description: config-master.wikimedia.org service for browsing configuration data from etcd.
    encryption: true
    ip:
      codfw:
        default: 10.192.0.15
      eqiad:
        default: 10.64.0.110
    page: false
    probes:
      - type: http
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: config-master
        active_active: true

  ipoid:
    description: iPoid IP address reputation service ipoid.discovery.wmnet
    encryption: true
    ip: *k8s-ingress-wikikube_ips
    page: false
    probes:
      - type: http
        path: /_info
    port: *k8s-ingress-wikikube_port
    sites:
      - eqiad
      - codfw
    state: production

  superset-next:
    description: Staging superset service, superset-next.wikimedia.org
    encryption: true
    ip: *k8s-ingress-dse_ips
    page: false
    probes:
      - type: http
        path: /health
    port: *k8s-ingress-dse_port
    sites:
      - eqiad
    state: production

  superset:
    description: Production superset service, superset.wikimedia.org
    encryption: true
    ip: *k8s-ingress-dse_ips
    page: false
    probes:
      - type: http
        path: /health
    port: *k8s-ingress-dse_port
    sites:
      - eqiad
    state: production

  mpic:
    description: Production mpic service, mpic.wikimedia.org
    encryption: true
    ip: *k8s-ingress-dse_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-dse_port
    sites:
      - eqiad
    state: service_setup

  mpic-next:
    description: Staging mpic service, mpic-next.wikimedia.org
    encryption: true
    ip: *k8s-ingress-dse_ips
    page: false
    probes:
      - type: http
    port: *k8s-ingress-dse_port
    sites:
      - eqiad
    state: service_setup
