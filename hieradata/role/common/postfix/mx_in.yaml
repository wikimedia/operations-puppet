profile::puppet::agent::force_puppet7: true
profile::base::production::role_description: 'Postfix inbound email server'
# Disable the use of our default exim config
profile::mail::default_mail_relay::enabled: false
profile::contacts::role_contacts: ['Infrastructure Foundations']
profile::postfix::mx::mta_mode: 'inbound'

profile::postfix::mx::domain_aliases_generic:
  - 'mediawiki.org'
  - 'w.wiki'
  - 'wikibooks.org'
  - 'wikidata.org'
  - 'wikinews.org'
  - 'wikiquote.org'
  - 'wikisource.org'
  - 'wikispecies.org'
  - 'wikiversity.org'
  - 'wikivoyage.de'
  - 'wiktionary.org'

profile::postfix::mx::static_transport_maps:
  wiki-verp-bounce-handler:
    type: 'regexp'
    content: |
      # Match MediaWiki VERP bounces and forward them to the bounce handler api
      /wiki-[a-z0-9_.]+-[a-z0-9]+-[a-z0-9]+-[a-z0-9+\/=]+@wikimedia.org/	wiki-verp-bounce-handler
  donate:
    type: 'hash'
    content: |
      # Forward fundraising contacts to civicrm
      donate.wikimedia.org	smtp:civi1002.frack.eqiad.wmnet
      civicrm.wikimedia.org	smtp:civi1002.frack.eqiad.wmnet
  phabricator:
    type: 'hash'
    content: |
      # Forward phabricator.wikimedia.org mail to phabricator server
      phabricator.wikimedia.org smtp:phabricator.discovery.wmnet
  gmail:
    type: 'hash'
    content: |
      # Forward wikimedia.org mail to Gmail
      wikimedia.org smtp:aspmx.l.google.com

# Config for script to send wikipedia.org mail aliases to ITS for review
profile::postfix::mx::mail_aliases:
  path: '/etc/postfix/aliases/virtual-wikipedia.org'
  rcpt: 'its@wikimedia.org'
  subject: 'wikimedia.org mail aliases'

# Config for enabling VERP for wikimedia bounces
profile::postfix::mx::verp_cfg:
  post_connect_server: meta.wikimedia.org
  bounce_post_url: https://api-rw.discovery.wmnet/w/api.php

# Generated by profile::mail::vrts
profile::postfix::mx::dynamic_transport_maps:
  vrt:
    type: 'hash'
    path: '/var/lib/postfix/transport-vrt'

profile::mail::vrts::gmail_host: aspmx.l.google.com
profile::mail::vrts::aliases_file: /var/lib/postfix/transport-vrt
profile::mail::vrts::aliases_format: postfix
profile::mail::vrts::aliases_folder: /etc/postfix/aliases
profile::mail::vrts::mysql_dbname: otrs
profile::mail::vrts::mysql_host: m2-master.eqiad.wmnet
profile::mail::vrts::mysql_user: exim
profile::mail::vrts::next_hop: smtp:ticket.discovery.wmnet

profile::postfix::mx::verp_config:
  post_connect_server: meta.wikimedia.org
  bounce_post_url: https://api-rw.discovery.wmnet/w/api.php
profile::postfix::mx::config:
  relay_domains: &relay_domains
    # source, puppet:///modules/role/exim/wikimedia_domains
    # top-level project domains
    - mediawiki.org
    - wikibooks.org
    - wikidata.org
    - wikifunctions.org
    - wikimediafoundation.org
    - wikinews.org
    - wikimedia.org
    - wikipedia.org
    - wikiquote.org
    - wikisource.org
    - wikispecies.org
    - wikiversity.org
    - wikivoyage.org
    - wiktionary.org
    - wmflabs.org
    - wmcloud.org
    - w.wiki
    # wikivoyage.de -> WMF migration; aliases
    - wikivoyage.de
    # Domains handled by VRT
    - wikilovesmonuments.be
    - wikilovesmonuments.cat
    - wikilovesmonuments.eu
    - wikilovesmonuments.nl
    - wikilovesmonuments.org
    - wikimedia.community
    - wikimedia.com
    - wikipedia.com
    # routed by special-case routers
    - donate.wikimedia.org
    - civicrm.wikimedia.org
    - rt.wikimedia.org
    - phabricator.wikimedia.org
    - benefactors.wikimedia.org
    # pr.wikimedia.org outbound mail is delegated to MuckRack (https://muckrack.com)
    # with inbound mail handled via aliases - T231387
    - pr.wikimedia.org
  # Re-use the vrt transport map as a list of valid vrt recipients
  relay_recipient_maps: [ 'hash:/var/lib/postfix/transport-vrt' ]
profile::mail::vrts::wikimedia_domains: *relay_domains
profile::postfix::mx::verify_domains:
    - wikimedia.org
profile::postfix::mx::unverifiable_domains:
    - donate.wikimedia.org
    - civicrm.wikimedia.org
    - phabricator.wikimedia.org
