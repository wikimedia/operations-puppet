profile::puppet::agent::force_puppet7: true
# Needed for puppet 7 hosts
acmechief_host: acmechief2002.codfw.wmnet
profile::base::production::role_description: 'Postfix inbound email server'
# Disable the use of our default exim config
profile::mail::default_mail_relay::enabled: false
profile::contacts::role_contacts: ['Infrastructure Foundations']
profile::postfix::mx::mta_mode: 'inbound'

profile::postfix::mx::domain_aliases_generic:
  - 'mediawiki.org'
  - 'w.wiki'
  - 'wikibooks.org'
  - 'wikidata.org'
  - 'wikinews.org'
  - 'wikiquote.org'
  - 'wikisource.org'
  - 'wikispecies.org'
  - 'wikiversity.org'
  - 'wikivoyage.de'
  - 'wiktionary.org'

profile::postfix::mx::static_transport_maps:
  wiki-verp-bounce-handler:
    type: 'regexp'
    content: |
      # Match MediaWiki VERP bounces and forward them to the bounce handler api
      /wiki-[a-z0-9_.]+-[a-z0-9]+-[a-z0-9]+-[a-z0-9+\/=]+@wikimedia.org/	wiki-verp-bounce-handler
  donate:
    type: 'hash'
    content: |
      # Forward fundraising contacts to civicrm
      donate.wikimedia.org	smtp:civi1001.frack.eqiad.wmnet
      civicrm.wikimedia.org	smtp:civi1001.frack.eqiad.wmnet
  phabricator:
    type: 'hash'
    content: |
      # Forward phabricator.wikimedia.org mail to phabricator server
      phabricator.wikimedia.org smtp:phabricator.discovery.wmnet
  gmail:
    type: 'hash'
    content: |
      # Forward wikimedia.org mail to Gmail
      wikimedia.org smtp:aspmx.l.google.com

# Config for script to send wikipedia.org mail aliases to ITS for review
profile::postfix::mx::mail_aliases:
  path: '/etc/postfix/virtual-wikipedia.org'
  rcpt: 'its@wikimedia.org'
  subject: 'wikimedia.org mail aliases'

# Config for enabling VERP for wikimedia bounces
profile::postfix::mx::verp_cfg:
  post_connect_server: meta.wikimedia.org
  bounce_post_url: https://api-rw.discovery.wmnet/w/api.php

# Generated by profile::mail::vrts
profile::postfix::mx::dynamic_transport_maps:
  vrt:
    type: 'hash'
    path: '/var/lib/postfix/transport-vrt'

profile::mail::vrts::gmail_host: aspmx.l.google.com
profile::mail::vrts::aliases_file: /var/lib/postfix/transport-vrt
profile::mail::vrts::aliases_format: postfix
profile::mail::vrts::aliases_folder: /etc/postfix/aliases
profile::mail::vrts::mysql_dbname: otrs
profile::mail::vrts::mysql_host: m2-master.eqiad.wmnet
profile::mail::vrts::mysql_user: exim
